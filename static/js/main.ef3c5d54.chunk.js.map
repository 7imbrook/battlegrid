{"version":3,"sources":["../node_modules/peerjs/dist sync","storage/session.ts","modules/game/units.ts","modules/game/index.ts","modules/players.ts","modules/toast.ts","modules/comms/peer.ts","modules/comms/client2.ts","modules/comms/server.ts","modules/comms/index.ts","modules/sync.ts","components/grid2/DropLayer.tsx","components/util/useDrop.ts","components/grid2/GridItem.tsx","components/grid2/Overlay.tsx","components/grid2/SelectionBox.tsx","components/util/usePinch.ts","components/grid2/Viewport.tsx","components/grid2/Grid.tsx","components/JoinOverlay.tsx","components/toasts/ToastArea.tsx","components/toolkit/Loading.tsx","components/toolbar/Players.tsx","components/toolbar/Toolbar.tsx","components/App.tsx","i18n.ts","store.ts","modules/game/persist.ts","index.tsx"],"names":["webpackEmptyContext","req","e","Error","code","keys","resolve","module","exports","id","defaults","was_hosting","comms_id","uuid","players","Session","key","item","sessionStorage","getItem","JSON","parse","def","setItem","stringify","v","coord","ev","clientX","clientY","add","a","b","sub","initialState","maps","width","height","images","game","createSlice","name","reducers","forkGame","state","action","payload","loadGame","setDimensions","shared","map","addImage","img","updateImage","moveImage","offset","loc","reset","actions","online","data","playerJoined","push","removePlayer","filter","p","changeName","player","sleep","m","Promise","r","setTimeout","issueToast","createAsyncThunk","msg","dispatch","Date","now","addToast","removeToast","toast","toasts","t","process","REACT_APP_PEERJS_HOST","REACT_APP_PEERJS_PORT","create_peer","console","log","peer","Peer","debug","host","secure","port","parseInt","undefined","path","reject","on_error","cleanup","on_open","off","on","connect_peer","metadata","dc","connect","game_client","client_id","handlers","connect_data","data_conn","onConnect","keep_trying","on_first_message","d","onMessage","onInitialMessage","onDisconnect","send","f","timeout","game_server","server_id","clients","Map","broadcast","exclude","label","c","conn","set","delete","onStartup","sendTo","get","gameId","getState","clientId","comms","disconnected","connected","_","server","type","window","history","pushState","status","hosting","extraReducers","builder","addCase","pending","fulfilled","rejected","reducer","prepare","meta","src","getDataURL","file","reader","FileReader","onload","result","readAsDataURL","extractURLFromHTML","html","DOMParser","parseFromString","querySelector","DropLayer","props","useRef","gridDrag","hoverHint","useDispatch","grid","useContext","GridContext","ref","onDrag","onDrop","useState","dragDepth","setDragDepth","x","y","dragState","setDragState","onDragEnter","preventDefault","stopPropagation","onDragLeave","onDragOver","useDrop","dropLayer","current","coords","client_to_grid","style","left","Math","floor","top","dataItems","dataTransfer","items","addItem","s","random","dim","href","length","i","startsWith","getAsFile","dataURL","getAsString","kind","dragging","drag","dragHandlers","position","right","bottom","background","children","GridItem","memo","forwardRef","div","initial","transition","ease","duration","animate","React","viewBox","pointerEvents","patternUnits","shapeRendering","fill","stroke","strokeWidth","thickness","onSelectionDrag","onSelectionDrop","initialLoc","onPointerMove","useCallback","isPrimary","buttons","target","setPointerCapture","pointerId","onPointerUp","itemRef","useEffect","addEventListener","passive","useLayoutEffect","capture","removeEventListener","border","boxShadow","overflow","className","cursor","boxSizing","calcState","touches","touch1","touch2","found","identifier","found2","diff","abs","dist","center","n","inch","px","Viewport","viewport","translater","scaler","v_loc","scale","v_dim","c_dim","manualRender","max","transform","fontSize","performZoom2","grid_pos","proposed_delta","new_scale","min","delta","scrollLeft","scrollTop","scrollTo","vx","vy","useImperativeHandle","clientToGrid","onWheel","ctrlKey","grid_loc","deltaY","prevDefault","prev_scale","origin","originalDist","onTouchStart","touch","onPinchStart","clientOrigin","onTouchMove","onPinch","onTouchEnd","count","opts","target_curr","usePinch","rect","getBoundingClientRect","size_recorder","dest","ResizeObserver","entries","pop","contentRect","v_observer","observe","c_observer","disconnect","touchAction","transformOrigin","overlay","createContext","useSelector","selectionOffset","setSelectionOffset","selection","setSelection","selection_loc","useMemo","val","dimensions","onKeyPress","resource","document","Provider","value","Object","values","includes","tabIndex","onFocus","onBlur","onDragStart","alt","display","JoinOverlay","shouldRender","joinAsPlayer","FormData","nativeEvent","flexDirection","maxWidth","onSubmit","htmlFor","defaultValue","ToastArea","useTranslation","opacity","exit","layout","Loading","Players","store","expanded","set_expanded","handler","onClick","borderBottomLeftRadius","borderBottomRightRadius","borderBottom","verticalAlign","borderLeft","borderRight","borderTop","borderTopRightRadius","borderTopLeftRadius","padding","navigator","clipboard","writeText","location","Toolbar","App","curr_map","i18n","use","Backend","initReactI18next","init","lng","fallbackLng","whitelist","interpolation","escapeValue","backend","loadPath","mainReducer","combineReducers","configureStore","applySync","middleware","prepend","api","next","preloadedState","subscribe","persistState","URLSearchParams","search","gameState","ReactDOM","render","StrictMode","fallback","getElementById"],"mappings":"8HAAA,SAASA,EAAoBC,GAC5B,IAAIC,EAAI,IAAIC,MAAM,uBAAyBF,EAAM,KAEjD,MADAC,EAAEE,KAAO,mBACHF,EAEPF,EAAoBK,KAAO,WAAa,MAAO,IAC/CL,EAAoBM,QAAUN,EAC9BO,EAAOC,QAAUR,EACjBA,EAAoBS,GAAK,I,mRCHnBC,EAAW,CAEfC,YAAa,kBAAM,MAEnBC,S,MAAUC,EAEVC,QAAS,iBAAO,KAILC,EAAU,SACWC,GAC9B,IAAMC,EAAOC,eAAeC,QAAQH,GACpC,GAAIC,EACF,OAAOG,KAAKC,MAAMJ,GAGpB,IAAMK,EAAMZ,EAASM,KAErB,OADAE,eAAeK,QAAQP,EAAKI,KAAKI,UAAUF,IACpCA,GATEP,EAAU,SAYWC,EAAQS,GACtCP,eAAeK,QAAQP,EAAKI,KAAKI,UAAUC,K,OCjBxC,SAASC,EAAMC,GAIpB,MAAO,CAACA,EAAGC,QAASD,EAAGE,SAalB,SAASC,EACdC,EACAC,GAEA,MAAO,CAACD,EAAE,GAAKC,EAAE,GAAID,EAAE,GAAKC,EAAE,IAMzB,SAASC,EACdF,EACAC,GAEA,MAAO,CAACD,EAAE,GAAKC,EAAE,GAAID,EAAE,GAAKC,EAAE,IC/BhC,IAAIE,EAAe,CACjBzB,GAAI,QACJ0B,KAAM,CACJ,CACEC,MAAO,GACPC,OAAQ,GACRC,OAAQ,MAIHC,EAAOC,YAAY,CAC5BC,KAAM,OACNP,aAAcA,EACdQ,SAAU,CACRC,SADQ,SACCC,EAAOC,GACdD,EAAMnC,GAAKoC,EAAOC,SAEpBC,SAJQ,SAICH,EAJD,GAKN,OADmD,EAAnCE,SAGlBE,cAAeC,IACb,SACEL,EADF,GAGM,IADFE,EACC,EADDA,QAEMI,EAAuBJ,EAAvBI,IAAKd,EAAkBU,EAAlBV,MAAOC,EAAWS,EAAXT,OACpBO,EAAMT,KAAKe,GAAKd,MAAQA,EACxBQ,EAAMT,KAAKe,GAAKb,OAASA,KAG7Bc,SAAUF,IACR,SAACL,EAAYC,GAAsD,IAAD,EAC3CA,EAAOC,QAApBI,EADwD,EACxDA,IAAKE,EADmD,EACnDA,IACbR,EAAMT,KAAKe,GAAKZ,OAAOc,EAAI3C,IAAM2C,KAGrCC,YAAaJ,IACX,SACEL,EACAC,GACI,IAAD,EACsBA,EAAOC,QAAxBI,EADL,EACKA,IAAKzC,EADV,EACUA,GAAI2C,EADd,EACcA,IACjBR,EAAMT,KAAKe,GAAKZ,OAAO7B,GAAvB,2BAAkCmC,EAAMT,KAAKe,GAAKZ,OAAO7B,IAAQ2C,MAGrEE,UAAWL,IACT,SACEL,EACAC,GAKI,IAAD,EACyBA,EAAOC,QAA3BI,EADL,EACKA,IAAKzC,EADV,EACUA,GAAI8C,EADd,EACcA,OACjBX,EAAMT,KAAKe,GAAKZ,OAAO7B,GAAI+C,IAAM1B,EAC/Bc,EAAMT,KAAKe,GAAKZ,OAAO7B,GAAI+C,IAC3BD,MAINE,MAAOR,IACL,SAACL,EAAYC,GAAb,OAAmDX,QAK1CK,IAAf,Q,EASIA,EAAKmB,QAPPV,E,EAAAA,cACAG,E,EAAAA,SACAE,E,EAAAA,YACAI,E,EAAAA,MACAV,E,EAAAA,SACAJ,E,EAAAA,SACAW,E,EAAAA,UC9EIpB,EAAe,CACnByB,OAAQ,GACRC,KAAM7C,EAAY,YAGPD,EAAU0B,YAAY,CACjCC,KAAM,UACNP,eACAQ,SAAU,CACRmB,aAAcZ,IACZ,SAACL,EAAqBC,GACpBD,EAAMe,OAAOG,KAAKjB,EAAOC,SACzBF,EAAMgB,KAAKf,EAAOC,SAAWF,EAAMgB,KAAKf,EAAOC,UAAY,CACzDL,KAAM,SAIZsB,aAAcd,IACZ,SAACL,EAAqBC,GACpBD,EAAMe,OAASf,EAAMe,OAAOK,QAAO,SAACC,GAAD,OAAOA,IAAMpB,EAAOC,cAG3DoB,WAAYjB,IACV,SACEL,EACAC,GAEAD,EAAMgB,KAAKf,EAAOC,QAAQqB,QAAQ1B,KAAOI,EAAOC,QAAQL,WAMjD3B,IAAf,Q,EAC0DA,EAAQ4C,QAAnDG,E,EAAAA,aAAcE,E,EAAAA,aAAcG,E,EAAAA,WCxC3C,IAAME,EAAQ,SAACC,GAAD,OAAe,IAAIC,SAAQ,SAACC,GAAD,OAAOC,WAAWD,EAAGF,OACjDI,EAAaC,YACxB,cADwC,uCAExC,WAAOC,EAAP,oBAAA5C,EAAA,6DAAsB6C,EAAtB,EAAsBA,SACdnE,EAAKoE,KAAKC,MAChBF,EAASG,EAAS,CAAEtE,GAAIoE,KAAKC,MAAOH,SAFtC,SAGQP,EAAM,KAHd,OAIEQ,EAASI,EAAYvE,IAJvB,2CAFwC,yDAU7BwE,EAAQzC,YAAY,CAC/BC,KAAM,QACNP,aAAc,CACZgD,OAAQ,IAEVxC,SAAU,CACRqC,SADQ,SACCnC,EADD,GACgE,IAAtDE,EAAqD,EAArDA,QAChBF,EAAMsC,OAAOpB,KAAKhB,IAEpBkC,YAJQ,SAIIpC,EAJJ,GAI8C,IAAjCE,EAAgC,EAAhCA,QACnBF,EAAMsC,OAAStC,EAAMsC,OAAOlB,QAAO,SAACmB,GAAD,OAAOA,EAAE1E,KAAOqC,SAK1CmC,IAAf,Q,EACyCA,EAAMvB,QAAhCqB,E,EAAAA,SAAUC,E,EAAAA,Y,mBC5B8BI,kNAAjDC,E,EAAAA,sBAAuBC,E,EAAAA,sBAEtB,SAAeC,EAAtB,kC,4CAAO,WAA2B9E,GAA3B,eAAAsB,EAAA,6DACLyD,QAAQC,IAAI,QAASL,mNACjBM,EAAO,IAAIC,IAAKlF,EAAI,CACtBmF,MAAO,EACPC,KAAMR,EACNS,QAAQ,EACRC,KAAMT,EAAwBU,SAASV,QAAyBW,EAChEC,KAAM,MAPH,kBASE,IAAI5B,SAAQ,SAAChE,EAAS6F,GAC3B,IAAIC,EAAW,SAAClG,GACdmG,IACAF,EAAO,4BAAD,OAA6BjG,KAEjCoG,EAAU,WACZD,IACAb,QAAQC,IAAI,YACZnF,EAAQoF,IAENW,EAAU,WACZX,EAAKa,IAAI,OAAQD,GACjBZ,EAAKa,IAAI,QAASH,IAEpBV,EAAKc,GAAG,OAAQF,GAChBZ,EAAKc,GAAG,QAASJ,OAxBd,4C,sBA4BA,SAAeK,EAAtB,uC,8CAAO,WACLf,EACAjF,EACAiG,GAHK,eAAA3E,EAAA,6DAKC4E,EAAKjB,EAAKkB,QAAQnG,EAAI,CAAEiG,aALzB,kBAME,IAAIpC,SAAQ,SAAChE,EAAS6F,GAC3B,IAAIC,EAAW,SAAClG,GACdmG,IACAF,EAAO,4BAAD,OAA6BjG,KAEjCoG,EAAU,WACZD,IACA/F,EAAQqG,IAENN,EAAU,WACZM,EAAGJ,IAAI,OAAQD,GACfK,EAAGJ,IAAI,QAASH,IAElBO,EAAGH,GAAG,OAAQF,GACdK,EAAGH,GAAG,QAASJ,OApBZ,4C,sBCpBA,SAAeS,GAAtB,uC,8CAAO,WACLtE,EACAuE,EACAC,GAHK,QASUC,EATV,WAAAjF,EAAA,iGAAAA,EAAA,MASL,sBAAAA,EAAA,sEACoB0E,EAAaf,EAAMnD,EAAgB,CAAEuE,cADzD,cACEG,EADF,OAEEzC,YAAW,kBAAMuC,EAASG,cAAa,GAFzC,kBAGS,IAAI5C,SAAQ,SAAChE,EAAS6F,GAC3Bc,EAAUT,GAAG,SAAS,WACpBW,GAAYH,EAAc,QAE5BC,EAAUT,GAAG,SAAS,WACpBW,GAAYH,EAAc,QAS5BC,EAAUT,GAAG,QANY,SAAnBY,EAAoBC,GACxBJ,EAAUV,IAAI,OAAQa,GACtBH,EAAUT,GAAG,OAAQO,EAASO,WAC9BP,EAASQ,iBAAiBF,GAC1B/G,EAAQ+G,MAIVJ,EAAUT,GAAG,SAAS,kBAAMO,EAASS,kBACrCP,EAAUT,GAAG,SAAS,kBAAMO,EAASS,sBApBzC,4CATK,uBASUR,EATV,oDAOYzB,IAPZ,cAODG,EAPC,gBAiCCsB,IAjCD,gCAkCE,CACLvG,GAAIqG,EACJW,KAFK,SAEA9C,GACHsC,EAAUQ,KAAK9C,MArCd,4C,sBA2CP,SAASwC,GAAYO,EAAuBC,GAC1CnD,WAAU,sBAAC,sBAAAzC,EAAA,+EAED2F,IAFC,sDAIPP,GAAYO,EAAGC,GAJR,wDAMRA,G,aC7CE,SAAeC,GAAtB,qC,8CAAO,WAA2BC,EAAmBd,GAA9C,mBAAAhF,EAAA,sEACcwD,EAAYsC,GAD1B,cACCnC,EADD,OAECoC,EAAU,IAAIC,IACdC,EAAY,SAACpE,EAAWqE,GAAsB,IAAD,iBAC1BH,GAD0B,IACjD,2BAAgC,CAAC,IAAD,yBAAtBI,EAAsB,KAAfC,EAAe,KAC1BD,IAAUD,GAASE,EAAEV,KAAK7D,IAFiB,gCAMnD8B,EAAKc,GAAG,cAAc,SAAC4B,GAAD,OACpBA,EAAK5B,GAAG,QAAQ,WACd,IAAMM,EAAYsB,EAAK1B,SAASI,UAChCtB,QAAQC,IAAI,aAAcqB,GAC1BgB,EAAQO,IAAIvB,EAAWsB,GAEvBA,EAAK5B,GAAG,QAAQ,SAACa,GACfW,EAAUX,EAAGP,GACbC,EAASO,UAAUD,MAErBe,EAAK5B,GAAG,SAAS,WACfsB,EAAQQ,OAAOxB,GACfC,EAASS,aAAaV,MAExBsB,EAAK5B,GAAG,SAAS,WACfsB,EAAQQ,OAAOxB,GACfC,EAASS,aAAaV,MAGxBC,EAASG,UAAUkB,EAAK1B,SAASI,iBAIrCC,EAASwB,YAhCJ,kBAkCE,CACL9H,GAAIoH,EACJJ,KAAMO,EACNQ,OAHK,SAGEN,EAAevD,GACpBmD,EAAQW,IAAIP,GAAQT,KAAK9C,MAtCxB,4C,sBCNA,IAAI/B,GAAQ,CACjBwF,KAAM,MAOKxB,GAAUlC,YACrB,gBADqC,uCAErC,WAAOgE,EAAP,sBAAA3G,EAAA,6DAAyB4G,EAAzB,EAAyBA,SAAU/D,EAAnC,EAAmCA,SAC3BgE,EAAYD,IAAyBE,MAAMD,SADnD,kBAGuB/B,GAAY6B,EAAQE,EAAU,CAC/CtB,UAD+C,SACrCjD,GACRO,EAASP,IAEXmD,aAJ+C,WAK7C5C,EAASiE,GAAMnF,QAAQoF,iBAEzBvB,iBAP+C,SAO9BlD,GACfO,EAASP,IAEX6C,UAV+C,WAW7CtC,EAASiE,GAAMnF,QAAQqF,gBAd/B,OAGInG,GAAMwF,KAHV,OAiBI5C,QAAQC,IAAI,wBAjBhB,sDAmBIb,EAASH,EAAW,gBACpBe,QAAQC,IAAR,MApBJ,8DAFqC,yDA4B1BI,GAAOnB,YAClB,aADkC,uCAElC,WAAOsE,EAAP,wBAAAjH,EAAA,6DAAuB4G,EAAvB,EAAuBA,SAAU/D,EAAjC,EAAiCA,SACzBgE,EAAYD,IAAyBE,MAAMD,SADnD,SAEuBhB,GAAYgB,EAAU,CACzC1B,UADyC,SAC/B/C,GCjDT,IAAoBvB,EDkDnBqG,EAAOT,OAAOrE,ECjDb,CACL+E,KAAM,aACNpG,QAAS,CACPP,MAJqBK,EDkDc+F,KC9CvBpG,KACZzB,QAAS8B,EAAM9B,WD8Cb8D,EAASf,EAAaM,KAExBmD,UALyC,SAK/BjD,GACRO,EAASP,IAEXmD,aARyC,SAQ5BU,GACXtD,EAASb,EAAamE,KAExBK,UAXyC,WAYvC3D,EAASf,EAAa+E,OAd5B,cAEQK,EAFR,OAkBErG,GAAMwF,KAAOa,EACblI,EAAY,cAAekI,EAAOxI,IAClCmE,EAASjC,EAASsG,EAAOxI,KACzB0I,OAAOC,QAAQC,UAAU,KAAM,GAA/B,gBAA4CJ,EAAOxI,KArBrD,kBAsBSwI,EAAOxI,IAtBhB,4CAFkC,yDA4BzBoI,GAAQrG,YAAY,CAC7BC,KAAM,QACNP,aAAc,CAEZoH,OAAQ,UACRC,SAAS,EACTX,SAAU7H,EAAY,YACtB2H,OAAQ,MAEVhG,SAAU,CACRoG,aADQ,SACKlG,EAAOC,GAClBD,EAAM0G,OAAS,WAEjBP,UAJQ,SAIEnG,EAAOC,GACfD,EAAM0G,OAAS,cAGnBE,cAAe,SAACC,GAEdA,EAAQC,QAAQ9C,GAAQ+C,SAAS,SAAC/G,EAAOoG,GACvCpG,EAAM0G,OAAS,aAEjBG,EAAQC,QAAQ9C,GAAQgD,WAAW,SAAChH,EAAOE,GACzCF,EAAM8F,OAAS5F,EAAQ4F,OACvB9F,EAAM0G,OAAS,eAEjBG,EAAQC,QAAQ9C,GAAQiD,UAAU,SAACjH,EAAOoG,GACxCpG,EAAM0G,OAAS,aAIjBG,EAAQC,QAAQ7D,GAAK8D,SAAS,SAAC/G,EAAOoG,GACpCpG,EAAM0G,OAAS,aAEjBG,EAAQC,QAAQ7D,GAAK+D,WAAW,SAAChH,EAAD,GAAyB,IAAfE,EAAc,EAAdA,QACxCF,EAAM0G,OAAS,YACf1G,EAAM8F,OAAS5F,EACfF,EAAM2G,SAAU,KAElBE,EAAQC,QAAQ7D,GAAKgE,UAAU,SAACjH,EAAOoG,GACrCpG,EAAM0G,OAAS,gBAKd,SAASrG,GACdyE,GAKA,MAAO,CACLoC,QAASpC,EACTqC,QAAS,SAAChI,GAAD,MAAQ,CACfe,QAASf,EACTiI,KAAMpH,GAAMwF,KACR,CACEnF,QAAQ,EACRgH,IAAKrH,GAAMwF,KAAK3H,IAElB,MAKKoI,UAAf,Q,eErIeqB,G,iFAAf,WAA0BC,GAA1B,eAAApI,EAAA,6DACQqI,EAAS,IAAIC,WADrB,kBAES,IAAI/F,SAAQ,SAAChE,EAAS6F,GAC3BiE,EAAOE,OAAS,kBAAMhK,EAAQ8J,EAAOG,SACrCH,EAAOI,cAAcL,OAJzB,4C,sBAQA,SAASM,GAAmBC,GAA8B,IAAD,EAGvD,OAAO,WAFQ,IAAIC,WACAC,gBAAgBF,EAAM,aAC9BG,cAAc,cAAlB,eAA0BZ,MAAO,KAInC,SAASa,GAAUC,GACNC,iBAAuB,MAAzC,IAiDIC,EAhDEC,EAAYF,iBAAuB,MACnCpG,EAAWuG,cACXC,EAAOC,qBAAWC,IAJ8B,ECfzC,SACbC,EACAC,EACAC,GAC4B,IAAD,EACKC,mBAAS,GADd,mBACtBC,EADsB,KACXC,EADW,OAEKF,mBAAS,CACvCG,EAAG,EACHC,EAAG,IAJsB,mBAEtBC,EAFsB,KAEXC,EAFW,KA0C3B,MAAO,CACLL,EAAY,EACZI,EACA,CACEE,YA5BgB,SAACtK,GACnBA,EAAGuK,iBACHvK,EAAGwK,kBAFkC,MAGxB,CAACxK,EAAGC,QAASD,EAAGE,SAAxBgK,EAHgC,KAG7BC,EAH6B,KAIrCF,GAAa,SAACvE,GAAD,OAAOA,EAAI,KACxB2E,EAAa,CACXH,IACAC,OAsBAM,YAnBgB,SAACzK,GACnBA,EAAGuK,iBACHvK,EAAGwK,kBAFkC,MAGxB,CAACxK,EAAGC,QAASD,EAAGE,SAAxBgK,EAHgC,KAG7BC,EAH6B,KAIrCF,GAAa,SAACvE,GAAD,OAAOA,EAAI,KACxB2E,EAAa,CACXH,IACAC,OAaAO,WAVe,SAAC1K,GAClBA,EAAGuK,iBACHV,EAAO7J,EAAGC,QAASD,EAAGE,UASpB4J,OA1Ca,SAAC9J,GAChBA,EAAGuK,iBAD+B,MAGrB,CAACvK,EAAGC,QAASD,EAAGE,SAAxBgK,EAH6B,KAG1BC,EAH0B,KAIlCF,EAAa,GACbI,EAAa,CACXH,IACAC,MAEFL,EAAO9J,MDC4B2K,CACnCC,GACA,SAACV,EAAGC,GACF,GAAIZ,EAAUsB,QAAS,CACrB,IAAIC,EAASrB,EAAKsB,eAAe,CAACb,EAAGC,IACrCZ,EAAUsB,QAAQG,MAAMC,KAAOC,KAAKC,MAAML,EAAO,IAAgB,KACjEvB,EAAUsB,QAAQG,MAAMI,IAAMF,KAAKC,MAAML,EAAO,IAAgB,QAN1B,uCAS1C,WAAO9K,GAAP,2BAAAI,EAAA,sDACM0K,EAASrB,EAAKsB,eAAe,CAAC/K,EAAGC,QAASD,EAAGE,UAC7CmL,EAFN,oBAEkBrL,EAAGsL,oBAFrB,aAEkB,EAAiBC,aAFnC,QAE4C,GACtCC,EAAU,SAACC,GACb5H,QAAQC,IAAI2H,GACZ,IAAInM,EAAO,CACTR,GAAI,GAAKoM,KAAKQ,SACd7J,IAAK,CAACqJ,KAAKC,MAAML,EAAO,IAAKI,KAAKC,MAAML,EAAO,KAC/Ca,IAAK,CAAC,EAAG,GACTC,KAAMH,GAERxI,EAASzB,EAAS,CAAED,IAAK,EAAGE,IAAMnC,MAEpCuE,QAAQC,IAAI,YAAauH,EAAUQ,QAC1BC,EAAI,EAdf,YAckBA,EAAIT,EAAUQ,QAdhC,oBAeIhI,QAAQC,IAAIuH,EAAUS,GAAGvE,OACrB8D,EAAUS,GAAGvE,KAAKwE,WAAW,UAhBrC,kCAiB4BxD,GAAW8C,EAAUS,GAAGE,aAjBpD,eAiBYC,EAjBZ,OAkBMT,EAAQS,GAlBd,8BAqB8B,cAAtBZ,EAAUS,GAAGvE,KArBrB,wBAsBM8D,EAAUS,GAAGI,aAAY,SAACT,GAAD,OAAOD,EAAQ1C,GAAmB2C,OAtBjE,8BAyB8B,uCAAtBJ,EAAUS,GAAGvE,KAzBrB,wBA0BM8D,EAAUS,GAAGI,YAAYV,GA1B/B,2BA4BqC,WAAtBH,EAAUS,GAAGK,MAAoB,WAC1C,IAAI3I,EAAI6H,EAAUS,GAAGvE,KACrB8D,EAAUS,GAAGI,aAAY,SAACT,GAAD,OAAO5H,QAAQC,IAAIN,EAAGiI,MAFL,GA5BhD,QAcwCK,IAdxC,2DAT0C,uDANU,mBAMjDM,EANiD,KAMvCC,EANuC,KAMjCC,EANiC,KAuDtD,OAJIF,IACF9C,EAAWG,EAAKsB,eAAe,CAACsB,EAAKnC,EAAGmC,EAAKlC,KAI7C,yCACMmC,EADN,CAEEtB,MAAO,CACLuB,SAAU,WACVtB,KAAM,EACNuB,MAAO,EACPpB,IAAK,EACLqB,OAAQ,KAGTL,EACC,yBACExC,IAAKL,EACLlK,IAAI,QACJ2L,MAAO,CACLuB,SAAU,WACVtB,KAAMC,KAAKC,MAAM7B,EAAU,IAAM,KACjC8B,IAAKF,KAAKC,MAAM7B,EAAU,IAAM,KAChC7I,MAAO,MACPC,OAAQ,MACRgM,WAAY,UAGd,KACHtD,EAAMuD,U,mBEpFAC,GAAWC,eACtBC,sBAAW,SAAC1D,EAAyCQ,GACnD,OACE,kBAAC,KAAOmD,IAAR,iBACO3D,EADP,CAEEQ,IAAKA,EACLoB,MAAK,aACHuB,SAAU,YACPnD,EAAM4B,OAEXgC,SAAS,EACTC,WAAY,CAAE1F,KAAM,QAAS2F,KAAM,UAAWC,SAAU,IACxDC,QAAS,CACPnC,KAAM7B,EAAMvH,IAAI,GAAK,KACrBuJ,IAAKhC,EAAMvH,IAAI,GAAK,KACpBpB,MAAO2I,EAAMuC,IAAI,GAAK,KACtBjL,OAAQ0I,EAAMuC,IAAI,GAAK,QAGxBvC,EAAMuD,cCiBAU,WAAMR,MA3CrB,SAAiBzD,GACf,OACE,yBACEkE,QAAO,cAASlE,EAAM3I,MAJV,KAIL,YAAoC2I,EAAM1I,OAJrC,MAKZsK,MAAO,CACLuB,SAAU,WACVtB,KAAK,GAAD,QAAK,MAAL,MACJG,IAAI,GAAD,QAAK,MAAL,MACH3K,MAAM,GAAD,OAAK2I,EAAM3I,MATN,KASL,MACLC,OAAO,GAAD,OAAK0I,EAAM1I,OAVP,KAUJ,MACN6M,cAAe,OACfN,WAAY,gBAGd,8BACE,6BACEnO,GAAG,OACH2B,MAAM,IACNC,OAAO,IACP8M,aAAa,iBACbC,eAAe,sBAEf,0BACE/H,EAAE,kBACFgI,KAAK,OACLC,OAAO,OACPC,YAAaC,QAInB,0BACE7C,MAAO,CACLuC,cAAe,QAEjBrD,EAAG,EACHC,EAAG,EACH1J,MAAO2I,EAAM3I,MArCH,KAsCVC,OAAQ0I,EAAM1I,OAtCJ,KAuCVgN,KAAK,mBCyFEb,uBAxHf,SAAsBzD,GAAwB,IACpC0E,EAAqC1E,EAArC0E,gBAAiBC,EAAoB3E,EAApB2E,gBACnBC,EAAa3E,iBAAkC,MAE/C4E,EAAgBC,uBACpB,SAAClO,GACMA,EAAGmO,WAA4B,IAAfnO,EAAGoO,UAGnBJ,EAAWnD,UACdmD,EAAWnD,QAAU9K,EAAMC,GAC1BA,EAAGqO,OAAeC,kBAAkBtO,EAAGuO,YAI1CT,EAAgB/N,EAAMC,OAExB,CAAC8N,IAEGU,EAAcN,uBAClB,SAAClO,GAC4B,OAAvBgO,EAAWnD,UACb7K,EAAGuK,iBACHvK,EAAGwK,kBACHuD,EAAgBhO,EAAMC,IACtBgO,EAAWnD,QAAU,QAGzB,CAACkD,IAGGU,EAAUpF,mBAqBhB,OApBAqF,qBAAU,WAAO,IAAD,EACd,UAAAD,EAAQ5D,eAAR,SAAiB8D,iBACf,aACA,SAAC3O,GAAD,OAAQA,EAAGuK,mBACX,CAAEqE,SAAS,MAEZ,IACHC,2BAAgB,WACd,IAAMvP,EAAOmP,EAAQ5D,QAEfN,EAAiB,SAACvK,GAAD,OAAaA,EAAGuK,kBAIvC,OAHAjL,EAAKqP,iBAAiB,cAAepE,EAAgB,CAAEuE,SAFvC,IAGhBxP,EAAKqP,iBAAiB,cAAeV,EAAe,CAAEa,SAHtC,IAIhBxP,EAAKqP,iBAAiB,YAAaH,EAAa,CAAEM,SAJlC,IAKT,WACLxP,EAAKyP,oBAAoB,cAAexE,EAAgB,CAAEuE,SAN5C,IAOdxP,EAAKyP,oBAAoB,cAAed,EAAe,CAAEa,SAP3C,IAQdxP,EAAKyP,oBAAoB,YAAaP,EAAa,CAAEM,SARvC,OAUf,CAACb,EAAeO,IAEjB,kBAAC5B,GAAD,CACEhD,IAAK6E,EACL5M,IAAKuH,EAAMvH,IACX8J,IAAKvC,EAAMuC,IACXX,MAAO,CACLgE,OAAQ,iBACRC,UAAW,eACXC,SAAU,YAGZ,yBACEC,UAAU,UACVnE,MAAO,CACLuB,SAAU,WACVtB,KAAK,GAAD,QAAK,EAAL,MACJG,IAAI,GAAD,QAAK,EAAL,MACH3K,MAAM,GAAD,OAvEI,GAuEJ,MACLC,OAAO,GAAD,OAxEG,GAwEH,MACNgM,WAAY,OACZ0C,OAAQ,cACRJ,OAAQ,kBACRK,UAAW,gBAGf,yBACEF,UAAU,WACVnE,MAAO,CACLuB,SAAU,WACVnB,IAAI,GAAD,QAAK,EAAL,MACHoB,MAAM,GAAD,QAAK,EAAL,MACL/L,MAAM,GAAD,OArFI,GAqFJ,MACLC,OAAO,GAAD,OAtFG,GAsFH,MACNgM,WAAY,OACZ0C,OAAQ,cACRJ,OAAQ,qBAGZ,yBACEG,UAAU,UACVnE,MAAO,CACLuB,SAAU,WACVE,OAAO,GAAD,QAAK,EAAL,MACNxB,KAAK,GAAD,QAAK,EAAL,MACJxK,MAAM,GAAD,OAlGI,GAkGJ,MACLC,OAAO,GAAD,OAnGG,GAmGH,MACNgM,WAAY,OACZ0C,OAAQ,cACRJ,OAAQ,qBAGZ,yBACEG,UAAU,WACVnE,MAAO,CACLuB,SAAU,WACVE,OAAO,GAAD,QAAK,EAAL,MACND,MAAM,GAAD,QAAK,EAAL,MACL/L,MAAM,GAAD,OA/GI,GA+GJ,MACLC,OAAO,GAAD,OAhHG,GAgHH,MACNgM,WAAY,OACZ0C,OAAQ,cACRJ,OAAQ,yBCpHlB,SAASM,GAAUC,EAAoBC,EAAgBC,GACrD,IADqE,EACjEC,EAAQ,KADyD,eAEvDH,GAFuD,IAErE,2BAAuB,CAAC,IAAf/L,EAAc,QACrB,GAAIA,EAAEmM,aAAeH,GAAUhM,EAAEmM,aAAeF,EAAQ,CACtD,GAAc,OAAVC,EAAgB,CAClBA,EAAQ,CAAClM,EAAEvD,QAASuD,EAAEtD,SACtB,SAEF,IAAM0P,EAAS,CAACpM,EAAEvD,QAASuD,EAAEtD,SACvB2P,EAAOvP,EAAIoP,EAAcE,GAAerO,IAAI2J,KAAK4E,KAGvD,MAAO,CAAEC,KAFI7E,KAAK4E,IAAID,EAAK,GAAKA,EAAK,IAEtBG,OADA7P,EAAIuP,EAAcE,GAAerO,KAAI,SAAA0O,GAAC,OAAIA,EAAI,QAXI,+BCevE,SAASC,GAAKC,GACZ,OAAOA,EAAK,GAGP,IAiNMC,GAAWvD,eAAKC,sBA9MvB,SAAC1D,EAAOQ,GACV,IAAMyG,EAAWhH,iBAAuB,MAClCiH,EAAajH,iBAAuB,MACtCkH,EAASlH,iBAAuB,MAIhCmH,EAAQnH,iBAAO,CACnBa,EAAG,EACHC,EAAG,IAECsG,EAAQpH,iBAAO,GACfqH,EAAQrH,iBAAO,CACnB5I,MAAO,EACPC,OAAQ,IAEJiQ,EAAQtH,iBAAO,CACnB5I,MAAO,EACPC,OAAQ,IAGJkB,EAASyH,iBAAO,CAAC,EAAG,IAEpBuH,EAAe,WACnBhP,EAAOiJ,QAAU,CACfK,KAAK2F,IACH,GACCH,EAAM7F,QAAQpK,MAAQkQ,EAAM9F,QAAQpK,MAAQgQ,EAAM5F,SAAW,GAEhEK,KAAK2F,IACH,GACCH,EAAM7F,QAAQnK,OAASiQ,EAAM9F,QAAQnK,OAAS+P,EAAM5F,SAAW,IAGpEhH,QAAQC,IAAI,SAAUlC,GACtB0O,EAAWzF,QAASG,MAAM8F,UAA1B,oBAAmDlP,EAAOiJ,QAAQ,GAAlE,eAA2EjJ,EAAOiJ,QAAQ,GAA1F,OACAyF,EAAWzF,QAASG,MAAM+F,SAAWN,EAAM5F,QAAU,KACrD0F,EAAO1F,QAASG,MAAM8F,UAAtB,gBAA2CL,EAAM5F,QAAjD,MAEImG,EAAe9C,uBACnB,SAAC+C,EAA4BC,GAC3B,IAAMC,EAAYjG,KAAKkG,IAxDX,EA0DVlG,KAAK2F,IA3DK,GA2DUJ,EAAM5F,QAAUqG,IAEtCrN,QAAQC,IAAIqN,GACZ,IAAME,EAAQF,EAAYV,EAAM5F,QAChC4F,EAAM5F,QAAUsG,EAChB,IAAMlG,EAAOoF,EAASxF,QAASyG,WACzBlG,EAAMiF,EAASxF,QAAS0G,UAC9BX,IACAP,EAASxF,QAAS2G,SAChBvG,EAAOgG,EAAS,GAAKI,EACrBjG,EAAM6F,EAAS,GAAKI,KAGxB,IAGItG,EAAiBmD,uBACrB,YAAiD,IAAD,mBAA9ChE,EAA8C,KAA3CC,EAA2C,KACxCsH,EAAKvH,EAAIsG,EAAM3F,QAAQX,EAAImG,EAASxF,QAASyG,WAC7CI,EAAKvH,EAAIqG,EAAM3F,QAAQV,EAAIkG,EAASxF,QAAS0G,UACnD,MAAO,EACJE,EAAK7P,EAAOiJ,QAAQ,IAAM4F,EAAM5F,SAChC6G,EAAK9P,EAAOiJ,QAAQ,IAAM4F,EAAM5F,WAGrC,CAACjJ,IAGH+P,8BACE/H,GACA,iBAAO,CAELgI,aAAc,WACZ,OAAO7G,EAAc,WAAd,aAAwBxJ,IAAI2O,QAGvC,CAACnF,IAGH,IAAM8G,EAAU3D,uBACd,SAAClO,GACC,GAAKA,EAAG8R,QAAR,CACA,IAAMC,EAAWhH,EAAe,CAAC/K,EAAGC,QAASD,EAAGE,UAC1CmR,EApGU,IAoGFnG,KAAK2F,KAAK,EAAG3F,KAAKkG,IAAI,GAAIpR,EAAGgS,SAC3ChB,EAAae,EAAUV,MAEzB,CAACL,EAAcjG,IAIjB2D,qBAAU,WACR,IAAM5O,EAAIuQ,EAASxF,QACboH,EAAc,SAACjS,GAAD,OAAoBA,EAAG8R,SAAW9R,EAAGuK,kBAGzD,OAFAzK,EAAE6O,iBAAiB,QAASsD,EAAa,CAAErD,SAAS,IACpD9O,EAAE6O,iBAAiB,QAASkD,GACrB,WACL/R,EAAEiP,oBAAoB,QAASkD,GAC/BnS,EAAEiP,oBAAoB,QAAS8C,MAEhC,CAACA,IAGJ,IAAIK,EAAa7I,iBAAO,GAgExB,OD9KK,SAAkBgF,EAAmCjJ,GAI1D,IAAM+M,EAAS9I,iBAAO,CAAC,EAAG,IACpBmG,EAASnG,iBAAO,MAChBoG,EAASpG,iBAAO,MAChB+I,EAAe/I,iBAAO,GAC5BqF,qBAAU,WACR,IAAM2D,EAAe,SAACrS,GAKpB,GAJ0B,IAAtBA,EAAGuP,QAAQ1D,SACb2D,EAAO3E,QAAU7K,EAAGuP,QAAQ,GAAGI,YAGP,IAAtB3P,EAAGuP,QAAQ1D,QAAmC,OAAnB2D,EAAO3E,SAAuC,OAAnB4E,EAAO5E,QAAkB,CACjF,IAAMyH,EAAQtS,EAAGuP,QAAQ,GAAGI,aAAeH,EAAO3E,QAAU7K,EAAGuP,QAAQ,GAAKvP,EAAGuP,QAAQ,GACvFE,EAAO5E,QAAUyH,EAAM3C,WAF0D,MAIxDL,GAAUtP,EAAGuP,QAASC,EAAO3E,QAAS4E,EAAO5E,SAA9DmF,EAJyE,EAIzEA,OAAQD,EAJiE,EAIjEA,KAChBoC,EAAOtH,QAAUmF,EACjBoC,EAAavH,QAAUkF,EACvB3K,EAASmN,aAAa,CACpBC,aAAcL,EAAOtH,QACrB4F,MAAO,EACPlG,eAHoB,WAGFvK,EAAGuK,sBAKrBkI,EAAc,SAACzS,GACnB,GAAuB,OAAnBwP,EAAO3E,SAAuC,OAAnB4E,EAAO5E,QAAtC,CADsC,IAE9BkF,EAAST,GAAUtP,EAAGuP,QAASC,EAAO3E,QAAS4E,EAAO5E,SAAtDkF,KACR3K,EAASsN,QAAQ,CACfF,aAAcL,EAAOtH,QACrB4F,MAAOV,EAAOqC,EAAavH,QAC3BN,eAHe,WAGGvK,EAAGuK,sBAInBoI,EAAa,SAAC3S,GAClB,IADqC,EACjC4S,EAAQ,EADyB,eAEvB5S,EAAGuP,SAFoB,IAErC,gCAAS/L,EAAT,QACMA,EAAEmM,aAAeH,EAAO3E,SAAWrH,EAAEmM,aAAeF,EAAO5E,UAC7D+H,GAAS,IAJwB,8BAMvB,IAAVA,IACFpD,EAAO3E,QAAU4E,EAAO5E,QAAU,OAIhCgI,EAAO,CAAEjE,SAAS,GAClBkE,EAAczE,EAAOxD,QAI3B,OAHW,OAAXiI,QAAW,IAAXA,KAAanE,iBAAiB,aAAc0D,EAAcQ,GAC/C,OAAXC,QAAW,IAAXA,KAAanE,iBAAiB,WAAYgE,EAAYE,GAC3C,OAAXC,QAAW,IAAXA,KAAanE,iBAAiB,YAAa8D,EAAaI,GACjD,WACM,OAAXC,QAAW,IAAXA,KAAa/D,oBAAoB,aAAcsD,GACpC,OAAXS,QAAW,IAAXA,KAAa/D,oBAAoB,WAAY4D,GAClC,OAAXG,QAAW,IAAXA,KAAa/D,oBAAoB,YAAa0D,OCqDhDM,CAAS1C,EAAU,CACjBkC,aADiB,SACJvS,GACXA,EAAGuK,iBACH2H,EAAWrH,QAAU7K,EAAGyQ,OAE1BiC,QALiB,SAKT1S,GACNA,EAAGuK,iBACH,IAAMwH,EAAWhH,EAAe/K,EAAGwS,cAC7BnB,EAA0C,KAAjCrR,EAAGyQ,MAAQyB,EAAWrH,SACrCqH,EAAWrH,QAAU7K,EAAGyQ,MACxB5M,QAAQC,IAAIuN,GACZL,EAAae,EAAUV,MAuB7BxC,2BAAgB,WACd,IAAMmE,EAAO3C,EAASxF,QAASoI,wBAC/BzC,EAAM3F,QAAU,CACdX,EAAG8I,EAAK9I,EACRC,EAAG6I,EAAK7I,GAEV,IAAM+I,EAAgB,SAACC,EAA6BrS,GAA9B,OACpB,IAAIsS,gBAAe,SAACC,GAClB,IAAML,EAAOK,EAAQC,MAAOC,YAC5BJ,EAAKtI,QAAU,CACbpK,MAAOuS,EAAKvS,MACZC,OAAQsS,EAAKtS,OACbwJ,EAAG8I,EAAK9I,EACRC,EAAG6I,EAAK7I,GAEVtG,QAAQC,IAAI,UAAYhD,EAAMqS,EAAKtI,SACnC+F,QAEE4C,EAAaN,EAAcxC,EAAO,YACxC8C,EAAWC,QAAQpD,EAASxF,SAC5B,IAAM6I,EAAaR,EAAcvC,EAAO,UAGxC,OAFA+C,EAAWD,QAAQlD,EAAO1F,SAC1BhH,QAAQC,IAAI,WAAYyM,EAAO1F,SACxB,WACL2I,EAAWG,aACXD,EAAWC,gBAEZ,IAGD,yBACExE,UAAU,WACVvF,IAAKyG,EACLrF,MAAO,CACLkE,SAAU,OACV3C,SAAU,WACVqH,YAAa,gBAGf,yBACEhK,IAAK0G,EACLtF,MAAO,CACLuB,SAAU,WACVuE,UAAU,aAAD,OAAelP,EAAOiJ,QAAQ,GAA9B,eAAuCjJ,EAAOiJ,QAAQ,GAAtD,OACXkG,SAAUN,EAAM5F,QAAU,OAE5B,yBACEsE,UAAU,UACVvF,IAAK2G,EACLvF,MAAO,CACLuB,SAAU,WACVwE,SAAU,MACVD,UAAU,SAAD,OAAWL,EAAX,KACToD,gBAAiB,MACjB5G,WAAY,YACZiC,SAAU,YAGX9F,EAAMuD,UAENvD,EAAM0K,cCnNFnK,GAAcoK,wBAAc,CACvChJ,eADuC,SACxBhL,GACb,MAAO,CAAC,EAAG,MA2JA8M,uBAvJR,SAAczD,GACnB,IAAIiH,EAAWhH,iBAAoB,MAC/BpG,EAAWuG,cAEX+B,EAAQyI,aAAY,SAAC/S,GAAD,OAAsBA,EAAML,KAAKJ,KAAK,GAAGG,UAJT,EAMZoJ,mBAAc,MANF,mBAMnDkK,EANmD,KAMlCC,EANkC,OAOxBnK,mBAAmB,IAPK,mBAOnDoK,EAPmD,KAOxCC,EAPwC,KAQpDC,EAAgBC,mBAClB,kBAAOH,EAAUtI,OAAS,EAAIN,EAAM4I,EAAU,IAAItS,IAAO,CAAC,EAAG,KAC7D,CAAC0J,EAAO4I,IAEJrG,EAAkBI,uBACtB,SAACnO,GhB1BE,IAgCLwU,EACAnD,EACAP,EgBPIqD,EAEI5T,GhBGRiU,EgBDYlE,EAASxF,QAAS+G,aAAa7R,GhBE3CqR,EgBDY,CAAC,EAAG,GhBEhBP,EgBDYvQ,EAAI8I,EAAMoL,WAAmBjJ,EAAM4I,EAAU,IAAIxI,KhBGtD,CACLT,KAAK2F,IAAIO,EAAI,GAAIlG,KAAKkG,IAAIP,EAAI,GAAI0D,EAAI,KACtCrJ,KAAK2F,IAAIO,EAAI,GAAIlG,KAAKkG,IAAIP,EAAI,GAAI0D,EAAI,OgBH9BF,GhBlCD9S,IAAI2J,KAAKC,UgBuChB,CAACkJ,EAAejL,EAAMoL,WAAYjJ,EAAO4I,IAGrCpG,EAAkBG,uBACtB,SAACnO,GACCkD,EACEvB,EAAY,CACVH,IAAK,EACLzC,GAAIqV,EAAU,GACd1S,IAAK,CACHI,IAAK1B,EAAIoL,EAAM4I,EAAU,IAAItS,IAAKoS,OAIxCC,EAAmB,CAAC,EAAG,MAEzB,CAACjR,EAAUsI,EAAO4I,EAAWF,IAGzBQ,EAAavG,uBACjB,SAAClO,GACC,GAAyB,IAArBmU,EAAUtI,OAAd,CACA,IAAM6I,EAAW,CAAEnT,IAAK,EAAGzC,GAAIqV,EAAU,IACzC,OAAQnU,EAAGX,KACT,IAAK,aACH4D,EAAStB,EAAU,2BAAK+S,GAAN,IAAgB9S,OAAQ,CAAC,EAAG,OAC9C5B,EAAGuK,iBACH,MACF,IAAK,YACHtH,EAAStB,EAAU,2BAAK+S,GAAN,IAAgB9S,OAAQ,EAAE,EAAG,OAC/C5B,EAAGuK,iBACH,MACF,IAAK,UACHtH,EAAStB,EAAU,2BAAK+S,GAAN,IAAgB9S,OAAQ,CAAC,GAAI,OAC/C5B,EAAGuK,iBACH,MACF,IAAK,YACHtH,EAAStB,EAAU,2BAAK+S,GAAN,IAAgB9S,OAAQ,CAAC,EAAG,OAC9C5B,EAAGuK,qBAIT,CAACtH,EAAUkR,IAUb,OAPAzF,qBAAU,WAER,OADAiG,SAAShG,iBAAiB,UAAW8F,EAAY,CAAE3F,SAAS,IACrD,WACL6F,SAAS5F,oBAAoB,UAAW0F,EAAY,CAAE3F,SAAS,OAEhE,CAAC2F,IAGF,yBAAKtF,UAAU,QACb,kBAACiB,GAAD,CAAUxG,IAAKyG,EACbyD,QACIK,EAAUtI,OAAS,GACjB,kBAAC,GAAD,CACExM,IAAI,GACJwC,IAAK1B,EAAI8T,EAAkBI,GAC3B1I,IAAKJ,EAAM4I,EAAU,IAAIxI,IACzBmC,gBAAiBA,EACjBC,gBAAiBA,KAKzB,kBAACpE,GAAYiL,SAAb,CACEC,MAAO,CACL,qBACE,OAAOxE,EAASxF,QAAS+G,gBAI7B,yBACE5G,MAAO,CACLvK,MAAO2I,EAAMoL,WAAW,GAAK,KAC7B9T,OAAQ0I,EAAMoL,WAAW,GAAK,KAC9BjI,SAAU,aAGZ,kBAACpD,GAAD,KACG2L,OAAOC,OAAOxJ,GAAOhK,KAAI,SAACjC,EAAMwM,GAAP,OACxB,kBAACc,GAAD,CACE9N,GAAIQ,EAAKR,GACTO,IAAKC,EAAKR,GACV+C,IACE1B,EACEb,EAAKuC,IACLsS,EAAUa,SAAS1V,EAAKR,IACnBmV,EACD,CAAC,EAAG,IAGZtI,IAAKrM,EAAKqM,IACVsJ,SAAUnJ,EACVoJ,QAAS,SAAClV,GACRoU,EAAa,CAAC9U,EAAKR,KACnBoV,EAAmB,CAAC,EAAG,KAEzBiB,OAAQ,SAACnV,GACPoU,EAAa,MAGf,yBACEgB,YAAa,SAACpV,GAAD,OAAQA,EAAGuK,kBACxB8K,IAAI,GACJ/M,IAAKhJ,EAAKsM,KACVZ,MAAO,CAAEsK,QAAS,QAAS7U,MAAO,OAAQC,OAAQ,cAIxD,kBAAC,GAAD,CACED,MAAO2I,EAAMoL,WAAW,GACxB9T,OAAQ0I,EAAMoL,WAAW,a,MCtKlC,SAASe,KACd,IAAMC,EAAexB,aACnB,SAACvI,GAAD,YACqB,cAAnBA,EAAEvE,MAAMS,QACmC,QAA3C,UAAA8D,EAAEtM,QAAQ8C,KAAKwJ,EAAEvE,MAAMD,iBAAvB,eAAkCnG,SAGhCmG,EAAW+M,aAAY,SAACvI,GAAD,OAAkBA,EAAEvE,MAAMD,YACjDhE,EAAWuG,cAEXiM,EAAevH,uBACnB,SAAClO,GACCA,EAAGuK,iBACH,IACMzJ,EADO,IAAI4U,SAAS1V,EAAG2V,YAAYtH,QACvBvH,IAAI,QACtB7D,EAASV,EAAW,CAAEC,OAAQyE,EAAUnG,YAE1C,CAACmG,EAAUhE,IAGb,OAAKuS,EAKH,yBAAK1W,GAAG,QACN,0BACEkM,MAAO,CACLsK,QAAS,OACTM,cAAe,SACfC,SAAU,QACVnJ,WAAY,OAEdoJ,SAAUL,GAEV,2BAAOM,QAAQ,QAAf,gBAEE,2BAAOjV,KAAK,OAAOyG,KAAK,OAAOyO,aAAc,MAE/C,4BAAQzO,KAAK,UAAb,UAlBG,K,MCpBJ,SAAS0O,GAAU7M,GACxB,IAAM7F,EAASyQ,aAAY,SAAC/S,GAAD,OAAsBA,EAAMqC,MAAMC,UACrDC,EAAM0S,cAAN1S,EACR,OACE,yBAAK2L,UAAU,aACb,kBAAC,KAAD,KACG5L,EAAOhC,KAAI,SAAC+B,GAAD,OACV,kBAAC,KAAOyJ,IAAR,CACEoC,UAAU,QACVnC,QAAS,CAAET,SAAU,WAAY4J,QAAS,GAC1C/I,QAAS,CAAEb,SAAU,WAAY4J,QAAS,GAC1CC,KAAM,CAAE7J,SAAU,WAAY4J,QAAS,GACvCE,QAAM,EACNhX,IAAKiE,EAAMxE,IAEV0E,EAAEF,EAAMN,W,MCnBd,SAASsT,KACd,OACE,yBAAKnH,UAAU,WACb,yBAAKA,UAAU,mBACf,yBAAKA,UAAU,oB,aCDd,SAASoH,KACd,IAAMpX,EAAU6U,aAAY,SAACwC,GAAD,OAC1BA,EAAMrX,QAAQ6C,OAAOT,KAAI,SAACzC,GAAD,OAAQ0X,EAAMrX,QAAQ8C,KAAKnD,SAF9B,EAISiL,oBAAS,GAJlB,mBAIjB0M,EAJiB,KAIPC,EAJO,KAKlBzT,EAAWuG,cACThG,EAAM0S,cAAN1S,EAWR,OAVAkL,qBAAU,WACR,GAAK+H,EAAL,CAEA,IAAME,EAAU,kBAAMD,GAAa,IAEnC,OADA/B,SAAShG,iBAAiB,QAASgI,GAC5B,WACLhC,SAAS5F,oBAAoB,QAAS4H,OAEvC,CAACF,IAGF,yBACEzL,MAAO,CACLuB,SAAU,YAEZqK,QACEH,EACI,SAACzW,GACCA,EAAGwK,wBAELlG,GAGN,4BACEsS,QAAS,kBAAMF,GAAa,SAACnY,GAAD,OAAQA,MACpCyM,MAAO,CACL6L,uBAAwBJ,EAAW,SAAMnS,EACzCwS,wBAAyBL,EAAW,SAAMnS,EAC1CyS,aAAcN,EAAW,YAASnS,IAGpC,kBAAC,KAAD,CACE0G,MAAO,CAAEgM,cAAe,WAAYjG,SAAU,YATlD,OAWS5R,EAAQ0M,OAXjB,QAaC4K,GACC,yBACEzL,MAAO,CACLuB,SAAU,WACVnB,IAAK,OACLH,KAAM,IACNyB,WAAY,QACZuK,WAAY,iBACZC,YAAa,iBACbH,aAAc,iBACdI,UAAW,iBACXC,qBAAsB,MACtBN,wBAAyB,MACzBD,uBAAwB,MACxBQ,oBAAqB,MAGtBlY,EAAQoC,KAAI,SAACe,GAAD,OACX,yBACE0I,MAAO,CACLsM,QAAS,UAGVhV,EAAExB,SAGP,4BACE8V,QAAS,WACPW,UAAUC,UAAUC,UAAUjQ,OAAOkQ,SAAS9L,MAC9C3I,EAASH,EAAWU,EAAE,2BAH1B,sB,MCpDKmU,OAdf,SAAiBvO,GACf,IAAIlC,EAAQ8M,aAAY,SAAC/S,GAAD,OAAsBA,EAAMiG,SAChDjE,EAAWuG,cACf,OACE,yBAAK2F,UAAU,WACK,YAAjBjI,EAAMS,QACL,4BAAQiP,QAAS,kBAAM3T,EAASiB,QAAhC,QAEgB,YAAjBgD,EAAMS,QAAwB,kBAAC,GAAD,MAEb,cAAjBT,EAAMS,QAA0B,kBAAC4O,GAAD,QCmExBqB,OAhEf,WACE,IAAI1Q,EAAQ8M,aAAY,SAAC/S,GAEvB,OADA4C,QAAQC,IAAI7C,GACLA,EAAMiG,SAHF,EAKmB6C,oBAAS,kBAAM,KALlC,mBAKR8N,EALQ,KAMTlM,GANS,KAMHqI,aAAY,SAAC/S,GAAD,MAAsB,CAC1CA,EAAML,KAAKJ,KAAKqX,GAAUpX,MAC1BQ,EAAML,KAAKJ,KAAKqX,GAAUnX,YAExBuC,EAAWuG,cACPhG,EAAM0S,cAAN1S,EAEJrE,EAAU6U,aAAY,SAAC/S,GAAD,OACxBA,EAAM9B,QAAQ6C,OAAOT,KAAI,SAACe,GAAD,OAAOrB,EAAM9B,QAAQ8C,KAAKK,GAAGxB,WAExD,OACE,yBAAKqO,UAAU,OACb,kBAAC,GAAD,MACA,kBAAC8G,GAAD,MACA,kBAAC,GAAD,CAAMzB,WAAY7I,IAClB,kBAAC,GAAD,KACE,4BACEiL,QAAS,kBACP3T,EACE5B,EAAc,CACZE,IAAKsW,EACLpX,MAAOkL,EAAI,GAAK,EAChBjL,OAAQiL,EAAI,QANpB,cAaA,4BACEiL,QAAS,kBACP3T,EACE5B,EAAc,CACZE,IAAKsW,EACLpX,MAAOkL,EAAI,GACXjL,OAAQiL,EAAI,GAAK,OANzB,WAaA,4BAAQiL,QAAS,kBAAM3T,EAASnB,EAAM,OAAtC,SACA,4BAAQ8U,QAAS,kBAAM3T,EAASH,EAAWU,EAAE,aAA7C,UACkB,YAAjB0D,EAAMS,QACL,4BAAQiP,QAAS,kBAAM3T,EAASiB,QAAhC,QAEgB,YAAjBgD,EAAMS,QAAwB,kBAAC,GAAD,MAE9BT,EAAMU,SAAN,mBAA6BV,EAAMH,QACnC5H,EAAQoC,KAAI,SAACe,GAAD,OACX,2BAAIA,GAAK,iB,2BC3EnBwV,KACGC,IAAIC,MACJD,IAAIE,MAEJC,KAAK,CACJjU,OAAO,EAEPkU,IAAK,KACLC,YAAa,KACbC,UAAW,CAAC,KAAM,MAElBC,cAAe,CACbC,aAAa,GAEfC,QAAS,CACPC,SAAU,6CAIDX,GAAf,E,kBCdMY,GAAcC,aAAgB,CAAEzR,SAAOtG,OAAM0C,QAAOnE,YAGpDoB,GAA0BmY,QAAYpU,EAAW,CAAEiD,KAAM,SAGzDiP,GAA+BoC,YAAe,CAClDzQ,QADkD,SAC1ClH,EAAOC,GACb,MAAoB,eAAhBA,EAAOqG,KhBLR,SACLtG,EACAC,GAEA,OAAO,2BACFD,GADL,IAEEL,KAAMM,EAAOC,QAAQP,KACrBzB,QAAS+B,EAAOC,QAAQhC,UgBDf0Z,CAAU5X,EAAQC,GAEpBwX,GAAYzX,EAAOC,IAE5B4X,WAAY,SAACpW,GAAD,OACVA,IAAIqW,SAAQ,SAACC,GAAD,OAAS,SAACC,GAAD,OAAU,SAAC/X,GAAY,IAAD,IASzC,OALA2C,QAAQC,IAAI,cAAe7C,GAAMwF,MACjCxF,GAAMwF,OAAN,UACEvF,EAAOmH,YADT,aACE,EAAa/G,UACb,UAAAJ,EAAOmH,YAAP,eAAaC,OAAQrH,GAAMwF,KAAK3H,IAChCmC,GAAMwF,KAAKX,KAAK5E,GACX+X,EAAK/X,SAEhBgY,eAAgB3Y,KAGlBiW,GAAM2C,WAAU,WACd,IAAMlY,EAAQuV,GAAMxP,WACpBnD,QAAQC,IAAI7C,GChCP,SAAsBnC,EAAYmC,GACvC1B,eAAeK,QAAQd,EAAIW,KAAKI,UAAUoB,IDgC1CmY,CAAanY,EAAML,KAAK9B,GAAImC,EAAML,MAClCxB,EAAY,UAAW6B,EAAM9B,QAAQ8C,SAExBuU,UE1BT5V,GAHY,IAAIyY,gBAAgB7R,OAAOkQ,SAAS4B,QAG/BxS,IAAI,QACvB7F,GDhBG,SAAmBnC,GACxB,IAAMQ,EAAOC,eAAeC,QAAQV,GACpC,OAAOQ,EAAOG,KAAKC,MAAMJ,GAAQ,KCcvBia,CAAS,OAAC3Y,SAAD,IAACA,MAAQ,SAG1BA,IACFiD,QAAQC,IAAI,eAAgBlD,IACxBxB,EAAY,iBAAmBwB,IACjCiD,QAAQC,IAAI,cACR7C,IACFuV,GAAMvT,SAAS7B,EAASH,KAE1B7B,EAAY,WACZoX,GAAMvT,SAASiB,QAEfL,QAAQC,IAAI,OACZ0S,GAAMvT,SAASgC,GAAQrE,OAEhBK,IACTuV,GAAMvT,SAAS7B,EAASH,KAG1BuY,IAASC,OACP,kBAAC,IAAMC,WAAP,KACE,kBAAC,WAAD,CAAUC,SAAU,MAClB,kBAAC,IAAD,CAAUnD,MAAOA,IACf,kBAAC,GAAD,SAIN7B,SAASiF,eAAe,W","file":"static/js/main.ef3c5d54.chunk.js","sourcesContent":["function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = function() { return []; };\nwebpackEmptyContext.resolve = webpackEmptyContext;\nmodule.exports = webpackEmptyContext;\nwebpackEmptyContext.id = 43;","import { v4 as uuid } from \"uuid\";\nimport { Player } from \"../modules/players\";\n\n// Provides a strongly-typed interface to our session variables\n\nconst defaults = {\n  // Denotes whether the user is currently hosting\n  was_hosting: () => null as null | string,\n  // Denote the session-specific comms_id\n  comms_id: uuid,\n  // The player object created for this session\n  players: () => ({} as { [id: string]: Player }),\n};\n\ntype SessionMap = typeof defaults;\nexport const Session = {\n  get<K extends keyof SessionMap>(key: K): ReturnType<SessionMap[K]> {\n    const item = sessionStorage.getItem(key);\n    if (item) {\n      return JSON.parse(item);\n    }\n\n    const def = defaults[key]() as ReturnType<SessionMap[K]>;\n    sessionStorage.setItem(key, JSON.stringify(def));\n    return def;\n  },\n\n  set<K extends keyof SessionMap>(key: K, v: ReturnType<SessionMap[K]>) {\n    sessionStorage.setItem(key, JSON.stringify(v));\n  },\n};\n","export type GridSpace = \"gridspace\";\nexport type CanvasSpace = \"canvasspace\";\nexport type ClientSpace = \"clientspace\";\n\ninterface Unit<T> {\n  _unitBrand: T;\n}\nexport type Coord<T> = [number, number] & Unit<\"coord\">;\nexport type Offset<T> = [number, number] & Unit<\"offset\">;\nexport type Pair<T> = Coord<T> | Offset<T>;\n\nexport function coord(ev: {\n  clientX: number;\n  clientY: number;\n}): Coord<ClientSpace> {\n  return [ev.clientX, ev.clientY] as Coord<ClientSpace>;\n}\n\nexport function floor<T extends [number, number]>(a: T): T {\n  return a.map(Math.floor) as T;\n}\n\nexport function trunc<T extends [number, number]>(a: T): T {\n  return a.map((n) => (n < 0 ? Math.ceil(n) : Math.floor(n))) as T;\n}\n\nexport function add<T>(a: Offset<T>, b: Offset<T>): Offset<T>;\nexport function add<T>(a: Coord<T>, b: Offset<T>): Coord<T>;\nexport function add<T>(\n  a: [number, number],\n  b: [number, number]\n): [number, number] {\n  return [a[0] + b[0], a[1] + b[1]] as any;\n}\n\nexport function sub<T>(a: Offset<T>, b: Offset<T>): Offset<T>;\nexport function sub<T>(a: Coord<T>, b: Offset<T>): Coord<T>;\nexport function sub<T>(a: Coord<T>, b: Coord<T>): Offset<T>;\nexport function sub<T>(\n  a: [number, number],\n  b: [number, number]\n): [number, number] {\n  return [a[0] - b[0], a[1] - b[1]] as any;\n}\n\nexport function clamp(val: number, min: number, max: number) {\n  return Math.min(max, Math.max(min, val));\n}\n\nexport function coord_clamp<T, P extends Pair<T>>(\n  val: P,\n  min: [number, number],\n  max: [number, number]\n): P {\n  return [\n    Math.max(min[0], Math.min(max[0], val[0])),\n    Math.max(min[1], Math.min(max[1], val[1])),\n  ] as P;\n}\n","import { createSlice, PayloadAction } from \"@reduxjs/toolkit\";\nimport { shared } from \"../comms\";\nimport { add, Coord, GridSpace, Offset } from \"./units\";\n\nexport type Image = {\n  id: string;\n  loc: Coord<GridSpace>;\n  dim: Offset<GridSpace>;\n  href: string;\n};\nexport type GameState = typeof initialState;\nlet initialState = {\n  id: \"local\",\n  maps: [\n    {\n      width: 15,\n      height: 10,\n      images: {} as { [id: string]: Image },\n    },\n  ],\n};\nexport let game = createSlice({\n  name: \"game\",\n  initialState: initialState as typeof initialState,\n  reducers: {\n    forkGame(state, action: { payload: string }) {\n      state.id = action.payload;\n    },\n    loadGame(state, { payload }: { payload: GameState }) {\n      return payload;\n    },\n    setDimensions: shared(\n      (\n        state: any,\n        { payload }: { payload: { map: number; width: number; height: number } }\n      ) => {\n        const { map, width, height } = payload;\n        state.maps[map].width = width;\n        state.maps[map].height = height;\n      }\n    ),\n    addImage: shared(\n      (state: any, action: { payload: { map: number; img: Image } }) => {\n        const { map, img } = action.payload;\n        state.maps[map].images[img.id] = img;\n      }\n    ),\n    updateImage: shared(\n      (\n        state: GameState,\n        action: { payload: { map: number; id: string; img: Partial<Image> } }\n      ) => {\n        const { map, id, img } = action.payload;\n        state.maps[map].images[id] = { ...state.maps[map].images[id], ...img };\n      }\n    ),\n    moveImage: shared(\n      (\n        state: GameState,\n        action: PayloadAction<{\n          map: number;\n          id: string;\n          offset: [number, number];\n        }>\n      ) => {\n        const { map, id, offset } = action.payload;\n        state.maps[map].images[id].loc = add(\n          state.maps[map].images[id].loc,\n          offset as any\n        ) as any;\n      }\n    ),\n    reset: shared(\n      (state: any, action: { payload: any }) => (state = initialState)\n    ),\n  },\n});\n\nexport default game.reducer;\nexport let {\n  setDimensions,\n  addImage,\n  updateImage,\n  reset,\n  loadGame,\n  forkGame,\n  moveImage,\n} = game.actions;\n","import { createSlice, PayloadAction } from \"@reduxjs/toolkit\";\nimport { Session } from \"../storage/session\";\nimport { shared } from \"./comms\";\n\ntype PlayersState = {\n  online: string[];\n  data: { [id: string]: Player };\n};\nconst initialState = {\n  online: [],\n  data: Session.get(\"players\"),\n} as PlayersState;\n\nexport const players = createSlice({\n  name: \"players\",\n  initialState,\n  reducers: {\n    playerJoined: shared(\n      (state: PlayersState, action: PayloadAction<string>) => {\n        state.online.push(action.payload);\n        state.data[action.payload] = state.data[action.payload] || {\n          name: null,\n        };\n      }\n    ),\n    removePlayer: shared(\n      (state: PlayersState, action: PayloadAction<string>) => {\n        state.online = state.online.filter((p) => p !== action.payload);\n      }\n    ),\n    changeName: shared(\n      (\n        state: PlayersState,\n        action: PayloadAction<{ player: string; name: string }>\n      ) => {\n        state.data[action.payload.player].name = action.payload.name;\n      }\n    ),\n  },\n});\n\nexport default players.reducer;\nexport const { playerJoined, removePlayer, changeName } = players.actions;\n\nexport type Player = {\n  name: string | null;\n};\n","import { createAsyncThunk, createSlice } from \"@reduxjs/toolkit\";\n\nconst sleep = (m: number) => new Promise((r) => setTimeout(r, m));\nexport const issueToast = createAsyncThunk(\n  \"toast/issue\",\n  async (msg: string, { dispatch }) => {\n    const id = Date.now();\n    dispatch(addToast({ id: Date.now(), msg }));\n    await sleep(5000);\n    dispatch(removeToast(id));\n  }\n);\n\nexport const toast = createSlice({\n  name: \"toast\",\n  initialState: {\n    toasts: [] as { id: number; msg: string }[],\n  },\n  reducers: {\n    addToast(state, { payload }: { payload: { id: number; msg: string } }) {\n      state.toasts.push(payload);\n    },\n    removeToast(state, { payload }: { payload: number }) {\n      state.toasts = state.toasts.filter((t) => t.id !== payload);\n    },\n  },\n});\n\nexport default toast.reducer;\nexport const { addToast, removeToast } = toast.actions;\n","import Peer, { DataConnection } from \"peerjs\";\nlet { REACT_APP_PEERJS_HOST, REACT_APP_PEERJS_PORT } = process.env;\nexport type PeerID = string & { __roomId: string };\nexport async function create_peer(id?: PeerID): Promise<Peer> {\n  console.log(\"ENV??\", process.env);\n  let peer = new Peer(id, {\n    debug: 3,\n    host: REACT_APP_PEERJS_HOST,\n    secure: true,\n    port: REACT_APP_PEERJS_PORT ? parseInt(REACT_APP_PEERJS_PORT) : undefined,\n    path: \"/\",\n  });\n  return new Promise((resolve, reject) => {\n    let on_error = (e: any) => {\n      cleanup();\n      reject(`Error establishing peer: ${e}`);\n    };\n    let on_open = () => {\n      cleanup();\n      console.log(\"OPENING?\");\n      resolve(peer);\n    };\n    let cleanup = () => {\n      peer.off(\"open\", on_open);\n      peer.off(\"error\", on_error);\n    };\n    peer.on(\"open\", on_open);\n    peer.on(\"error\", on_error);\n  });\n}\n\nexport async function connect_peer(\n  peer: Peer,\n  id: PeerID,\n  metadata?: any\n): Promise<DataConnection> {\n  const dc = peer.connect(id, { metadata });\n  return new Promise((resolve, reject) => {\n    let on_error = (e: any) => {\n      cleanup();\n      reject(`Error establishing peer: ${e}`);\n    };\n    let on_open = () => {\n      cleanup();\n      resolve(dc);\n    };\n    let cleanup = () => {\n      dc.off(\"open\", on_open);\n      dc.off(\"error\", on_error);\n    };\n    dc.on(\"open\", on_open);\n    dc.on(\"error\", on_error);\n  });\n}\n","import { DataConnection } from \"peerjs\";\nimport { connect_peer, create_peer, PeerID } from \"./peer\";\nimport { ServerClient } from \"./server\";\n\nexport type ClientConfig = {\n  onDisconnect(): void;\n  onMessage(msg: any): void;\n  onInitialMessage(msg: any): void;\n  onConnect(): void;\n};\n\nexport async function game_client(\n  game: string,\n  client_id: string,\n  handlers: ClientConfig\n): Promise<ServerClient> {\n  // NOTE: the client_id is not used to construct the peer_id. clients do not need stable Peer identifiers\n  //       instead, clients are identified using the meta field on the Peer\n  let peer = await create_peer();\n  let data_conn: DataConnection;\n  async function connect_data() {\n    data_conn = await connect_peer(peer, game as PeerID, { client_id });\n    setTimeout(() => handlers.onConnect(), 0);\n    return new Promise((resolve, reject) => {\n      data_conn.on(\"error\", () => {\n        keep_trying(connect_data, 1000);\n      });\n      data_conn.on(\"close\", () => {\n        keep_trying(connect_data, 1000);\n      });\n\n      const on_first_message = (d: any) => {\n        data_conn.off(\"data\", on_first_message);\n        data_conn.on(\"data\", handlers.onMessage);\n        handlers.onInitialMessage(d);\n        resolve(d);\n      };\n      data_conn.on(\"data\", on_first_message);\n\n      data_conn.on(\"error\", () => handlers.onDisconnect());\n      data_conn.on(\"close\", () => handlers.onDisconnect());\n    });\n  }\n\n  await connect_data();\n  return {\n    id: client_id,\n    send(msg: any): void {\n      data_conn.send(msg);\n    },\n  };\n}\n\n// Waits timeout between calling f again. stops when f returns true\nfunction keep_trying(f: () => Promise<any>, timeout: number) {\n  setTimeout(async () => {\n    try {\n      await f();\n    } catch {\n      keep_trying(f, timeout);\n    }\n  }, timeout);\n}\n","import { DataConnection } from \"peerjs\";\nimport { ConnId } from \".\";\nimport { create_peer, PeerID } from \"./peer\";\n\ntype Config = {\n  onStartup(): void;\n  onConnect(player: ConnId): void;\n  onDisconnect(label: ConnId): void;\n  onMessage(msg: any): void;\n};\n\nexport interface ServerClient {\n  send(msg: any): void;\n  readonly id: string;\n}\n\nexport async function game_server(server_id: string, handlers: Config) {\n  const peer = await create_peer(server_id as PeerID);\n  const clients = new Map<string, DataConnection>();\n  const broadcast = (data: any, exclude?: string) => {\n    for (let [label, c] of clients) {\n      if (label !== exclude) c.send(data);\n    }\n  };\n\n  peer.on(\"connection\", (conn) =>\n    conn.on(\"open\", () => {\n      const client_id = conn.metadata.client_id as ConnId;\n      console.log(\"NEW CLIENT\", client_id);\n      clients.set(client_id, conn);\n\n      conn.on(\"data\", (d) => {\n        broadcast(d, client_id);\n        handlers.onMessage(d);\n      });\n      conn.on(\"close\", () => {\n        clients.delete(client_id);\n        handlers.onDisconnect(client_id as ConnId);\n      });\n      conn.on(\"error\", () => {\n        clients.delete(client_id);\n        handlers.onDisconnect(client_id as ConnId);\n      });\n\n      handlers.onConnect(conn.metadata.client_id);\n    })\n  );\n\n  handlers.onStartup();\n\n  return {\n    id: server_id,\n    send: broadcast,\n    sendTo(label: string, msg: any) {\n      clients.get(label)!.send(msg);\n    },\n  };\n}\n","import { createAsyncThunk, createSlice, PayloadAction } from \"@reduxjs/toolkit\";\nimport { Session } from \"../../storage/session\";\nimport { RootStore } from \"../../store\";\nimport { forkGame } from \"../game\";\nimport { playerJoined, removePlayer } from \"../players\";\nimport { syncAction } from \"../sync\";\nimport { issueToast } from \"../toast\";\nimport { game_client } from \"./client2\";\nimport { game_server, ServerClient } from \"./server\";\n\nexport let state = {\n  conn: null as null | ServerClient,\n};\n\nexport type ConnId = string & {\n  _connId: \"connid\";\n};\n\nexport const connect = createAsyncThunk(\n  \"comms/connect\",\n  async (gameId: string, { getState, dispatch }) => {\n    const clientId = (getState() as RootStore).comms.clientId;\n    try {\n      state.conn = await game_client(gameId, clientId, {\n        onMessage(m: any) {\n          dispatch(m);\n        },\n        onDisconnect() {\n          dispatch(comms.actions.disconnected());\n        },\n        onInitialMessage(m: any) {\n          dispatch(m);\n        },\n        onConnect() {\n          dispatch(comms.actions.connected());\n        },\n      });\n      console.log(\"connected to server!\");\n    } catch (e) {\n      dispatch(issueToast(\"joinFailure\"));\n      console.log(e);\n      throw e;\n    }\n  }\n);\n\nexport const host = createAsyncThunk(\n  \"comms/host\",\n  async (_: undefined, { getState, dispatch }) => {\n    const clientId = (getState() as RootStore).comms.clientId;\n    const server = await game_server(clientId, {\n      onConnect(player) {\n        server.sendTo(player, syncAction(getState() as any));\n        dispatch(playerJoined(player));\n      },\n      onMessage(m) {\n        dispatch(m);\n      },\n      onDisconnect(label) {\n        dispatch(removePlayer(label));\n      },\n      onStartup() {\n        dispatch(playerJoined(clientId));\n      },\n    });\n\n    state.conn = server;\n    Session.set(\"was_hosting\", server.id);\n    dispatch(forkGame(server.id));\n    window.history.pushState(null, \"\", `?game=${server.id}`);\n    return server.id;\n  }\n);\n\nexport let comms = createSlice({\n  name: \"comms\",\n  initialState: {\n    // NOTE: offline denotes a totally offline game, not a disconnected state\n    status: \"offline\" as \"offline\" | \"pending\" | \"connected\",\n    hosting: false,\n    clientId: Session.get(\"comms_id\"),\n    gameId: null as string | null,\n  },\n  reducers: {\n    disconnected(state, action: {}) {\n      state.status = \"pending\";\n    },\n    connected(state, action: {}) {\n      state.status = \"connected\";\n    },\n  },\n  extraReducers: (builder) => {\n    // Client connection logic\n    builder.addCase(connect.pending, (state, _) => {\n      state.status = \"pending\";\n    });\n    builder.addCase(connect.fulfilled, (state, payload: any) => {\n      state.gameId = payload.gameId;\n      state.status = \"connected\";\n    });\n    builder.addCase(connect.rejected, (state, _) => {\n      state.status = \"offline\";\n    });\n\n    // Hosting events\n    builder.addCase(host.pending, (state, _) => {\n      state.status = \"pending\";\n    });\n    builder.addCase(host.fulfilled, (state, { payload }) => {\n      state.status = \"connected\";\n      state.gameId = payload;\n      state.hosting = true;\n    });\n    builder.addCase(host.rejected, (state, _) => {\n      state.status = \"offline\";\n    });\n  },\n});\n\nexport function shared<S, A>(\n  f: (state: S, action: PayloadAction<A>) => void\n): {\n  reducer: (state: any, action: PayloadAction<A>) => void;\n  prepare: (action: A) => any;\n} {\n  return {\n    reducer: f as any,\n    prepare: (a) => ({\n      payload: a,\n      meta: state.conn\n        ? {\n            shared: true,\n            src: state.conn.id,\n          }\n        : {},\n    }),\n  };\n}\n\nexport default comms.reducer;\n","import { RootStore } from \"../store\";\n\nexport function syncAction(state: RootStore) {\n  return {\n    type: \"STATE_SYNC\",\n    payload: {\n      game: state.game,\n      players: state.players,\n    },\n  };\n}\n\nexport function applySync(\n  state: RootStore,\n  action: ReturnType<typeof syncAction>\n): RootStore {\n  return {\n    ...state,\n    game: action.payload.game,\n    players: action.payload.players,\n  };\n}\n","import React, { PropsWithChildren, useContext, useRef } from \"react\";\nimport { useDispatch } from \"react-redux\";\nimport { addImage, Image } from \"../../modules/game\";\nimport useDrop from \"../util/useDrop\";\nimport { GridContext } from \"./Grid\";\n\nasync function getDataURL(file: File): Promise<string> {\n  const reader = new FileReader();\n  return new Promise((resolve, reject) => {\n    reader.onload = () => resolve(reader.result as string);\n    reader.readAsDataURL(file);\n  });\n}\n\nfunction extractURLFromHTML(html: string): string | null {\n  const parser = new DOMParser();\n  const doc = parser.parseFromString(html, \"text/html\");\n  return doc.querySelector(\"img\")?.src || null;\n}\n\n// Implements the drag and drop image functionality!\nexport function DropLayer(props: PropsWithChildren<{}>) {\n  const dropLayer = useRef<HTMLDivElement>(null);\n  const hoverHint = useRef<HTMLDivElement>(null);\n  const dispatch = useDispatch();\n  const grid = useContext(GridContext);\n\n  let [dragging, drag, dragHandlers] = useDrop(\n    dropLayer,\n    (x, y) => {\n      if (hoverHint.current) {\n        let coords = grid.client_to_grid([x, y]);\n        hoverHint.current.style.left = Math.floor(coords[0] as number) + \"em\";\n        hoverHint.current.style.top = Math.floor(coords[1] as number) + \"em\";\n      }\n    },\n    async (ev) => {\n      let coords = grid.client_to_grid([ev.clientX, ev.clientY]);\n      let dataItems = ev.dataTransfer?.items ?? [];\n      let addItem = (s: string) => {\n        console.log(s);\n        let item = {\n          id: \"\" + Math.random(),\n          loc: [Math.floor(coords[0]), Math.floor(coords[1])],\n          dim: [1, 1],\n          href: s,\n        };\n        dispatch(addImage({ map: 0, img: (item as unknown) as Image }));\n      };\n      console.log(\"DataItems\", dataItems.length);\n      for (let i = 0; i < dataItems.length; i++) {\n        console.log(dataItems[i].type);\n        if (dataItems[i].type.startsWith(\"image/\")) {\n          const dataURL = await getDataURL(dataItems[i].getAsFile()!);\n          addItem(dataURL);\n          return;\n        }\n        if (dataItems[i].type === \"text/html\") {\n          dataItems[i].getAsString((s) => addItem(extractURLFromHTML(s)!));\n          return;\n        }\n        if (dataItems[i].type === \"application/x-moz-file-promise-url\") {\n          dataItems[i].getAsString(addItem);\n          return;\n        } else if (dataItems[i].kind === \"string\") {\n          let t = dataItems[i].type;\n          dataItems[i].getAsString((s) => console.log(t, s));\n        }\n      }\n    }\n  );\n  let gridDrag: [number, number];\n  if (dragging) {\n    gridDrag = grid.client_to_grid([drag.x, drag.y]);\n  }\n\n  return (\n    <div\n      {...dragHandlers}\n      style={{\n        position: \"absolute\",\n        left: 0,\n        right: 0,\n        top: 0,\n        bottom: 0,\n      }}\n    >\n      {dragging ? (\n        <div\n          ref={hoverHint}\n          key=\"hover\"\n          style={{\n            position: \"absolute\",\n            left: Math.floor(gridDrag![0]) + \"em\",\n            top: Math.floor(gridDrag![1]) + \"em\",\n            width: \"1em\",\n            height: \"1em\",\n            background: \"#aaa\",\n          }}\n        ></div>\n      ) : null}\n      {props.children}\n    </div>\n  );\n}\n","import { useState } from \"react\";\nexport interface DragState {\n  x: number;\n  y: number;\n}\n\nexport default function useDrop(\n  ref: React.RefObject<Element | null>,\n  onDrag: (x: number, y: number) => void,\n  onDrop: (ev: DragEvent) => void\n): [boolean, DragState, any] {\n  let [dragDepth, setDragDepth] = useState(0);\n  let [dragState, setDragState] = useState({\n    x: 0,\n    y: 0,\n  });\n\n  const dropStub = (ev: DragEvent) => {\n    ev.preventDefault();\n\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth(0);\n    setDragState({\n      x,\n      y,\n    });\n    onDrop(ev);\n  };\n  const onDragEnter = (ev: DragEvent) => {\n    ev.preventDefault();\n    ev.stopPropagation();\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth((d) => d + 1);\n    setDragState({\n      x,\n      y,\n    });\n  };\n  const onDragLeave = (ev: DragEvent) => {\n    ev.preventDefault();\n    ev.stopPropagation();\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth((d) => d - 1);\n    setDragState({\n      x,\n      y,\n    });\n  };\n  const onDragOver = (ev: DragEvent) => {\n    ev.preventDefault();\n    onDrag(ev.clientX, ev.clientY);\n  };\n  return [\n    dragDepth > 0,\n    dragState,\n    {\n      onDragEnter,\n      onDragLeave,\n      onDragOver,\n      onDrop: dropStub,\n    },\n  ];\n}\n","import { motion } from \"framer-motion\";\nimport React, { forwardRef, memo, PropsWithChildren } from \"react\";\nimport { Coord, GridSpace, Offset } from \"../../modules/game/units\";\n\nexport interface GridItemProps\n  extends React.DetailedHTMLProps<\n    React.HTMLAttributes<HTMLDivElement>,\n    HTMLDivElement\n  > {\n  loc: Coord<GridSpace>;\n  dim: Offset<GridSpace>;\n  style?: Omit<\n    React.CSSProperties,\n    \"position\" | \"left\" | \"top\" | \"width\" | \"height\"\n  >;\n}\n\nexport const GridItem = memo(\n  forwardRef((props: PropsWithChildren<GridItemProps>, ref) => {\n    return (\n      <motion.div\n        {...(props as any)}\n        ref={ref}\n        style={{\n          position: \"absolute\",\n          ...props.style,\n        }}\n        initial={false}\n        transition={{ type: \"tween\", ease: \"easeOut\", duration: 0.2 }}\n        animate={{\n          left: props.loc[0] + \"em\",\n          top: props.loc[1] + \"em\",\n          width: props.dim[0] + \"em\",\n          height: props.dim[1] + \"em\",\n        }}\n      >\n        {props.children}\n      </motion.div>\n    );\n  })\n);\n","import React from \"react\";\nimport { Coord, GridSpace } from \"../../modules/game/units\";\n\nexport interface OverlayProps {\n  width: number;\n  height: number;\n  onDrop?: (coord: Coord<GridSpace>) => void;\n}\n\nconst thickness = 0.025;\nfunction Overlay(props: OverlayProps) {\n  return (\n    <svg\n      viewBox={`0 0 ${props.width + thickness} ${props.height + thickness}`}\n      style={{\n        position: \"absolute\",\n        left: `${-thickness / 2}em`,\n        top: `${-thickness / 2}em`,\n        width: `${props.width + thickness}em`,\n        height: `${props.height + thickness}em`,\n        pointerEvents: \"none\",\n        transition: \"position 2s\",\n      }}\n    >\n      <defs>\n        <pattern\n          id=\"grid\"\n          width=\"1\"\n          height=\"1\"\n          patternUnits=\"userSpaceOnUse\"\n          shapeRendering=\"geometricPrecision\"\n        >\n          <path\n            d=\"M 1 0 L 0 0 0 1\"\n            fill=\"none\"\n            stroke=\"gray\"\n            strokeWidth={thickness * 2}\n          ></path>\n        </pattern>\n      </defs>\n      <rect\n        style={{\n          pointerEvents: \"none\",\n        }}\n        x={0}\n        y={0}\n        width={props.width + thickness}\n        height={props.height + thickness}\n        fill=\"url(#grid)\"\n      ></rect>\n    </svg>\n  );\n}\nexport default React.memo(Overlay);\n","import React, {\n  memo,\n  useCallback,\n  useEffect,\n  useLayoutEffect,\n  useRef,\n} from \"react\";\nimport { ClientSpace, Coord, coord } from \"../../modules/game/units\";\nimport { GridItem, GridItemProps } from \"./GridItem\";\n\ninterface SelectionProps extends GridItemProps {\n  onSelectionDrag: (offset: Coord<ClientSpace>) => void;\n  onSelectionDrop: (offset: Coord<ClientSpace>) => void;\n}\n\nconst handleSize = 10; //px\n\nfunction SelectionBox(props: SelectionProps) {\n  const { onSelectionDrag, onSelectionDrop } = props;\n  const initialLoc = useRef<Coord<ClientSpace> | null>(null);\n  // Represents the distance in client pixels from selection element origin to click point\n  const onPointerMove = useCallback(\n    (ev: PointerEvent) => {\n      if (!ev.isPrimary || ev.buttons !== 1) {\n        return;\n      }\n      if (!initialLoc.current) {\n        initialLoc.current = coord(ev);\n        (ev.target as any).setPointerCapture(ev.pointerId);\n      }\n      //ev.preventDefault();\n\n      onSelectionDrag(coord(ev));\n    },\n    [onSelectionDrag]\n  );\n  const onPointerUp = useCallback(\n    (ev: PointerEvent) => {\n      if (initialLoc.current !== null) {\n        ev.preventDefault();\n        ev.stopPropagation();\n        onSelectionDrop(coord(ev));\n        initialLoc.current = null;\n      }\n    },\n    [onSelectionDrop]\n  );\n\n  const itemRef = useRef<HTMLDivElement>();\n  useEffect(() => {\n    itemRef.current?.addEventListener(\n      \"touchmove\",\n      (ev) => ev.preventDefault(),\n      { passive: false }\n    );\n  }, []);\n  useLayoutEffect(() => {\n    const item = itemRef.current!;\n    const capture = true;\n    const preventDefault = (ev: any) => ev.preventDefault();\n    item.addEventListener(\"pointerdown\", preventDefault, { capture });\n    item.addEventListener(\"pointermove\", onPointerMove, { capture });\n    item.addEventListener(\"pointerup\", onPointerUp, { capture });\n    return () => {\n      item.removeEventListener(\"pointerdown\", preventDefault, { capture });\n      item.removeEventListener(\"pointermove\", onPointerMove, { capture });\n      item.removeEventListener(\"pointerup\", onPointerUp, { capture });\n    };\n  }, [onPointerMove, onPointerUp]);\n  return (\n    <GridItem\n      ref={itemRef}\n      loc={props.loc}\n      dim={props.dim}\n      style={{\n        border: \"1px solid blue\",\n        boxShadow: \"0 0 4px blue\",\n        overflow: \"visible\",\n      }}\n    >\n      <div\n        className=\"topLeft\"\n        style={{\n          position: \"absolute\",\n          left: `${-handleSize / 2}px`,\n          top: `${-handleSize / 2}px`,\n          width: `${handleSize}px`,\n          height: `${handleSize}px`,\n          background: \"blue\",\n          cursor: \"nwse-resize\",\n          border: \"1px solid white\",\n          boxSizing: \"border-box\"\n        }}\n      ></div>\n      <div\n        className=\"topRight\"\n        style={{\n          position: \"absolute\",\n          top: `${-handleSize / 2}px`,\n          right: `${-handleSize / 2}px`,\n          width: `${handleSize}px`,\n          height: `${handleSize}px`,\n          background: \"blue\",\n          cursor: \"nesw-resize\",\n          border: \"1px solid white\"\n        }}\n      ></div>\n      <div\n        className=\"botLeft\"\n        style={{\n          position: \"absolute\",\n          bottom: `${-handleSize / 2}px`,\n          left: `${-handleSize / 2}px`,\n          width: `${handleSize}px`,\n          height: `${handleSize}px`,\n          background: \"blue\",\n          cursor: \"nesw-resize\",\n          border: \"1px solid white\"\n        }}\n      ></div>\n      <div\n        className=\"botRight\"\n        style={{\n          position: \"absolute\",\n          bottom: `${-handleSize / 2}px`,\n          right: `${-handleSize / 2}px`,\n          width: `${handleSize}px`,\n          height: `${handleSize}px`,\n          background: \"blue\",\n          cursor: \"nwse-resize\",\n          border: \"1px solid white\",\n        }}\n      ></div>\n    </GridItem>\n  );\n}\n\nexport default memo(SelectionBox);\n","import { RefObject, useEffect, useRef } from \"react\";\nimport { add, sub } from \"../../modules/game/units\";\n\ntype PinchEvent = {\n  clientOrigin: [number, number];\n  scale: number;\n  preventDefault(): void;\n}\n\ntype Touch = {\n  id: number,\n  coord: [number, number]\n}\n\nfunction calcState(touches: TouchList, touch1: number, touch2: number) {\n  let found = null as [number, number] | null;\n  for (let t of touches) {\n    if (t.identifier === touch1 || t.identifier === touch2) {\n      if (found === null) {\n        found = [t.clientX, t.clientY];\n        continue;\n      }\n      const found2 = [t.clientX, t.clientY];\n      const diff = sub(found as any, found2 as any).map(Math.abs);\n      const dist = Math.abs(diff[0] + diff[1])//Math.sqrt(diff[0] ** 2 + diff[1] ** 2);\n      const center = add(found as any, found2 as any).map(n => n / 2) as [number, number];\n      return { dist, center };\n    }\n  }\n}\n\nexport function usePinch(target: RefObject<HTMLDivElement>, handlers: {\n  onPinchStart(ev: PinchEvent): void\n  onPinch(ev: PinchEvent): void\n}) {\n  const origin = useRef([0, 0] as [number, number]);\n  const touch1 = useRef(null as number | null);\n  const touch2 = useRef(null as number | null);\n  const originalDist = useRef(0);\n  useEffect(() => {\n    const onTouchStart = (ev: TouchEvent) => {\n      if (ev.touches.length === 1) {\n        touch1.current = ev.touches[0].identifier\n      }\n\n      if (ev.touches.length === 2 && touch1.current !== null && touch2.current === null) {\n        const touch = ev.touches[0].identifier === touch1.current ? ev.touches[1] : ev.touches[0];\n        touch2.current = touch.identifier;\n\n        const { center, dist } = calcState(ev.touches, touch1.current, touch2.current)!;\n        origin.current = center;\n        originalDist.current = dist;\n        handlers.onPinchStart({\n          clientOrigin: origin.current,\n          scale: 1,\n          preventDefault() {ev.preventDefault()}\n        });\n      }\n    };\n\n    const onTouchMove = (ev: TouchEvent) => {\n      if (touch1.current === null || touch2.current === null) { return; }\n      const { dist } = calcState(ev.touches, touch1.current, touch2.current)!;\n      handlers.onPinch({\n        clientOrigin: origin.current,\n        scale: dist / originalDist.current,\n        preventDefault() {ev.preventDefault()}\n      })\n    };\n\n    const onTouchEnd = (ev: TouchEvent) => {\n      let count = 0;\n      for (let t of ev.touches)\n        if (t.identifier === touch1.current || t.identifier === touch2.current) {\n          count += 1;\n        }\n      if (count !== 2) {\n        touch1.current = touch2.current = null;\n      }\n    }\n\n    const opts = { passive: false };\n    const target_curr = target.current;\n    target_curr?.addEventListener('touchstart', onTouchStart, opts);\n    target_curr?.addEventListener('touchend', onTouchEnd, opts);\n    target_curr?.addEventListener('touchmove', onTouchMove, opts);\n    return () => {\n      target_curr?.removeEventListener('touchstart', onTouchStart);\n      target_curr?.removeEventListener('touchend', onTouchEnd);\n      target_curr?.removeEventListener('touchmove', onTouchMove);\n    }\n  })\n\n}","import React, {\n  forwardRef,\n  ForwardRefRenderFunction,\n  memo,\n  MutableRefObject,\n  PropsWithChildren,\n  ReactNode,\n  useCallback,\n  useEffect,\n  useImperativeHandle,\n  useLayoutEffect,\n  useRef,\n} from \"react\";\nimport { Coord, GridSpace } from \"../../modules/game/units\";\nimport { usePinch } from \"../util/usePinch\";\n\nexport interface ViewportProps {\n  overlay?: ReactNode;\n}\n\nconst min_scale = 0.1;\nconst max_scale = 2;\nconst scroll_factor = 0.06;\n//const scrollbar_px = 15;\n\nexport interface ViewportRef {\n  clientToGrid(coord: [number, number]): Coord<GridSpace>;\n}\n\nfunction inch(px: number) {\n  return px / 96;\n}\n\nexport const ViewportElem: ForwardRefRenderFunction<\n  ViewportRef,\n  PropsWithChildren<ViewportProps>\n  > = (props, ref) => {\n    const viewport = useRef<HTMLDivElement>(null);\n    const translater = useRef<HTMLDivElement>(null);\n  const scaler = useRef<HTMLDivElement>(null);\n\n  // v_loc is not updated after creation. Do not move the viewport\n  // and expect it to work\n  const v_loc = useRef({\n    x: 0,\n    y: 0,\n  });\n  const scale = useRef(1);\n  const v_dim = useRef({\n    width: 0,\n    height: 0,\n  });\n  const c_dim = useRef({\n    width: 0,\n    height: 0,\n  });\n\n  const offset = useRef([0, 0] as [number, number]);\n\n  const manualRender = () => {\n    offset.current = [\n      Math.max(\n        0,\n        (v_dim.current.width - c_dim.current.width * scale.current) / 2\n      ),\n      Math.max(\n        0,\n        (v_dim.current.height - c_dim.current.height * scale.current) / 2\n      ),\n    ];\n    console.log(\"offset\", offset);\n    translater.current!.style.transform = `translate(${offset.current[0]}px, ${offset.current[1]}px)`;\n    translater.current!.style.fontSize = scale.current + 'in';\n    scaler.current!.style.transform = `scale(${scale.current})`;\n  };\n  const performZoom2 = useCallback(\n    (grid_pos: [number, number], proposed_delta: number) => {\n      const new_scale = Math.min(\n        max_scale,\n        Math.max(min_scale, scale.current + proposed_delta)\n      );\n      console.log(new_scale);\n      const delta = new_scale - scale.current;\n      scale.current = new_scale;\n      const left = viewport.current!.scrollLeft;\n      const top = viewport.current!.scrollTop;\n      manualRender();\n      viewport.current!.scrollTo(\n        left + grid_pos[0] * delta,\n        top + grid_pos[1] * delta\n      );\n    },\n    []\n  );\n\n  const client_to_grid = useCallback(\n    ([x, y]: [number, number]): [number, number] => {\n      const vx = x - v_loc.current.x + viewport.current!.scrollLeft;\n      const vy = y - v_loc.current.y + viewport.current!.scrollTop;\n      return [\n        (vx - offset.current[0]) / scale.current,\n        (vy - offset.current[1]) / scale.current,\n      ];\n    },\n    [offset]\n  );\n\n  useImperativeHandle(\n    ref,\n    () => ({\n      //@ts-ignore\n      clientToGrid: (...args) => {\n        return client_to_grid(...args).map(inch);\n      },\n    }),\n    [client_to_grid]\n  );\n\n  const onWheel = useCallback(\n    (ev: WheelEvent) => {\n      if (!ev.ctrlKey) return;\n      const grid_loc = client_to_grid([ev.clientX, ev.clientY]);\n      const delta = Math.max(-1, Math.min(1, -ev.deltaY)) * scroll_factor;\n      performZoom2(grid_loc, delta);\n    },\n    [performZoom2, client_to_grid]\n  );\n\n  // Set up wheel-based zooming / touchpad pinch-to-zoom on chrome and firefox\n  useEffect(() => {\n    const v = viewport.current!;\n    const prevDefault = (ev: WheelEvent) => ev.ctrlKey && ev.preventDefault();\n    v.addEventListener(\"wheel\", prevDefault, { passive: false });\n    v.addEventListener(\"wheel\", onWheel);\n    return () => {\n      v.removeEventListener(\"wheel\", prevDefault);\n      v.removeEventListener(\"wheel\", onWheel);\n    };\n  }, [onWheel]);\n\n\n  let prev_scale = useRef(0);\n    usePinch(viewport, {\n      onPinchStart(ev) {\n        ev.preventDefault();\n        prev_scale.current = ev.scale;\n      },\n      onPinch(ev) {\n        ev.preventDefault();\n        const grid_loc = client_to_grid(ev.clientOrigin);\n        const delta = (ev.scale - prev_scale.current) * 1.5;\n        prev_scale.current = ev.scale;\n        console.log(delta);\n        performZoom2(grid_loc, delta);\n      }\n    });\n  // useEffect(() => {\n  //   const v = viewport.current!;\n  //   const onGestureStart = (ev: any) => {\n  //     ev.preventDefault();\n  //     ev.stopPropagation();\n  //     prev_scale.current = ev.scale;\n  //   };\n  //   const onGestureChange = (ev: any) => {\n  //     ev.preventDefault();\n  //     ev.stopPropagation();\n  //   };\n\n  //   v.addEventListener(\"gesturestart\", onGestureStart);\n  //   v.addEventListener(\"gesturechange\", onGestureChange);\n  //   return () => {\n  //     v.removeEventListener(\"gesturestart\", onGestureStart);\n  //     v.removeEventListener(\"gesturechange\", onGestureChange);\n  //   };\n  // }, [client_to_grid, performZoom2, scale]);\n\n  useLayoutEffect(() => {\n    const rect = viewport.current!.getBoundingClientRect();\n    v_loc.current = {\n      x: rect.x,\n      y: rect.y,\n    };\n    const size_recorder = (dest: MutableRefObject<any>, name: string) =>\n      new ResizeObserver((entries) => {\n        const rect = entries.pop()!.contentRect;\n        dest.current = {\n          width: rect.width,\n          height: rect.height,\n          x: rect.x,\n          y: rect.y,\n        };\n        console.log(\"RESIZE!\" + name, dest.current);\n        manualRender();\n      });\n    const v_observer = size_recorder(v_dim, \"viewport\");\n    v_observer.observe(viewport.current!);\n    const c_observer = size_recorder(c_dim, \"canvas\");\n    c_observer.observe(scaler.current!);\n    console.log(\"Canvas: \", scaler.current!);\n    return () => {\n      v_observer.disconnect();\n      c_observer.disconnect();\n    };\n  }, []);\n\n  return (\n    <div\n      className=\"viewport\"\n      ref={viewport}\n      style={{\n        overflow: \"auto\",\n        position: \"relative\",\n        touchAction: \"pan-x pan-y\",\n      }}\n    >\n      <div\n        ref={translater} \n        style={{\n          position: \"absolute\",\n          transform: `translate(${offset.current[0]}px, ${offset.current[1]}px)`,\n        fontSize: scale.current + \"in\",\n      }}>\n      <div\n        className=\"gridsvg\"\n        ref={scaler}\n        style={{\n          position: \"absolute\",\n          fontSize: \"1in\",\n          transform: `scale(${scale})`,\n          transformOrigin: \"0 0\",\n          transition: \"transform\",\n          overflow: \"visible\",\n        }}\n      >\n        {props.children}\n        </div>\n        {props.overlay}\n        </div>\n    </div>\n  );\n};\n\nexport const Viewport = memo(forwardRef(ViewportElem));\n","import React, {\n  createContext,\n  memo,\n  PropsWithChildren,\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { moveImage, updateImage } from \"../../modules/game\";\nimport { add, coord_clamp, floor, sub } from \"../../modules/game/units\";\nimport { RootStore } from \"../../store\";\nimport { DropLayer } from \"./DropLayer\";\nimport \"./grid.css\";\nimport { GridItem } from \"./GridItem\";\nimport Overlay from \"./Overlay\";\nimport SelectionBox from \"./SelectionBox\";\nimport { Viewport, ViewportRef } from \"./Viewport\";\n\nexport interface GridProps {\n  dimensions: [number, number];\n}\n\nexport const GridContext = createContext({\n  client_to_grid(coord: [number, number]): [number, number] {\n    return [0, 0];\n  },\n});\n\nexport function Grid(props: PropsWithChildren<GridProps>) {\n  let viewport = useRef<ViewportRef>(null);\n  let dispatch = useDispatch();\n\n  let items = useSelector((state: RootStore) => state.game.maps[0].images);\n\n  let [selectionOffset, setSelectionOffset] = useState<any>(null);\n  let [selection, setSelection] = useState<string[]>([]);\n  let selection_loc = useMemo(\n    () => (selection.length > 0 ? items[selection[0]].loc : ([0, 0] as any)),\n    [items, selection]\n  );\n  const onSelectionDrag = useCallback(\n    (coord) => {\n      setSelectionOffset(\n        floor(\n          sub(\n            coord_clamp(\n              viewport.current!.clientToGrid(coord),\n              [0, 0],\n              sub(props.dimensions as any, items[selection[0]].dim)\n            ),\n            selection_loc\n          )\n        )\n      );\n    },\n    [selection_loc, props.dimensions, items, selection]\n  );\n\n  const onSelectionDrop = useCallback(\n    (coord) => {\n      dispatch(\n        updateImage({\n          map: 0,\n          id: selection[0],\n          img: {\n            loc: add(items[selection[0]].loc, selectionOffset),\n          },\n        })\n      );\n      setSelectionOffset([0, 0]);\n    },\n    [dispatch, items, selection, selectionOffset]\n  );\n\n  const onKeyPress = useCallback(\n    (ev: KeyboardEvent) => {\n      if (selection.length === 0) return;\n      const resource = { map: 0, id: selection[0] };\n      switch (ev.key) {\n        case \"ArrowRight\":\n          dispatch(moveImage({ ...resource, offset: [1, 0] }));\n          ev.preventDefault();\n          break;\n        case \"ArrowLeft\":\n          dispatch(moveImage({ ...resource, offset: [-1, 0] }));\n          ev.preventDefault();\n          break;\n        case \"ArrowUp\":\n          dispatch(moveImage({ ...resource, offset: [0, -1] }));\n          ev.preventDefault();\n          break;\n        case \"ArrowDown\":\n          dispatch(moveImage({ ...resource, offset: [0, 1] }));\n          ev.preventDefault();\n          break;\n      }\n    },\n    [dispatch, selection]\n  );\n\n  useEffect(() => {\n    document.addEventListener(\"keydown\", onKeyPress, { capture: true });\n    return () => {\n      document.removeEventListener(\"keydown\", onKeyPress, { capture: true });\n    };\n  }, [onKeyPress]);\n\n  return (\n    <div className=\"grid\">\n      <Viewport ref={viewport}\n        overlay={\n            selection.length > 0 && (\n              <SelectionBox\n                key=\"\"\n                loc={add(selectionOffset!, selection_loc) as any}\n                dim={items[selection[0]].dim}\n                onSelectionDrag={onSelectionDrag}\n                onSelectionDrop={onSelectionDrop}\n              />\n            )\n        } \n      >\n        <GridContext.Provider\n          value={{\n            get client_to_grid() {\n              return viewport.current!.clientToGrid;\n            },\n          }}\n        >\n          <div\n            style={{\n              width: props.dimensions[0] + \"in\",\n              height: props.dimensions[1] + \"in\",\n              position: \"relative\",\n            }}\n          >\n            <DropLayer>\n              {Object.values(items).map((item, i) => (\n                <GridItem\n                  id={item.id}\n                  key={item.id}\n                  loc={\n                    add(\n                      item.loc,\n                      selection.includes(item.id)\n                        ? (selectionOffset as any)\n                        : [0, 0]\n                    ) as any\n                  }\n                  dim={item.dim}\n                  tabIndex={i}\n                  onFocus={(ev) => {\n                    setSelection([item.id]);\n                    setSelectionOffset([0, 0]);\n                  }}\n                  onBlur={(ev) => {\n                    setSelection([]);\n                  }}\n                >\n                  <img\n                    onDragStart={(ev) => ev.preventDefault()}\n                    alt=\"\"\n                    src={item.href}\n                    style={{ display: \"block\", width: \"100%\", height: \"100%\" }}\n                  />\n                </GridItem>\n              ))}\n              <Overlay\n                width={props.dimensions[0]}\n                height={props.dimensions[1]}\n              />\n            </DropLayer>\n          </div>\n        </GridContext.Provider>\n      </Viewport>\n    </div>\n  );\n}\n\nexport default memo(Grid);\n","import React, { FormEvent, useCallback } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { changeName } from \"../modules/players\";\nimport { RootStore } from \"../store\";\nimport \"./JoinOverlay.css\";\n\nexport function JoinOverlay() {\n  const shouldRender = useSelector(\n    (s: RootStore) =>\n      s.comms.status === \"connected\" &&\n      s.players.data[s.comms.clientId]?.name === null\n  );\n\n  const clientId = useSelector((s: RootStore) => s.comms.clientId);\n  const dispatch = useDispatch();\n\n  const joinAsPlayer = useCallback(\n    (ev: FormEvent) => {\n      ev.preventDefault();\n      const data = new FormData(ev.nativeEvent.target as HTMLFormElement);\n      const name = data.get(\"name\") as string;\n      dispatch(changeName({ player: clientId, name }));\n    },\n    [clientId, dispatch]\n  );\n\n  if (!shouldRender) {\n    return null;\n  }\n\n  return (\n    <div id=\"join\">\n      <form\n        style={{\n          display: \"flex\",\n          flexDirection: \"column\",\n          maxWidth: \"480px\",\n          background: \"red\",\n        }}\n        onSubmit={joinAsPlayer}\n      >\n        <label htmlFor=\"name\">\n          Display Name:\n          <input name=\"name\" type=\"text\" defaultValue={\"\"}></input>\n        </label>\n        <button type=\"submit\">Join</button>\n      </form>\n    </div>\n  );\n}\n","import { AnimateSharedLayout, motion } from \"framer-motion\";\nimport React from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useSelector } from \"react-redux\";\nimport { RootStore } from \"../../store\";\nimport \"./Toast.css\";\n\nexport function ToastArea(props: {}) {\n  const toasts = useSelector((state: RootStore) => state.toast.toasts);\n  const { t } = useTranslation();\n  return (\n    <div className=\"toastArea\">\n      <AnimateSharedLayout>\n        {toasts.map((toast) => (\n          <motion.div\n            className=\"toast\"\n            initial={{ position: \"relative\", opacity: 0 }}\n            animate={{ position: \"relative\", opacity: 1 }}\n            exit={{ position: \"relative\", opacity: 0 }}\n            layout\n            key={toast.id}\n          >\n            {t(toast.msg)}\n          </motion.div>\n        ))}\n      </AnimateSharedLayout>\n    </div>\n  );\n}\n","import React from \"react\";\nimport \"./Loading.css\";\n\nexport function Loading() {\n  return (\n    <div className=\"spinner\">\n      <div className=\"double-bounce1\"></div>\n      <div className=\"double-bounce2\"></div>\n    </div>\n  );\n}\n","import React, { useEffect, useState } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { FaUserFriends } from \"react-icons/fa\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { issueToast } from \"../../modules/toast\";\nimport { RootStore } from \"../../store\";\nexport function Players() {\n  const players = useSelector((store: RootStore) =>\n    store.players.online.map((id) => store.players.data[id])\n  );\n  const [expanded, set_expanded] = useState(false);\n  const dispatch = useDispatch();\n  const { t } = useTranslation();\n  useEffect(() => {\n    if (!expanded) return undefined;\n\n    const handler = () => set_expanded(false);\n    document.addEventListener(\"click\", handler);\n    return () => {\n      document.removeEventListener(\"click\", handler);\n    };\n  }, [expanded]);\n\n  return (\n    <div\n      style={{\n        position: \"relative\",\n      }}\n      onClick={\n        expanded\n          ? (ev) => {\n              ev.stopPropagation();\n            }\n          : undefined\n      }\n    >\n      <button\n        onClick={() => set_expanded((e) => !e)}\n        style={{\n          borderBottomLeftRadius: expanded ? \"0\" : undefined,\n          borderBottomRightRadius: expanded ? \"0\" : undefined,\n          borderBottom: expanded ? \"none\" : undefined,\n        }}\n      >\n        <FaUserFriends\n          style={{ verticalAlign: \"baseline\", fontSize: \"1.25em\" }}\n        />\n        &nbsp;{players.length}&nbsp;\n      </button>\n      {expanded && (\n        <div\n          style={{\n            position: \"absolute\",\n            top: \"100%\",\n            left: \"0\",\n            background: \"white\",\n            borderLeft: \"1px solid gray\",\n            borderRight: \"1px solid gray\",\n            borderBottom: \"1px solid gray\",\n            borderTop: \"1px solid gray\",\n            borderTopRightRadius: \"5px\",\n            borderBottomRightRadius: \"5px\",\n            borderBottomLeftRadius: \"5px\",\n            borderTopLeftRadius: \"0\",\n          }}\n        >\n          {players.map((p) => (\n            <div\n              style={{\n                padding: \"0.2em\",\n              }}\n            >\n              {p.name}\n            </div>\n          ))}\n          <button\n            onClick={() => {\n              navigator.clipboard.writeText(window.location.href);\n              dispatch(issueToast(t(\"copied_to_clipboard\")));\n            }}\n          >\n            Copy Invite Link\n          </button>\n        </div>\n      )}\n    </div>\n  );\n}\n","import React, { PropsWithChildren } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { host } from \"../../modules/comms\";\nimport { RootStore } from \"../../store\";\nimport { Loading } from \"../toolkit/Loading\";\nimport { Players } from \"./Players\";\nimport \"./Toolbar.css\";\n\ninterface ToolbarProps {}\nfunction Toolbar(props: PropsWithChildren<ToolbarProps>) {\n  let comms = useSelector((state: RootStore) => state.comms);\n  let dispatch = useDispatch();\n  return (\n    <div className=\"toolbar\">\n      {comms.status === \"offline\" && (\n        <button onClick={() => dispatch(host())}>Host</button>\n      )}\n      {comms.status === \"pending\" && <Loading />}\n\n      {comms.status === \"connected\" && <Players />}\n    </div>\n  );\n}\nexport default Toolbar;\n","import React, { useState } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { host } from \"../modules/comms\";\nimport { reset, setDimensions } from \"../modules/game\";\nimport { GridSpace, Offset } from \"../modules/game/units\";\nimport { issueToast } from \"../modules/toast\";\nimport { RootStore } from \"../store\";\nimport \"./App.css\";\nimport Grid from \"./grid2/Grid\";\nimport { JoinOverlay } from \"./JoinOverlay\";\nimport { ToastArea } from \"./toasts/ToastArea\";\nimport Toolbar from \"./toolbar/Toolbar\";\nimport { Loading } from \"./toolkit/Loading\";\n\ninterface Rect {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\nfunction App() {\n  let comms = useSelector((state: RootStore) => {\n    console.log(state);\n    return state.comms;\n  });\n  let [curr_map, _set_curr_map] = useState(() => 0);\n  let dim = useSelector((state: RootStore) => [\n    state.game.maps[curr_map].width,\n    state.game.maps[curr_map].height,\n  ]);\n  let dispatch = useDispatch();\n  const { t } = useTranslation();\n\n  let players = useSelector((state: RootStore) =>\n    state.players.online.map((p) => state.players.data[p].name)\n  );\n  return (\n    <div className=\"App\">\n      <JoinOverlay />\n      <ToastArea />\n      <Grid dimensions={dim as Offset<GridSpace>} />\n      <Toolbar>\n        <button\n          onClick={() =>\n            dispatch(\n              setDimensions({\n                map: curr_map,\n                width: dim[0] + 1,\n                height: dim[1],\n              })\n            )\n          }\n        >\n          Add Column\n        </button>\n        <button\n          onClick={() =>\n            dispatch(\n              setDimensions({\n                map: curr_map,\n                width: dim[0],\n                height: dim[1] + 1,\n              })\n            )\n          }\n        >\n          Add Row\n        </button>\n        <button onClick={() => dispatch(reset({}))}>Reset</button>\n        <button onClick={() => dispatch(issueToast(t(\"hello\")))}>Say hi</button>\n        {comms.status === \"offline\" && (\n          <button onClick={() => dispatch(host())}>Host</button>\n        )}\n        {comms.status === \"pending\" && <Loading />}\n\n        {comms.hosting && `hosting: ${comms.gameId}`}\n        {players.map((p) => (\n          <p>{p || \"unknown\"}</p>\n        ))}\n      </Toolbar>\n    </div>\n  );\n}\n\nexport default App;\n","import i18n from \"i18next\";\nimport Backend from \"i18next-xhr-backend\";\nimport { initReactI18next } from \"react-i18next\";\n\ni18n\n  .use(Backend)\n  .use(initReactI18next)\n  // for all options read: https://www.i18next.com/overview/configuration-options\n  .init({\n    debug: true,\n\n    lng: \"en\",\n    fallbackLng: \"en\",\n    whitelist: [\"en\", \"de\"],\n\n    interpolation: {\n      escapeValue: false, // not needed for react as it escapes by default\n    },\n    backend: {\n      loadPath: \"/battlegrid/locales/{{lng}}/{{ns}}.json\",\n    },\n  });\n\nexport default i18n;\n","import { combineReducers, configureStore, Store } from \"@reduxjs/toolkit\";\nimport comms, { state } from \"./modules/comms\";\nimport game from \"./modules/game\";\nimport { persistState } from \"./modules/game/persist\";\nimport players from \"./modules/players\";\nimport { applySync } from \"./modules/sync\";\nimport toast from \"./modules/toast\";\nimport { Session } from \"./storage/session\";\n\nconst mainReducer = combineReducers({ comms, game, toast, players });\nexport type RootStore = ReturnType<typeof mainReducer>;\n\nconst initialState: RootStore = mainReducer(undefined, { type: \"null\" });\n\n// This \"any\" means dispatch whatever you want. Works well enough\nconst store: Store<RootStore, any> = configureStore({\n  reducer(state, action): ReturnType<typeof mainReducer> {\n    if (action.type === \"STATE_SYNC\") {\n      return applySync(state!, action as any);\n    }\n    return mainReducer(state, action);\n  },\n  middleware: (m) =>\n    m().prepend((api) => (next) => (action) => {\n      // Send out all actions that originated on this peer\n      // if we didn't check that it came from this peer, we'd\n      // bounce messages back and forth forever\n      console.log(\"connection?\", state.conn);\n      state.conn &&\n        action.meta?.shared &&\n        action.meta?.src === state.conn.id &&\n        state.conn.send(action);\n      return next(action);\n    }),\n  preloadedState: initialState,\n});\n\nstore.subscribe(() => {\n  const state = store.getState() as RootStore;\n  console.log(state);\n  persistState(state.game.id, state.game);\n  Session.set(\"players\", state.players.data);\n});\nexport default store;\n","import { GameState } from \".\";\n\nexport function gameState(id: string) {\n  const item = sessionStorage.getItem(id);\n  return item ? JSON.parse(item) : null;\n}\n\nexport function persistState(id: string, state: GameState) {\n  sessionStorage.setItem(id, JSON.stringify(state));\n}\n","import React, { Suspense } from \"react\";\nimport ReactDOM from \"react-dom\";\nimport { Provider } from \"react-redux\";\nimport App from \"./components/App\";\nimport \"./i18n\";\nimport \"./index.css\";\nimport { connect, host } from \"./modules/comms\";\nimport { PeerID } from \"./modules/comms/peer\";\nimport { loadGame } from \"./modules/game\";\nimport { gameState } from \"./modules/game/persist\";\nimport { Session } from \"./storage/session\";\nimport store from \"./store\";\n//import * as serviceWorker from './serviceWorker';\n\nconst urlParams = new URLSearchParams(window.location.search);\n\n// Load the game if we have it stored\nconst game = urlParams.get(\"game\");\nlet state = gameState(game ?? \"local\");\n\n// If we found saved data\nif (game) {\n  console.log(\"Found game: \", game);\n  if (Session.get(\"was_hosting\") === game) {\n    console.log(\"REHOSTING!\");\n    if (state) {\n      store.dispatch(loadGame(state));\n    }\n    Session.get(\"players\");\n    store.dispatch(host());\n  } else {\n    console.log(\"Huh\");\n    store.dispatch(connect(game as PeerID));\n  }\n} else if (state) {\n  store.dispatch(loadGame(state));\n}\n\nReactDOM.render(\n  <React.StrictMode>\n    <Suspense fallback={null}>\n      <Provider store={store}>\n        <App />\n      </Provider>\n    </Suspense>\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\n//serviceWorker.unregister();\n"],"sourceRoot":""}