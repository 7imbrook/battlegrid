(this.webpackJsonpbattlegrid=this.webpackJsonpbattlegrid||[]).push([[0],{35:function(e,t,n){e.exports=n(59)},40:function(e,t,n){},41:function(e,t,n){},42:function(e,t,n){},50:function(e,t){function n(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}n.keys=function(){return[]},n.resolve=n,e.exports=n,n.id=50},51:function(e,t,n){},52:function(e,t,n){},58:function(e,t,n){},59:function(e,t,n){"use strict";n.r(t);var r=n(0),a=n.n(r),c=n(16),o=n.n(c),i=(n(40),n(41),n(3)),s=n(10);function u(e){return[e.clientX,e.clientY]}function l(e){return e.map(Math.floor)}function d(e,t){return[e[0]+t[0],e[1]+t[1]]}function f(e,t,n){return Math.min(n,Math.max(t,e))}var p=a.a.memo((function(e){return a.a.createElement("div",{style:{position:"absolute",left:"".concat(-.025,"em"),right:"".concat(-.025,"em"),top:"".concat(-.025,"em"),bottom:"".concat(-.025,"em"),background:"\n      repeating-linear-gradient(to right, ".concat("gray",", ").concat("gray"," ").concat(.05,"em, transparent ").concat(.05,"em 1em),\n      repeating-linear-gradient(to bottom, ").concat("gray",", ").concat("gray"," ").concat(.05,"em, transparent ").concat(.05,"em 1em)"),pointerEvents:"none",borderRight:"".concat(.05,"em solid ").concat("gray"),borderBottom:"".concat(.05,"em solid ").concat("gray"),transition:"position 2s"}})})),m=(n(42),n(23)),v=Object(r.memo)(Object(r.forwardRef)((function(e,t){var n=Object(r.useRef)(null),c=Object(r.useRef)(null),o=Object(r.useRef)({scale:1,offset:[0,0]}),s=function(t){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=t(o.current),c=[f(a.offset[0],0,e.width),f(a.offset[1],0,e.height)];o.current={scale:a.scale,offset:c},r&&(n.current.style.fontSize="".concat(o.current.scale*e.baseScalar).concat(e.baseUnit),n.current.scrollTo(96*o.current.offset[0]*o.current.scale,o.current.offset[1]*o.current.scale*96))},u=Object(r.useRef)(1),l=Object(m.a)({onPinchEnd:function(){u.current=o.current.scale},onPinch:function(e){var t,n,r;null===(t=e.event)||void 0===t||t.preventDefault(),null===(n=e.event)||void 0===n||n.stopPropagation();var a,c=null===(r=e.event)||void 0===r?void 0:r.deltaY,i=e.origin||[e.event.clientX,e.event.clientY],l=d(i);if(c){var p=-1*c*.05*o.current.scale;a=o.current.scale+p}else a=e.da[0]/e.initial[0]-1+u.current;!function(e,t,n){var r=f(n-t,-.05,.05);(n=f(t+r,.2,2))!==t&&s((function(a){return{scale:n,offset:[a.offset[0]-(a.offset[0]-e[0])*r/t,a.offset[1]-(a.offset[1]-e[1])*r/t]}}))}(l,o.current.scale,a)},onPinchStart:Object(r.useCallback)((function(e){var t,n;null===(t=e.event)||void 0===t||t.preventDefault(),null===(n=e.event)||void 0===n||n.stopPropagation(),u.current=o.current.scale}),[o])},{domTarget:n,eventOptions:{passive:!1,capture:!0}});Object(r.useEffect)(l,[l]);var d=function(e){var t=c.current.getBoundingClientRect();return[(e[0]-t.left)/96/o.current.scale,(e[1]-t.top)/96/o.current.scale]};Object(r.useImperativeHandle)(t,(function(){return{clientToGrid:d}}),[]);var p=Object(m.a)({onScrollEnd:function(e){s((function(e){return Object(i.a)(Object(i.a)({},e),{},{offset:[n.current.scrollLeft/96/o.current.scale,n.current.scrollTop/96/o.current.scale]})}),!1)}});return a.a.createElement("div",Object.assign({className:"viewport"},p(),{ref:n,style:{fontSize:"".concat(o.current.scale*e.baseScalar).concat(e.baseUnit)}}),a.a.createElement("div",{className:"padding"},a.a.createElement("div",{ref:c,className:"gridsvg",style:{width:"".concat(e.width,"em"),height:"".concat(e.height,"em"),position:"relative"}},e.children)))})));var h=n(14),g=Object(r.memo)(Object(r.forwardRef)((function(e,t){return a.a.createElement(h.b.div,Object.assign({},e,{ref:t,style:Object(i.a)({position:"absolute"},e.style),initial:!1,transition:{type:"tween",ease:"easeOut",duration:.2},animate:{left:e.loc[0]+"em",top:e.loc[1]+"em",width:e.dim[0]+"em",height:e.dim[1]+"em"}}),e.children)})));var b=function(e){var t=Object(r.useRef)(null),n=Object(r.useCallback)((function(n){t.current&&(n.preventDefault(),n.stopPropagation(),e.onSelectionDrag(u(n)))}),[e]),c=Object(r.useCallback)((function(n){null!==t.current&&(n.preventDefault(),n.stopPropagation(),e.onSelectionDrop(u(n)),t.current=null)}),[e]),o=Object(r.useRef)();return Object(r.useEffect)((function(){var e;null===(e=o.current)||void 0===e||e.addEventListener("touchmove",(function(e){return e.preventDefault()}))})),a.a.createElement(g,{ref:o,loc:e.loc,dim:e.dim,style:{border:"2px solid highlight",boxShadow:"0 0 10px highlight"},onPointerDown:function(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.setPointerCapture(e.pointerId),t.current=u(e)},onPointerMoveCapture:n,onPointerUpCapture:c})},O=n(8),j=n(4),y=n(21),w=n(1),E=n.n(w),S=n(2),k=n(17),D=n(13),C=(n(62),n(18)),x=n.n(C);function T(e){return N.apply(this,arguments)}function N(){return(N=Object(S.a)(E.a.mark((function e(t){var n;return E.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new x.a(t,{debug:3}),e.abrupt("return",new Promise((function(e,t){var r=function(e){c(),t("Error establishing peer: ".concat(e))},a=function(){c(),console.log("OPENING?"),e(n)},c=function(){n.off("open",a),n.off("error",r)};n.on("open",a),n.on("error",r)})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function P(e,t){return R.apply(this,arguments)}function R(){return(R=Object(S.a)(E.a.mark((function e(t,n){var r;return E.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.connect(n),e.abrupt("return",new Promise((function(e,t){var n=function(e){c(),t("Error establishing peer: ".concat(e))},a=function(){c(),e(r)},c=function(){r.off("open",a),r.off("error",n)};r.on("open",a),r.on("error",n)})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}Object({NODE_ENV:"production",PUBLIC_URL:"/battlegrid",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0}).PEERJS_ROOM_PREFIX;var I=function(){function e(t,n,r){Object(k.a)(this,e),this.dc=void 0,this.remote_id=void 0,this.config=void 0,this.dc=t,this.remote_id=n,this.config=r,this.attachListeners(this.dc)}return Object(D.a)(e,[{key:"id",get:function(){return this.dc.label}}]),Object(D.a)(e,[{key:"attachListeners",value:function(e){var t=this;this.dc.on("close",(function(){var e=function(){var n=Object(S.a)(E.a.mark((function n(){return E.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return t.config.onDisconnect(),n.prev=1,n.next=4,M(t.remote_id);case 4:t.dc=n.sent,t.attachListeners(t.dc),n.next=12;break;case 8:n.prev=8,n.t0=n.catch(1),console.log("failed to reconnect"),setTimeout(e,1e3);case 12:case"end":return n.stop()}}),n,null,[[1,8]])})));return function(){return n.apply(this,arguments)}}();e()})),this.dc.on("error",(function(){var e=function(){var n=Object(S.a)(E.a.mark((function n(){return E.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return t.config.onDisconnect(),n.prev=1,n.next=4,M(t.remote_id);case 4:t.dc=n.sent,t.attachListeners(t.dc),n.next=12;break;case 8:n.prev=8,n.t0=n.catch(1),console.log("failed to reconnect"),setTimeout(e,1e3);case 12:case"end":return n.stop()}}),n,null,[[1,8]])})));return function(){return n.apply(this,arguments)}}();e()})),this.dc.on("data",(function(e){console.log("INCOMING!"),t.config.onMessage(e)})),this.config.onConnect(this)}},{key:"send",value:function(e){this.dc.send(e)}}],[{key:"create",value:function(){var t=Object(S.a)(E.a.mark((function t(n,r){var a;return E.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,M(n);case 2:return a=t.sent,t.abrupt("return",new e(a,n,r));case 4:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}()}]),e}();function M(e){return _.apply(this,arguments)}function _(){return(_=Object(S.a)(E.a.mark((function e(t){return E.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=P,e.next=3,T();case 3:return e.t1=e.sent,e.t2=t,e.next=7,(0,e.t0)(e.t1,e.t2);case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var L=n(30),G=function(){function e(t,n,r){var a=this;Object(k.a)(this,e),this.peer=void 0,this.clients=void 0,this.id=void 0,this.peer=n,this.id=t,this.clients=new Map,this.peer.on("connection",(function(e){e.on("open",(function(){console.log("NEW CLIENT");var t=e.label;a.clients.set(t,e),r.onConnect&&r.onConnect(t),r.onDisconnect&&e.on("close",(function(){r.onDisconnect(t)})),e.on("data",(function(t){a.broadcast_json(t,e.label),r.onMessage&&r.onMessage(t)})),e.on("close",(function(){a.clients.delete(e.label)})),e.on("error",(function(){a.clients.delete(e.label)}))}))})),this.peer.on("disconnected",(function(){console.error("ACK! Disconnect from signaler.")}))}return Object(D.a)(e,[{key:"broadcast_json",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=Object(L.a)(this.clients);try{for(r.s();!(t=r.n()).done;){var a=Object(s.a)(t.value,2),c=a[0],o=a[1];c!==n&&o.send(e)}}catch(i){r.e(i)}finally{r.f()}}},{key:"send",value:function(e){this.broadcast_json(e)}},{key:"sendTo",value:function(e,t){this.clients.get(e).send(t)}}],[{key:"create",value:function(){var t=Object(S.a)(E.a.mark((function t(n,r){var a,c;return E.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=new x.a(n,{debug:3}),c=!1,t.abrupt("return",new Promise((function(t,n){a.on("open",(function(n){c=!0,t(new e(n,a,r))})),a.on("error",(function(e){c&&n("Failed to create server: ".concat(e))}))})));case 3:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}()}]),e}(),U=function(e){return new Promise((function(t){return setTimeout(t,e)}))},A=Object(j.b)("toast/issue",function(){var e=Object(S.a)(E.a.mark((function e(t,n){var r,a;return E.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.dispatch,a=Date.now(),r(F({id:Date.now(),msg:t})),e.next=5,U(5e3);case 5:r(H(a));case 6:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()),Y=Object(j.c)({name:"toast",initialState:{toasts:[]},reducers:{addToast:function(e,t){var n=t.payload;e.toasts.push(n)},removeToast:function(e,t){var n=t.payload;e.toasts=e.toasts.filter((function(e){return e.id!==n}))}}}),J=Y.reducer,X=Y.actions,F=X.addToast,H=X.removeToast;var W={conn:null},B=Object(j.b)("comms/connect",function(){var e=Object(S.a)(E.a.mark((function e(t,n){var r;return E.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.dispatch,e.prev=1,e.next=4,I.create(t,{onMessage:function(e){r(e)},onDisconnect:function(){r(z.actions.disconnected())},onConnect:function(e){r(z.actions.connected()),console.log("connected to server!")}});case 4:return W.conn=e.sent,e.abrupt("return",t);case 8:throw e.prev=8,e.t0=e.catch(1),r(A("joinFailure")),e.t0;case 12:case"end":return e.stop()}}),e,null,[[1,8]])})));return function(t,n){return e.apply(this,arguments)}}()),K=Object(j.b)("comms/host",function(){var e=Object(S.a)(E.a.mark((function e(t,n){var r,a,c,o;return E.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.getState,c=n.dispatch,e.next=3,G.create(t,{onConnect:function(e){o.sendTo(e,{type:"STATE_SYNC",payload:{game:a().game}})},onMessage:function(e){c(e)}});case 3:return o=e.sent,W.conn=o,c(ce(Object(i.a)(Object(i.a)({},a().game),{},{id:o.id}))),sessionStorage.setItem("hosting",JSON.stringify([].concat(Object(y.a)(JSON.parse(null!==(r=sessionStorage.getItem("hosting"))&&void 0!==r?r:"[]")),[o.id]))),window.history.pushState({},"","?game=".concat(o.id)),e.abrupt("return",o.id);case 9:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()),z=Object(j.c)({name:"comms",initialState:{status:"offline",hosting:!1,gameId:null},reducers:{disconnected:function(e,t){e.status="pending"},connected:function(e,t){e.status="connected"}},extraReducers:function(e){e.addCase(B.pending,(function(e,t){e.status="pending"})),e.addCase(B.fulfilled,(function(e,t){var n=t.payload;e.gameId=n,e.status="connected"})),e.addCase(B.rejected,(function(e,t){e.status="offline"})),e.addCase(K.pending,(function(e,t){e.status="pending"})),e.addCase(K.fulfilled,(function(e,t){var n=t.payload;e.status="connected",e.gameId=n,e.hosting=!0})),e.addCase(K.rejected,(function(e,t){e.status="offline"}))}});function V(e){return{reducer:e,prepare:function(e){return{payload:e,meta:W.conn?{shared:!0,src:W.conn.id}:{}}}}}var q=z.reducer,Q={id:"local",width:15,height:10,images:{}},Z=Object(j.c)({name:"game",initialState:Q,reducers:{loadGame:function(e,t){return t.payload},setDimensions:V((function(e,t){var n=t.payload;e.width=n.width,e.height=n.height})),addImage:V((function(e,t){e.images[t.payload.id]=t.payload})),updateImage:V((function(e,t){e.images[t.payload.id]=t.payload.img})),reset:V((function(e,t){return Q}))}}),$=Z.reducer,ee=Z.actions,te=ee.setDimensions,ne=ee.addImage,re=ee.updateImage,ae=ee.reset,ce=ee.loadGame;var oe=Object(r.memo)((function(e){var t,n=Object(r.useRef)(null),c=Object(r.useRef)(null),o=Object(r.useState)(null),u=Object(s.a)(o,2),f=u[0],m=u[1],h=Object(r.useRef)(null),j=Object(r.useRef)(null),y=Object(O.c)((function(e){return e.game.images})),w=Object(O.b)(),E=function(e,t,n){var a=Object(r.useState)(0),c=Object(s.a)(a,2),o=c[0],i=c[1],u=Object(r.useState)({x:0,y:0}),l=Object(s.a)(u,2),d=l[0],f=l[1];return[o>0,d,{onDragEnter:function(e){e.preventDefault(),e.stopPropagation();var t=[e.clientX,e.clientY],n=t[0],r=t[1];i((function(e){return e+1})),f({x:n,y:r})},onDragLeave:function(e){e.preventDefault(),e.stopPropagation();var t=[e.clientX,e.clientY],n=t[0],r=t[1];i((function(e){return e-1})),f({x:n,y:r})},onDragOver:function(e){e.preventDefault(),t(e.clientX,e.clientY)},onDrop:function(e){e.preventDefault();var t=[e.clientX,e.clientY],r=t[0],a=t[1];i(0),f({x:r,y:a}),n(e)}}]}(0,(function(e,t){if(j.current){var n=h.current.clientToGrid([e,t]);j.current.style.left=Math.floor(n[0])+"em",j.current.style.top=Math.floor(n[1])+"em"}}),(function(e){var t,n,r=h.current.clientToGrid([e.clientX,e.clientY]),a=null!==(t=null===(n=e.dataTransfer)||void 0===n?void 0:n.items)&&void 0!==t?t:[],c=function(e,t){console.log(e);var n={id:""+Math.random(),loc:[Math.floor(r[0])+t,Math.floor(r[1])],dim:[1,1],href:e};w(ne(n))};console.log("DataItems",a.length);for(var o=0;o<a.length;o++)a[o].kind.startsWith("image/")?c(window.URL.createObjectURL(a[o].getAsFile()),0):"text/uri-list"===a[o].type&&a[o].getAsString((function(e){return c(e,0)}))})),S=Object(s.a)(E,3),k=S[0],D=S[1],C=S[2];return k&&(t=h.current.clientToGrid([D.x,D.y])),a.a.createElement("div",Object.assign({className:"grid"},C,{ref:n}),a.a.createElement(v,{ref:h,baseScalar:1,baseUnit:"in",width:e.dimensions[0],height:e.dimensions[1]},k?a.a.createElement("div",{ref:j,key:"hover",style:{position:"absolute",left:Math.floor(t[0])+"em",top:Math.floor(t[1])+"em",width:"1em",height:"1em",background:"#aaa"}}):null,Object.values(y).map((function(e){var t;return a.a.createElement(g,{key:e.id,loc:d(e.loc,(null===(t=c.current)||void 0===t?void 0:t.id)===e.id?f:[0,0]),dim:e.dim,onClick:function(){c.current=e,m([0,0])}},a.a.createElement("img",{onDragStart:function(e){return e.preventDefault()},alt:"",src:e.href,style:{display:"block",width:"100%",height:"100%"}}))})),a.a.createElement(p,{width:e.dimensions[0],height:e.dimensions[1]}),c.current&&a.a.createElement(b,{key:"",loc:d(f,c.current.loc),dim:c.current.dim,onSelectionDrag:function(e){return m(l((t=h.current.clientToGrid(e),n=c.current.loc,[t[0]-n[0],t[1]-n[1]])));var t,n},onSelectionDrop:function(e){var t=l(h.current.clientToGrid(e));w(re({id:c.current.id,img:Object(i.a)(Object(i.a)({},y[c.current.id]),{},{loc:t})})),m(null),c.current=null}})))}));n(51);var ie=function(e){return a.a.createElement("div",{className:"toolbar"},e.children)},se=(n(52),n(63));function ue(e){var t=Object(O.c)((function(e){return e.toast.toasts})),n=Object(se.a)().t;return a.a.createElement("div",{className:"toastArea"},a.a.createElement(h.a,null,t.map((function(e){return a.a.createElement(h.b.div,{className:"toast",initial:{position:"relative",opacity:0},animate:{position:"relative",opacity:1},exit:{position:"relative",opacity:0},layout:!0,key:e.id},n(e.msg))}))))}n(58);function le(){return a.a.createElement("div",{className:"spinner"},a.a.createElement("div",{className:"double-bounce1"}),a.a.createElement("div",{className:"double-bounce2"}))}var de=function(){var e=Object(O.c)((function(e){return console.log(e),e.comms})),t=Object(O.c)((function(e){return[e.game.width,e.game.height]})),n=Object(O.b)(),r=Object(se.a)().t;return a.a.createElement("div",{className:"App"},a.a.createElement(ue,null),a.a.createElement(oe,{dimensions:t}),a.a.createElement(ie,null,a.a.createElement("button",{onClick:function(){return n(te({width:t[0]+1,height:t[1]}))}},"Add Column"),a.a.createElement("button",{onClick:function(){return n(te({width:t[0],height:t[1]+1}))}},"Add Row"),a.a.createElement("button",{onClick:function(){return n(ae({}))}},"Reset"),a.a.createElement("button",{onClick:function(){return n(A(r("hello")))}},"Say hi"),"offline"===e.status&&a.a.createElement("button",{onClick:function(){return n(K())}},"Host"),"pending"===e.status&&a.a.createElement(le,null),e.hosting&&"hosting: ".concat(e.gameId)),"pending"===e.status&&a.a.createElement("div",{className:"loading"}))},fe=n(7);var pe=Object(fe.c)({comms:q,game:$,toast:J}),me=pe(void 0,{type:"null"}),ve=Object(j.a)({reducer:function(e,t){return"STATE_SYNC"===t.type?function(e,t){return Object(i.a)(Object(i.a)({},e),{},{game:t.payload.game})}(e,t):pe(e,t)},middleware:function(e){return[].concat(Object(y.a)(e()),[function(e){return function(e){return function(t){var n,r,a;return console.log("connection?",W.conn),W.conn&&(null===(n=t.meta)||void 0===n?void 0:n.shared)&&(null===(r=t.meta)||void 0===r?void 0:r.src)===(null===(a=W.conn)||void 0===a?void 0:a.id)&&W.conn.send(t),e(t)}}}])},preloadedState:me});ve.subscribe((function(){var e=ve.getState();!function(e,t){sessionStorage.setItem(e,JSON.stringify(t))}(e.game.id,e.game)}));var he=ve,ge=n(26),be=n(15),Oe=n(34);ge.a.use(Oe.a).use(be.e).init({debug:!0,lng:"en",fallbackLng:"en",whitelist:["en","de"],interpolation:{escapeValue:!1},backend:{loadPath:"/battlegrid/locales/{{lng}}/{{ns}}.json"}});ge.a;var je,ye=new URLSearchParams(window.location.search).get("game"),we=function(e){var t=sessionStorage.getItem(e);return t?JSON.parse(t):null}(null!==ye&&void 0!==ye?ye:"local");ye&&(console.log("Found game: ",ye),we&&JSON.parse(null!==(je=sessionStorage.getItem("hosting"))&&void 0!==je?je:"[]").includes(ye)?(console.log("REHOSTING!"),he.dispatch(ce(we)),he.dispatch(K(ye))):(console.log("Huh"),he.dispatch(B(ye))));o.a.render(a.a.createElement(a.a.StrictMode,null,a.a.createElement(r.Suspense,{fallback:null},a.a.createElement(O.a,{store:he},a.a.createElement(de,null)))),document.getElementById("root"))}},[[35,1,2]]]);
//# sourceMappingURL=main.961de367.chunk.js.map