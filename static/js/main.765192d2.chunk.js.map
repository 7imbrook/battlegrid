{"version":3,"sources":["../node_modules/peerjs/dist sync","storage/session.ts","modules/game/index.ts","modules/players.ts","modules/toast.ts","modules/comms/peer.ts","modules/comms/client2.ts","modules/comms/server.ts","modules/comms/index.ts","modules/sync.ts","modules/game/units.ts","components/grid2/GridItem.tsx","components/grid2/Overlay.tsx","components/grid2/SelectionBox.tsx","components/grid2/Viewport.tsx","components/grid2/Grid.tsx","components/util/useDrop.ts","components/JoinOverlay.tsx","components/toasts/ToastArea.tsx","components/toolkit/Loading.tsx","components/toolbar/Players.tsx","components/toolbar/Toolbar.tsx","components/App.tsx","i18n.ts","store.ts","modules/game/persist.ts","index.tsx"],"names":["webpackEmptyContext","req","e","Error","code","keys","resolve","module","exports","id","defaults","was_hosting","comms_id","uuid","players","Session","key","item","sessionStorage","getItem","JSON","parse","def","setItem","stringify","v","initialState","maps","width","height","images","game","createSlice","name","reducers","forkGame","state","action","payload","loadGame","setDimensions","shared","map","addImage","img","updateImage","reset","actions","online","data","playerJoined","push","removePlayer","filter","p","changeName","player","sleep","m","Promise","r","setTimeout","issueToast","createAsyncThunk","msg","a","dispatch","Date","now","addToast","removeToast","toast","toasts","t","process","REACT_APP_PEERJS_HOST","REACT_APP_PEERJS_PORT","create_peer","console","log","peer","Peer","debug","host","secure","port","parseInt","undefined","path","reject","on_error","cleanup","on_open","off","on","connect_peer","metadata","dc","connect","game_client","client_id","handlers","connect_data","data_conn","onConnect","keep_trying","on_first_message","d","onMessage","onInitialMessage","onDisconnect","send","f","timeout","game_server","server_id","clients","Map","broadcast","exclude","label","c","conn","set","delete","onStartup","sendTo","get","gameId","getState","clientId","comms","disconnected","connected","_","server","type","window","history","pushState","status","hosting","extraReducers","builder","addCase","pending","fulfilled","rejected","reducer","prepare","meta","src","coord","ev","clientX","clientY","floor","Math","add","b","GridItem","memo","forwardRef","props","ref","div","style","position","initial","transition","ease","duration","animate","left","loc","top","dim","children","React","viewBox","pointerEvents","patternUnits","shapeRendering","fill","stroke","strokeWidth","thickness","x","y","SelectionBox","initialLoc","useRef","onPointerMove","useCallback","current","stopPropagation","onSelectionDrag","onPointerUp","preventDefault","onSelectionDrop","itemRef","useEffect","addEventListener","passive","border","boxShadow","onPointerDown","currentTarget","setPointerCapture","pointerId","onPointerMoveCapture","onPointerUpCapture","inch","px","Viewport","viewport","canvas","v_loc","scale","v_dim","c_dim","offset","manualRender","max","transform","performZoom2","grid_pos","proposed_delta","new_scale","min","delta","scrollLeft","scrollTop","scrollTo","client_to_grid","vx","vy","useImperativeHandle","clientToGrid","onWheel","ctrlKey","grid_loc","deltaY","prevDefault","removeEventListener","prev_scale","onGestureStart","onGestureChange","useLayoutEffect","rect","getBoundingClientRect","size_recorder","dest","ResizeObserver","entries","pop","contentRect","v_observer","observe","c_observer","disconnect","className","overflow","touchAction","fontSize","transformOrigin","getDataURL","file","reader","FileReader","onload","result","readAsDataURL","extractURLFromHTML","html","DOMParser","parseFromString","querySelector","gridDrag","dropLayer","selection","useState","selectionOffset","setSelectionOffset","hoverHint","items","useSelector","useDispatch","onDrag","onDrop","dragDepth","setDragDepth","dragState","setDragState","onDragEnter","onDragLeave","onDragOver","useDrop","coords","dataItems","dataTransfer","addItem","s","random","href","length","i","startsWith","getAsFile","dataURL","getAsString","kind","dragging","drag","dragHandlers","dimensions","background","Object","values","onDragStart","alt","display","JoinOverlay","shouldRender","joinAsPlayer","FormData","nativeEvent","target","flexDirection","maxWidth","onSubmit","htmlFor","defaultValue","ToastArea","useTranslation","opacity","exit","layout","Loading","Players","store","expanded","set_expanded","handler","document","onClick","borderBottomLeftRadius","borderBottomRightRadius","borderBottom","verticalAlign","borderLeft","borderRight","borderTop","borderTopRightRadius","borderTopLeftRadius","padding","navigator","clipboard","writeText","location","Toolbar","App","curr_map","i18n","use","Backend","initReactI18next","init","lng","fallbackLng","whitelist","interpolation","escapeValue","backend","loadPath","mainReducer","combineReducers","configureStore","applySync","middleware","prepend","api","next","preloadedState","subscribe","persistState","URLSearchParams","search","gameState","ReactDOM","render","StrictMode","fallback","getElementById"],"mappings":"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","file":"static/js/main.765192d2.chunk.js","sourcesContent":["function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = function() { return []; };\nwebpackEmptyContext.resolve = webpackEmptyContext;\nmodule.exports = webpackEmptyContext;\nwebpackEmptyContext.id = 43;","import { v4 as uuid } from \"uuid\";\nimport { Player } from \"../modules/players\";\n\n// Provides a strongly-typed interface to our session variables\n\nconst defaults = {\n  // Denotes whether the user is currently hosting\n  was_hosting: () => null as null | string,\n  // Denote the session-specific comms_id\n  comms_id: uuid,\n  // The player object created for this session\n  players: () => ({} as { [id: string]: Player }),\n};\n\ntype SessionMap = typeof defaults;\nexport const Session = {\n  get<K extends keyof SessionMap>(key: K): ReturnType<SessionMap[K]> {\n    const item = sessionStorage.getItem(key);\n    if (item) {\n      return JSON.parse(item);\n    }\n\n    const def = defaults[key]() as ReturnType<SessionMap[K]>;\n    sessionStorage.setItem(key, JSON.stringify(def));\n    return def;\n  },\n\n  set<K extends keyof SessionMap>(key: K, v: ReturnType<SessionMap[K]>) {\n    sessionStorage.setItem(key, JSON.stringify(v));\n  },\n};\n","import { createSlice } from \"@reduxjs/toolkit\";\nimport { shared } from \"../comms\";\nimport { Coord, GridSpace, Offset } from \"./units\";\n\nexport type Image = {\n  id: string;\n  loc: Coord<GridSpace>;\n  dim: Offset<GridSpace>;\n  href: string;\n};\nexport type GameState = typeof initialState;\nlet initialState = {\n  id: \"local\",\n  maps: [\n    {\n      width: 15,\n      height: 10,\n      images: {} as { [id: string]: Image },\n    },\n  ],\n};\nexport let game = createSlice({\n  name: \"game\",\n  initialState: initialState as typeof initialState,\n  reducers: {\n    forkGame(state, action: { payload: string }) {\n      state.id = action.payload;\n    },\n    loadGame(state, { payload }: { payload: GameState }) {\n      return payload;\n    },\n    setDimensions: shared(\n      (\n        state: any,\n        { payload }: { payload: { map: number; width: number; height: number } }\n      ) => {\n        const { map, width, height } = payload;\n        state.maps[map].width = width;\n        state.maps[map].height = height;\n      }\n    ),\n    addImage: shared(\n      (state: any, action: { payload: { map: number; img: Image } }) => {\n        const { map, img } = action.payload;\n        state.maps[map].images[img.id] = img;\n      }\n    ),\n    updateImage: shared(\n      (\n        state: GameState,\n        action: { payload: { map: number; id: string; img: Partial<Image> } }\n      ) => {\n        const { map, id, img } = action.payload;\n        state.maps[map].images[id] = { ...state.maps[map].images[id], ...img };\n      }\n    ),\n    reset: shared(\n      (state: any, action: { payload: any }) => (state = initialState)\n    ),\n  },\n});\n\nexport default game.reducer;\nexport let {\n  setDimensions,\n  addImage,\n  updateImage,\n  reset,\n  loadGame,\n  forkGame,\n} = game.actions;\n","import { createSlice, PayloadAction } from \"@reduxjs/toolkit\";\nimport { Session } from \"../storage/session\";\nimport { shared } from \"./comms\";\n\ntype PlayersState = {\n  online: string[];\n  data: { [id: string]: Player };\n};\nconst initialState = {\n  online: [],\n  data: Session.get(\"players\"),\n} as PlayersState;\n\nexport const players = createSlice({\n  name: \"players\",\n  initialState,\n  reducers: {\n    playerJoined: shared(\n      (state: PlayersState, action: PayloadAction<string>) => {\n        state.online.push(action.payload);\n        state.data[action.payload] = state.data[action.payload] || {\n          name: null,\n        };\n      }\n    ),\n    removePlayer: shared(\n      (state: PlayersState, action: PayloadAction<string>) => {\n        state.online = state.online.filter((p) => p !== action.payload);\n      }\n    ),\n    changeName: shared(\n      (\n        state: PlayersState,\n        action: PayloadAction<{ player: string; name: string }>\n      ) => {\n        state.data[action.payload.player].name = action.payload.name;\n      }\n    ),\n  },\n});\n\nexport default players.reducer;\nexport const { playerJoined, removePlayer, changeName } = players.actions;\n\nexport type Player = {\n  name: string | null;\n};\n","import { createAsyncThunk, createSlice } from \"@reduxjs/toolkit\";\n\nconst sleep = (m: number) => new Promise((r) => setTimeout(r, m));\nexport const issueToast = createAsyncThunk(\n  \"toast/issue\",\n  async (msg: string, { dispatch }) => {\n    const id = Date.now();\n    dispatch(addToast({ id: Date.now(), msg }));\n    await sleep(5000);\n    dispatch(removeToast(id));\n  }\n);\n\nexport const toast = createSlice({\n  name: \"toast\",\n  initialState: {\n    toasts: [] as { id: number; msg: string }[],\n  },\n  reducers: {\n    addToast(state, { payload }: { payload: { id: number; msg: string } }) {\n      state.toasts.push(payload);\n    },\n    removeToast(state, { payload }: { payload: number }) {\n      state.toasts = state.toasts.filter((t) => t.id !== payload);\n    },\n  },\n});\n\nexport default toast.reducer;\nexport const { addToast, removeToast } = toast.actions;\n","import Peer, { DataConnection } from \"peerjs\";\nlet { REACT_APP_PEERJS_HOST, REACT_APP_PEERJS_PORT } = process.env;\nexport type PeerID = string & { __roomId: string };\nexport async function create_peer(id?: PeerID): Promise<Peer> {\n  console.log(\"ENV??\", process.env);\n  let peer = new Peer(id, {\n    debug: 3,\n    host: REACT_APP_PEERJS_HOST,\n    secure: true,\n    port: REACT_APP_PEERJS_PORT ? parseInt(REACT_APP_PEERJS_PORT) : undefined,\n    path: \"/\",\n  });\n  return new Promise((resolve, reject) => {\n    let on_error = (e: any) => {\n      cleanup();\n      reject(`Error establishing peer: ${e}`);\n    };\n    let on_open = () => {\n      cleanup();\n      console.log(\"OPENING?\");\n      resolve(peer);\n    };\n    let cleanup = () => {\n      peer.off(\"open\", on_open);\n      peer.off(\"error\", on_error);\n    };\n    peer.on(\"open\", on_open);\n    peer.on(\"error\", on_error);\n  });\n}\n\nexport async function connect_peer(\n  peer: Peer,\n  id: PeerID,\n  metadata?: any\n): Promise<DataConnection> {\n  const dc = peer.connect(id, { metadata });\n  return new Promise((resolve, reject) => {\n    let on_error = (e: any) => {\n      cleanup();\n      reject(`Error establishing peer: ${e}`);\n    };\n    let on_open = () => {\n      cleanup();\n      resolve(dc);\n    };\n    let cleanup = () => {\n      dc.off(\"open\", on_open);\n      dc.off(\"error\", on_error);\n    };\n    dc.on(\"open\", on_open);\n    dc.on(\"error\", on_error);\n  });\n}\n","import { DataConnection } from \"peerjs\";\nimport { connect_peer, create_peer, PeerID } from \"./peer\";\nimport { ServerClient } from \"./server\";\n\nexport type ClientConfig = {\n  onDisconnect(): void;\n  onMessage(msg: any): void;\n  onInitialMessage(msg: any): void;\n  onConnect(): void;\n};\n\nexport async function game_client(\n  game: string,\n  client_id: string,\n  handlers: ClientConfig\n): Promise<ServerClient> {\n  // NOTE: the client_id is not used to construct the peer_id. clients do not need stable Peer identifiers\n  //       instead, clients are identified using the meta field on the Peer\n  let peer = await create_peer();\n  let data_conn: DataConnection;\n  async function connect_data() {\n    data_conn = await connect_peer(peer, game as PeerID, { client_id });\n    setTimeout(() => handlers.onConnect(), 0);\n    return new Promise((resolve, reject) => {\n      data_conn.on(\"error\", () => {\n        keep_trying(connect_data, 1000);\n      });\n      data_conn.on(\"close\", () => {\n        keep_trying(connect_data, 1000);\n      });\n\n      const on_first_message = (d: any) => {\n        data_conn.off(\"data\", on_first_message);\n        data_conn.on(\"data\", handlers.onMessage);\n        handlers.onInitialMessage(d);\n        resolve(d);\n      };\n      data_conn.on(\"data\", on_first_message);\n\n      data_conn.on(\"error\", () => handlers.onDisconnect());\n      data_conn.on(\"close\", () => handlers.onDisconnect());\n    });\n  }\n\n  await connect_data();\n  return {\n    id: client_id,\n    send(msg: any): void {\n      data_conn.send(msg);\n    },\n  };\n}\n\n// Waits timeout between calling f again. stops when f returns true\nfunction keep_trying(f: () => Promise<any>, timeout: number) {\n  setTimeout(async () => {\n    try {\n      await f();\n    } catch {\n      keep_trying(f, timeout);\n    }\n  }, timeout);\n}\n","import { DataConnection } from \"peerjs\";\nimport { ConnId } from \".\";\nimport { create_peer, PeerID } from \"./peer\";\n\ntype Config = {\n  onStartup(): void;\n  onConnect(player: ConnId): void;\n  onDisconnect(label: ConnId): void;\n  onMessage(msg: any): void;\n};\n\nexport interface ServerClient {\n  send(msg: any): void;\n  readonly id: string;\n}\n\nexport async function game_server(server_id: string, handlers: Config) {\n  const peer = await create_peer(server_id as PeerID);\n  const clients = new Map<string, DataConnection>();\n  const broadcast = (data: any, exclude?: string) => {\n    for (let [label, c] of clients) {\n      if (label !== exclude) c.send(data);\n    }\n  };\n\n  peer.on(\"connection\", (conn) =>\n    conn.on(\"open\", () => {\n      const client_id = conn.metadata.client_id as ConnId;\n      console.log(\"NEW CLIENT\", client_id);\n      clients.set(client_id, conn);\n\n      conn.on(\"data\", (d) => {\n        broadcast(d, client_id);\n        handlers.onMessage(d);\n      });\n      conn.on(\"close\", () => {\n        clients.delete(client_id);\n        handlers.onDisconnect(client_id as ConnId);\n      });\n      conn.on(\"error\", () => {\n        clients.delete(client_id);\n        handlers.onDisconnect(client_id as ConnId);\n      });\n\n      handlers.onConnect(conn.metadata.client_id);\n    })\n  );\n\n  handlers.onStartup();\n\n  return {\n    id: server_id,\n    send: broadcast,\n    sendTo(label: string, msg: any) {\n      clients.get(label)!.send(msg);\n    },\n  };\n}\n","import { createAsyncThunk, createSlice, PayloadAction } from \"@reduxjs/toolkit\";\nimport { Session } from \"../../storage/session\";\nimport { RootStore } from \"../../store\";\nimport { forkGame } from \"../game\";\nimport { playerJoined, removePlayer } from \"../players\";\nimport { syncAction } from \"../sync\";\nimport { issueToast } from \"../toast\";\nimport { game_client } from \"./client2\";\nimport { game_server, ServerClient } from \"./server\";\n\nexport let state = {\n  conn: null as null | ServerClient,\n};\n\nexport type ConnId = string & {\n  _connId: \"connid\";\n};\n\nexport const connect = createAsyncThunk(\n  \"comms/connect\",\n  async (gameId: string, { getState, dispatch }) => {\n    const clientId = (getState() as RootStore).comms.clientId;\n    try {\n      state.conn = await game_client(gameId, clientId, {\n        onMessage(m: any) {\n          dispatch(m);\n        },\n        onDisconnect() {\n          dispatch(comms.actions.disconnected());\n        },\n        onInitialMessage(m: any) {\n          dispatch(m);\n        },\n        onConnect() {\n          dispatch(comms.actions.connected());\n        },\n      });\n      console.log(\"connected to server!\");\n    } catch (e) {\n      dispatch(issueToast(\"joinFailure\"));\n      console.log(e);\n      throw e;\n    }\n  }\n);\n\nexport const host = createAsyncThunk(\n  \"comms/host\",\n  async (_: undefined, { getState, dispatch }) => {\n    const clientId = (getState() as RootStore).comms.clientId;\n    const server = await game_server(clientId, {\n      onConnect(player) {\n        server.sendTo(player, syncAction(getState() as any));\n        dispatch(playerJoined(player));\n      },\n      onMessage(m) {\n        dispatch(m);\n      },\n      onDisconnect(label) {\n        dispatch(removePlayer(label));\n      },\n      onStartup() {\n        dispatch(playerJoined(clientId));\n      },\n    });\n\n    state.conn = server;\n    Session.set(\"was_hosting\", server.id);\n    dispatch(forkGame(server.id));\n    window.history.pushState(null, \"\", `?game=${server.id}`);\n    return server.id;\n  }\n);\n\nexport let comms = createSlice({\n  name: \"comms\",\n  initialState: {\n    // NOTE: offline denotes a totally offline game, not a disconnected state\n    status: \"offline\" as \"offline\" | \"pending\" | \"connected\",\n    hosting: false,\n    clientId: Session.get(\"comms_id\"),\n    gameId: null as string | null,\n  },\n  reducers: {\n    disconnected(state, action: {}) {\n      state.status = \"pending\";\n    },\n    connected(state, action: {}) {\n      state.status = \"connected\";\n    },\n  },\n  extraReducers: (builder) => {\n    // Client connection logic\n    builder.addCase(connect.pending, (state, _) => {\n      state.status = \"pending\";\n    });\n    builder.addCase(connect.fulfilled, (state, payload: any) => {\n      state.gameId = payload.gameId;\n      state.status = \"connected\";\n    });\n    builder.addCase(connect.rejected, (state, _) => {\n      state.status = \"offline\";\n    });\n\n    // Hosting events\n    builder.addCase(host.pending, (state, _) => {\n      state.status = \"pending\";\n    });\n    builder.addCase(host.fulfilled, (state, { payload }) => {\n      state.status = \"connected\";\n      state.gameId = payload;\n      state.hosting = true;\n    });\n    builder.addCase(host.rejected, (state, _) => {\n      state.status = \"offline\";\n    });\n  },\n});\n\nexport function shared<S, A>(\n  f: (state: S, action: PayloadAction<A>) => void\n): {\n  reducer: (state: any, action: PayloadAction<A>) => void;\n  prepare: (action: A) => any;\n} {\n  return {\n    reducer: f as any,\n    prepare: (a) => ({\n      payload: a,\n      meta: state.conn\n        ? {\n            shared: true,\n            src: state.conn.id,\n          }\n        : {},\n    }),\n  };\n}\n\nexport default comms.reducer;\n","import { RootStore } from \"../store\";\n\nexport function syncAction(state: RootStore) {\n  return {\n    type: \"STATE_SYNC\",\n    payload: {\n      game: state.game,\n      players: state.players,\n    },\n  };\n}\n\nexport function applySync(\n  state: RootStore,\n  action: ReturnType<typeof syncAction>\n): RootStore {\n  return {\n    ...state,\n    game: action.payload.game,\n    players: action.payload.players,\n  };\n}\n","export type GridSpace = \"gridspace\";\nexport type CanvasSpace = \"canvasspace\";\nexport type ClientSpace = \"clientspace\";\n\ninterface Unit<T> {\n  _unitBrand: T;\n}\nexport type Coord<T> = [number, number] & Unit<\"coord\">;\nexport type Offset<T> = [number, number] & Unit<\"offset\">;\nexport type Pair<T> = Coord<T> | Offset<T>;\n\nexport function coord(ev: {\n  clientX: number;\n  clientY: number;\n}): Coord<ClientSpace> {\n  return [ev.clientX, ev.clientY] as Coord<ClientSpace>;\n}\n\nexport function floor<T extends [number, number]>(a: T): T {\n  return a.map(Math.floor) as T;\n}\n\nexport function trunc<T extends [number, number]>(a: T): T {\n  return a.map((n) => (n < 0 ? Math.ceil(n) : Math.floor(n))) as T;\n}\n\nexport function add<T>(a: Offset<T>, b: Offset<T>): Offset<T>;\nexport function add<T>(a: Coord<T>, b: Offset<T>): Coord<T>;\nexport function add<T>(\n  a: [number, number],\n  b: [number, number]\n): [number, number] {\n  return [a[0] + b[0], a[1] + b[1]] as any;\n}\n\nexport function sub<T>(a: Offset<T>, b: Offset<T>): Offset<T>;\nexport function sub<T>(a: Coord<T>, b: Offset<T>): Coord<T>;\nexport function sub<T>(a: Coord<T>, b: Coord<T>): Offset<T>;\nexport function sub<T>(\n  a: [number, number],\n  b: [number, number]\n): [number, number] {\n  return [a[0] - b[0], a[1] - b[1]] as any;\n}\n\nexport function clamp(val: number, min: number, max: number) {\n  return Math.min(max, Math.max(min, val));\n}\n\nexport function coord_clamp<T, P extends Pair<T>>(\n  val: P,\n  min: [number, number],\n  max: [number, number]\n): P {\n  return [\n    Math.max(min[0], Math.min(max[0], val[0])),\n    Math.max(min[1], Math.min(max[1], val[1])),\n  ] as P;\n}\n","import { motion } from \"framer-motion\";\nimport React, { forwardRef, memo, PropsWithChildren } from \"react\";\nimport { Coord, GridSpace, Offset } from \"../../modules/game/units\";\n\nexport interface GridItemProps\n  extends React.DetailedHTMLProps<\n    React.HTMLAttributes<HTMLDivElement>,\n    HTMLDivElement\n  > {\n  loc: Coord<GridSpace>;\n  dim: Offset<GridSpace>;\n  style?: Omit<\n    React.CSSProperties,\n    \"position\" | \"left\" | \"top\" | \"width\" | \"height\"\n  >;\n}\n\nexport const GridItem = memo(\n  forwardRef((props: PropsWithChildren<GridItemProps>, ref) => {\n    return (\n      <motion.div\n        {...(props as any)}\n        ref={ref}\n        style={{\n          position: \"absolute\",\n          ...props.style,\n        }}\n        initial={false}\n        transition={{ type: \"tween\", ease: \"easeOut\", duration: 0.2 }}\n        animate={{\n          left: props.loc[0] + \"em\",\n          top: props.loc[1] + \"em\",\n          width: props.dim[0] + \"em\",\n          height: props.dim[1] + \"em\",\n        }}\n      >\n        {props.children}\n      </motion.div>\n    );\n  })\n);\n","import React from \"react\";\nimport { Coord, GridSpace } from \"../../modules/game/units\";\n\nexport interface OverlayProps {\n  width: number;\n  height: number;\n  onDrop?: (coord: Coord<GridSpace>) => void;\n}\n\nconst thickness = 0.025;\nfunction Overlay(props: OverlayProps) {\n  return (\n    <svg\n      viewBox={`0 0 ${props.width + thickness} ${props.height + thickness}`}\n      style={{\n        position: \"absolute\",\n        left: `${-thickness / 2}em`,\n        top: `${-thickness / 2}em`,\n        width: `${props.width + thickness}em`,\n        height: `${props.height + thickness}em`,\n        pointerEvents: \"none\",\n        transition: \"position 2s\",\n      }}\n    >\n      <defs>\n        <pattern\n          id=\"grid\"\n          width=\"1\"\n          height=\"1\"\n          patternUnits=\"userSpaceOnUse\"\n          shapeRendering=\"geometricPrecision\"\n        >\n          <path\n            d=\"M 1 0 L 0 0 0 1\"\n            fill=\"none\"\n            stroke=\"gray\"\n            strokeWidth={thickness * 2}\n          ></path>\n        </pattern>\n      </defs>\n      <rect\n        style={{\n          pointerEvents: \"none\",\n        }}\n        x={0}\n        y={0}\n        width={props.width + thickness}\n        height={props.height + thickness}\n        fill=\"url(#grid)\"\n      ></rect>\n    </svg>\n  );\n}\nexport default React.memo(Overlay);\n","import React, { PointerEvent, useCallback, useEffect, useRef } from \"react\";\nimport { ClientSpace, Coord, coord } from \"../../modules/game/units\";\nimport { GridItem, GridItemProps } from \"./GridItem\";\n\ninterface SelectionProps extends GridItemProps {\n  onSelectionDrag: (offset: Coord<ClientSpace>) => void;\n  onSelectionDrop: (offset: Coord<ClientSpace>) => void;\n}\n\nfunction SelectionBox(props: SelectionProps) {\n  const initialLoc = useRef<Coord<ClientSpace> | null>(null);\n  // Represents the distance in client pixels from selection element origin to click point\n  const onPointerMove = useCallback(\n    (ev: PointerEvent<HTMLElement>) => {\n      console.log(\"MOVE!\");\n      if (initialLoc.current || ev.type === \"mouse\") {\n        //ev.preventDefault();\n        ev.stopPropagation();\n\n        props.onSelectionDrag(coord(ev));\n      }\n    },\n    [props]\n  );\n  const onPointerUp = useCallback(\n    (ev) => {\n      if (initialLoc.current !== null) {\n        ev.preventDefault();\n        ev.stopPropagation();\n        //(ev.currentTarget as HTMLDivElement).releasePointerCapture(ev.pointerId);\n        props.onSelectionDrop(coord(ev));\n        initialLoc.current = null;\n      }\n    },\n    [props]\n  );\n\n  const itemRef = useRef<HTMLDivElement>();\n  useEffect(() => {\n    itemRef.current?.addEventListener(\n      \"touchmove\",\n      (ev) => ev.preventDefault(),\n      { passive: false }\n    );\n  });\n  return (\n    <GridItem\n      ref={itemRef}\n      loc={props.loc}\n      dim={props.dim}\n      style={{\n        border: \"2px solid highlight\",\n        boxShadow: \"0 0 10px highlight\",\n      }}\n      onPointerDown={(ev) => {\n        console.log(\"DOWN!\");\n\n        ev.preventDefault();\n        ev.stopPropagation();\n\n        ev.currentTarget.setPointerCapture(ev.pointerId);\n        initialLoc.current = coord(ev);\n      }}\n      onPointerMoveCapture={onPointerMove}\n      onPointerUpCapture={onPointerUp}\n    ></GridItem>\n  );\n}\n\nexport default SelectionBox;\n","import React, {\n  forwardRef,\n  ForwardRefRenderFunction,\n  memo,\n  MutableRefObject,\n  PropsWithChildren,\n  useCallback,\n  useEffect,\n  useImperativeHandle,\n  useLayoutEffect,\n  useRef,\n} from \"react\";\nimport { Coord, GridSpace } from \"../../modules/game/units\";\n\nexport interface ViewportProps {}\n\nconst min_scale = 0.1;\nconst max_scale = 2;\nconst scroll_factor = 0.07;\n//const scrollbar_px = 15;\n\nexport interface ViewportRef {\n  clientToGrid(coord: [number, number]): Coord<GridSpace>;\n}\n\nfunction inch(px: number) {\n  return px / 96;\n}\n\nexport const ViewportElem: ForwardRefRenderFunction<\n  ViewportRef,\n  PropsWithChildren<ViewportProps>\n> = (props, ref) => {\n  const viewport = useRef<HTMLDivElement>(null);\n  const canvas = useRef<HTMLDivElement>(null);\n\n  // v_loc is not updated after creation. Do not move the viewport\n  // and expect it to work\n  const v_loc = useRef({\n    x: 0,\n    y: 0,\n  });\n  const scale = useRef(1);\n  const v_dim = useRef({\n    width: 0,\n    height: 0,\n  });\n  const c_dim = useRef({\n    width: 0,\n    height: 0,\n  });\n\n  const offset = useRef([0, 0] as [number, number]);\n\n  const manualRender = () => {\n    offset.current = [\n      Math.max(\n        0,\n        (v_dim.current.width - c_dim.current.width * scale.current) / 2\n      ),\n      Math.max(\n        0,\n        (v_dim.current.height - c_dim.current.height * scale.current) / 2\n      ),\n    ];\n    console.log(\"offset\", offset);\n    canvas.current!.style.transform = `translate(${offset.current[0]}px, ${offset.current[1]}px) scale(${scale.current})`;\n  };\n  const performZoom2 = useCallback(\n    (grid_pos: [number, number], proposed_delta: number) => {\n      const new_scale = Math.min(\n        max_scale,\n        Math.max(min_scale, scale.current + proposed_delta)\n      );\n      console.log(new_scale);\n      const delta = new_scale - scale.current;\n      scale.current = new_scale;\n      const left = viewport.current!.scrollLeft;\n      const top = viewport.current!.scrollTop;\n      manualRender();\n      viewport.current!.scrollTo(\n        left + grid_pos[0] * delta,\n        top + grid_pos[1] * delta\n      );\n    },\n    []\n  );\n\n  const client_to_grid = useCallback(\n    ([x, y]: [number, number]): [number, number] => {\n      const vx = x - v_loc.current.x + viewport.current!.scrollLeft;\n      const vy = y - v_loc.current.y + viewport.current!.scrollTop;\n      return [\n        (vx - offset.current[0]) / scale.current,\n        (vy - offset.current[1]) / scale.current,\n      ];\n    },\n    [offset]\n  );\n\n  useImperativeHandle(\n    ref,\n    () => ({\n      //@ts-ignore\n      clientToGrid: (...args) => {\n        return client_to_grid(...args).map(inch);\n      },\n    }),\n    [client_to_grid]\n  );\n\n  const onWheel = useCallback(\n    (ev: WheelEvent) => {\n      if (!ev.ctrlKey) return;\n      const grid_loc = client_to_grid([ev.clientX, ev.clientY]);\n      const delta = Math.max(-1, Math.min(1, -ev.deltaY)) * scroll_factor;\n      performZoom2(grid_loc, delta);\n    },\n    [performZoom2, client_to_grid]\n  );\n\n  // Set up wheel-based zooming / touchpad pinch-to-zoom on chrome and firefox\n  useEffect(() => {\n    const v = viewport.current!;\n    const prevDefault = (ev: WheelEvent) => ev.ctrlKey && ev.preventDefault();\n    v.addEventListener(\"wheel\", prevDefault, { passive: false });\n    v.addEventListener(\"wheel\", onWheel);\n    return () => {\n      v.removeEventListener(\"wheel\", prevDefault);\n      v.removeEventListener(\"wheel\", onWheel);\n    };\n  }, [onWheel]);\n\n  let prev_scale = useRef(0);\n  useEffect(() => {\n    const v = viewport.current!;\n    const onGestureStart = (ev: any) => {\n      ev.preventDefault();\n      ev.stopPropagation();\n      prev_scale.current = ev.scale;\n    };\n    const onGestureChange = (ev: any) => {\n      ev.preventDefault();\n      ev.stopPropagation();\n      const grid_loc = client_to_grid([ev.clientX, ev.clientY]);\n      const delta = (ev.scale - prev_scale.current) * 2;\n      prev_scale.current = ev.scale;\n      console.log(delta);\n      performZoom2(grid_loc, delta);\n    };\n\n    v.addEventListener(\"gesturestart\", onGestureStart);\n    v.addEventListener(\"gesturechange\", onGestureChange);\n    return () => {\n      v.removeEventListener(\"gesturestart\", onGestureStart);\n      v.removeEventListener(\"gesturechange\", onGestureChange);\n    };\n  }, [client_to_grid, performZoom2, scale]);\n\n  useLayoutEffect(() => {\n    const rect = viewport.current!.getBoundingClientRect();\n    v_loc.current = {\n      x: rect.x,\n      y: rect.y,\n    };\n    const size_recorder = (dest: MutableRefObject<any>, name: string) =>\n      new ResizeObserver((entries) => {\n        const rect = entries.pop()!.contentRect;\n        dest.current = {\n          width: rect.width,\n          height: rect.height,\n          x: rect.x,\n          y: rect.y,\n        };\n        console.log(\"RESIZE!\" + name, dest.current);\n        manualRender();\n      });\n    const v_observer = size_recorder(v_dim, \"viewport\");\n    v_observer.observe(viewport.current!);\n    const c_observer = size_recorder(c_dim, \"canvas\");\n    c_observer.observe(canvas.current!);\n    console.log(\"Canvas: \", canvas.current!);\n    return () => {\n      v_observer.disconnect();\n      c_observer.disconnect();\n    };\n  }, []);\n\n  return (\n    <div\n      className=\"viewport\"\n      ref={viewport}\n      style={{\n        overflow: \"auto\",\n        position: \"relative\",\n        touchAction: \"pan-x pan-y\",\n      }}\n    >\n      <div\n        className=\"gridsvg\"\n        ref={canvas}\n        style={{\n          position: \"absolute\",\n          fontSize: \"1in\",\n          transform: `translate(${offset.current[0]}px, ${offset.current[1]}px) scale(${scale})`,\n          transformOrigin: \"0 0\",\n          transition: \"transform\",\n        }}\n      >\n        {props.children}\n      </div>\n    </div>\n  );\n};\n\nexport const Viewport = memo(forwardRef(ViewportElem));\n","import React, { memo, PropsWithChildren, useRef, useState } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { addImage, Image, updateImage } from \"../../modules/game\";\nimport { add, Coord, floor, GridSpace, sub } from \"../../modules/game/units\";\nimport { RootStore } from \"../../store\";\nimport useDrop from \"../util/useDrop\";\nimport \"./grid.css\";\nimport { GridItem } from \"./GridItem\";\nimport Overlay from \"./Overlay\";\nimport SelectionBox from \"./SelectionBox\";\nimport { Viewport, ViewportRef } from \"./Viewport\";\n\nexport interface GridProps {\n  dimensions: [number, number];\n}\n\nasync function getDataURL(file: File): Promise<string> {\n  const reader = new FileReader();\n  return new Promise((resolve, reject) => {\n    reader.onload = () => resolve(reader.result as string);\n    reader.readAsDataURL(file);\n  });\n}\n\nfunction extractURLFromHTML(html: string): string | null {\n  const parser = new DOMParser();\n  const doc = parser.parseFromString(html, \"text/html\");\n  return doc.querySelector(\"img\")?.src || null;\n}\nexport function Grid(props: PropsWithChildren<GridProps>) {\n  let dropLayer = useRef<HTMLDivElement>(null);\n  let selection = useRef<any>(null);\n  let [selectionOffset, setSelectionOffset] = useState<any>(null);\n  let viewport = useRef<ViewportRef>(null);\n  let hoverHint = useRef<HTMLDivElement>(null);\n  let items = useSelector((state: RootStore) => state.game.maps[0].images);\n  let dispatch = useDispatch();\n\n  let [dragging, drag, dragHandlers] = useDrop(\n    dropLayer,\n    (x, y) => {\n      if (hoverHint.current) {\n        let coords = viewport.current!.clientToGrid([x, y]);\n        hoverHint.current.style.left = Math.floor(coords[0] as number) + \"em\";\n        hoverHint.current.style.top = Math.floor(coords[1] as number) + \"em\";\n      }\n    },\n    async (ev) => {\n      let coords = viewport.current!.clientToGrid([ev.clientX, ev.clientY]);\n      let dataItems = ev.dataTransfer?.items ?? [];\n      let addItem = (s: string) => {\n        console.log(s);\n        let item = {\n          id: \"\" + Math.random(),\n          loc: [Math.floor(coords[0]), Math.floor(coords[1])],\n          dim: [1, 1],\n          href: s,\n        };\n        dispatch(addImage({ map: 0, img: (item as unknown) as Image }));\n      };\n      console.log(\"DataItems\", dataItems.length);\n      for (let i = 0; i < dataItems.length; i++) {\n        console.log(dataItems[i].type);\n        if (dataItems[i].type.startsWith(\"image/\")) {\n          const dataURL = await getDataURL(dataItems[i].getAsFile()!);\n          addItem(dataURL);\n          return;\n        }\n        if (dataItems[i].type === \"text/html\") {\n          dataItems[i].getAsString((s) => addItem(extractURLFromHTML(s)!));\n          return;\n        }\n        if (dataItems[i].type === \"application/x-moz-file-promise-url\") {\n          dataItems[i].getAsString(addItem);\n          return;\n        } else if (dataItems[i].kind === \"string\") {\n          let t = dataItems[i].type;\n          dataItems[i].getAsString((s) => console.log(t, s));\n        }\n      }\n    }\n  );\n  let gridDrag: Coord<GridSpace>;\n  if (dragging) {\n    gridDrag = viewport.current!.clientToGrid([drag.x, drag.y]);\n  }\n\n  return (\n    <div className=\"grid\" {...dragHandlers} ref={dropLayer}>\n      <Viewport ref={viewport}>\n        <div\n          style={{\n            width: props.dimensions[0] + \"in\",\n            height: props.dimensions[1] + \"in\",\n            position: \"relative\",\n          }}\n        >\n          {dragging ? (\n            <div\n              ref={hoverHint}\n              key=\"hover\"\n              style={{\n                position: \"absolute\",\n                left: Math.floor(gridDrag![0]) + \"em\",\n                top: Math.floor(gridDrag![1]) + \"em\",\n                width: \"1em\",\n                height: \"1em\",\n                background: \"#aaa\",\n              }}\n            ></div>\n          ) : null}\n          {Object.values(items).map((i) => (\n            <GridItem\n              key={i.id}\n              loc={\n                add(\n                  i.loc,\n                  selection.current?.id === i.id\n                    ? (selectionOffset as any)\n                    : [0, 0]\n                ) as any\n              }\n              dim={i.dim}\n              onPointerDown={(ev) => {\n                ev.preventDefault();\n                selection.current = i;\n                setSelectionOffset([0, 0]);\n              }}\n            >\n              <img\n                onDragStart={(ev) => ev.preventDefault()}\n                alt=\"\"\n                src={i.href}\n                style={{ display: \"block\", width: \"100%\", height: \"100%\" }}\n              />\n            </GridItem>\n          ))}\n          <Overlay width={props.dimensions[0]} height={props.dimensions[1]} />\n          {selection.current && (\n            <SelectionBox\n              key=\"\"\n              loc={add(selectionOffset!, selection.current.loc) as any}\n              dim={selection.current.dim}\n              onSelectionDrag={(coord) =>\n                setSelectionOffset(\n                  floor(\n                    sub(\n                      viewport.current!.clientToGrid(coord),\n                      selection.current.loc\n                    )\n                  )\n                )\n              }\n              onSelectionDrop={(coord) => {\n                const loc = floor(viewport.current!.clientToGrid(coord));\n                dispatch(\n                  updateImage({\n                    map: 0,\n                    id: selection.current.id,\n                    img: {\n                      loc,\n                    },\n                  })\n                );\n                setSelectionOffset(null);\n                selection.current = null;\n              }}\n            />\n          )}\n        </div>\n      </Viewport>\n    </div>\n  );\n}\n\nexport default memo(Grid);\n","import { useState } from \"react\";\nexport interface DragState {\n  x: number;\n  y: number;\n}\n\nexport default function useDrop(\n  ref: React.RefObject<Element | null>,\n  onDrag: (x: number, y: number) => void,\n  onDrop: (ev: DragEvent) => void\n): [boolean, DragState, any] {\n  let [dragDepth, setDragDepth] = useState(0);\n  let [dragState, setDragState] = useState({\n    x: 0,\n    y: 0,\n  });\n\n  const dropStub = (ev: DragEvent) => {\n    ev.preventDefault();\n\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth(0);\n    setDragState({\n      x,\n      y,\n    });\n    onDrop(ev);\n  };\n  const onDragEnter = (ev: DragEvent) => {\n    ev.preventDefault();\n    ev.stopPropagation();\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth((d) => d + 1);\n    setDragState({\n      x,\n      y,\n    });\n  };\n  const onDragLeave = (ev: DragEvent) => {\n    ev.preventDefault();\n    ev.stopPropagation();\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth((d) => d - 1);\n    setDragState({\n      x,\n      y,\n    });\n  };\n  const onDragOver = (ev: DragEvent) => {\n    ev.preventDefault();\n    onDrag(ev.clientX, ev.clientY);\n  };\n  return [\n    dragDepth > 0,\n    dragState,\n    {\n      onDragEnter,\n      onDragLeave,\n      onDragOver,\n      onDrop: dropStub,\n    },\n  ];\n}\n","import React, { FormEvent, useCallback } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { changeName } from \"../modules/players\";\nimport { RootStore } from \"../store\";\nimport \"./JoinOverlay.css\";\n\nexport function JoinOverlay() {\n  const shouldRender = useSelector(\n    (s: RootStore) =>\n      s.comms.status === \"connected\" &&\n      s.players.data[s.comms.clientId]?.name === null\n  );\n\n  const clientId = useSelector((s: RootStore) => s.comms.clientId);\n  const dispatch = useDispatch();\n\n  const joinAsPlayer = useCallback(\n    (ev: FormEvent) => {\n      ev.preventDefault();\n      const data = new FormData(ev.nativeEvent.target as HTMLFormElement);\n      const name = data.get(\"name\") as string;\n      dispatch(changeName({ player: clientId, name }));\n    },\n    [clientId, dispatch]\n  );\n\n  if (!shouldRender) {\n    return null;\n  }\n\n  return (\n    <div id=\"join\">\n      <form\n        style={{\n          display: \"flex\",\n          flexDirection: \"column\",\n          maxWidth: \"480px\",\n          background: \"red\",\n        }}\n        onSubmit={joinAsPlayer}\n      >\n        <label htmlFor=\"name\">\n          Display Name:\n          <input name=\"name\" type=\"text\" defaultValue={\"\"}></input>\n        </label>\n        <button type=\"submit\">Join</button>\n      </form>\n    </div>\n  );\n}\n","import { AnimateSharedLayout, motion } from \"framer-motion\";\nimport React from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useSelector } from \"react-redux\";\nimport { RootStore } from \"../../store\";\nimport \"./Toast.css\";\n\nexport function ToastArea(props: {}) {\n  const toasts = useSelector((state: RootStore) => state.toast.toasts);\n  const { t } = useTranslation();\n  return (\n    <div className=\"toastArea\">\n      <AnimateSharedLayout>\n        {toasts.map((toast) => (\n          <motion.div\n            className=\"toast\"\n            initial={{ position: \"relative\", opacity: 0 }}\n            animate={{ position: \"relative\", opacity: 1 }}\n            exit={{ position: \"relative\", opacity: 0 }}\n            layout\n            key={toast.id}\n          >\n            {t(toast.msg)}\n          </motion.div>\n        ))}\n      </AnimateSharedLayout>\n    </div>\n  );\n}\n","import React from \"react\";\nimport \"./Loading.css\";\n\nexport function Loading() {\n  return (\n    <div className=\"spinner\">\n      <div className=\"double-bounce1\"></div>\n      <div className=\"double-bounce2\"></div>\n    </div>\n  );\n}\n","import React, { useEffect, useState } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { FaUserFriends } from \"react-icons/fa\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { issueToast } from \"../../modules/toast\";\nimport { RootStore } from \"../../store\";\nexport function Players() {\n  const players = useSelector((store: RootStore) =>\n    store.players.online.map((id) => store.players.data[id])\n  );\n  const [expanded, set_expanded] = useState(false);\n  const dispatch = useDispatch();\n  const { t } = useTranslation();\n  useEffect(() => {\n    if (!expanded) return undefined;\n\n    const handler = () => set_expanded(false);\n    document.addEventListener(\"click\", handler);\n    return () => {\n      document.removeEventListener(\"click\", handler);\n    };\n  }, [expanded]);\n\n  return (\n    <div\n      style={{\n        position: \"relative\",\n      }}\n      onClick={\n        expanded\n          ? (ev) => {\n              ev.stopPropagation();\n            }\n          : undefined\n      }\n    >\n      <button\n        onClick={() => set_expanded((e) => !e)}\n        style={{\n          borderBottomLeftRadius: expanded ? \"0\" : undefined,\n          borderBottomRightRadius: expanded ? \"0\" : undefined,\n          borderBottom: expanded ? \"none\" : undefined,\n        }}\n      >\n        <FaUserFriends\n          style={{ verticalAlign: \"baseline\", fontSize: \"1.25em\" }}\n        />\n        &nbsp;{players.length}&nbsp;\n      </button>\n      {expanded && (\n        <div\n          style={{\n            position: \"absolute\",\n            top: \"100%\",\n            left: \"0\",\n            background: \"white\",\n            borderLeft: \"1px solid gray\",\n            borderRight: \"1px solid gray\",\n            borderBottom: \"1px solid gray\",\n            borderTop: \"1px solid gray\",\n            borderTopRightRadius: \"5px\",\n            borderBottomRightRadius: \"5px\",\n            borderBottomLeftRadius: \"5px\",\n            borderTopLeftRadius: \"0\",\n          }}\n        >\n          {players.map((p) => (\n            <div\n              style={{\n                padding: \"0.2em\",\n              }}\n            >\n              {p.name}\n            </div>\n          ))}\n          <button\n            onClick={() => {\n              navigator.clipboard.writeText(window.location.href);\n              dispatch(issueToast(t(\"copied_to_clipboard\")));\n            }}\n          >\n            Copy Invite Link\n          </button>\n        </div>\n      )}\n    </div>\n  );\n}\n","import React, { PropsWithChildren } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { host } from \"../../modules/comms\";\nimport { RootStore } from \"../../store\";\nimport { Loading } from \"../toolkit/Loading\";\nimport { Players } from \"./Players\";\nimport \"./Toolbar.css\";\n\ninterface ToolbarProps {}\nfunction Toolbar(props: PropsWithChildren<ToolbarProps>) {\n  let comms = useSelector((state: RootStore) => state.comms);\n  let dispatch = useDispatch();\n  return (\n    <div className=\"toolbar\">\n      {comms.status === \"offline\" && (\n        <button onClick={() => dispatch(host())}>Host</button>\n      )}\n      {comms.status === \"pending\" && <Loading />}\n\n      {comms.status === \"connected\" && <Players />}\n    </div>\n  );\n}\nexport default Toolbar;\n","import React, { useState } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { host } from \"../modules/comms\";\nimport { reset, setDimensions } from \"../modules/game\";\nimport { GridSpace, Offset } from \"../modules/game/units\";\nimport { issueToast } from \"../modules/toast\";\nimport { RootStore } from \"../store\";\nimport \"./App.css\";\nimport Grid from \"./grid2/Grid\";\nimport { JoinOverlay } from \"./JoinOverlay\";\nimport { ToastArea } from \"./toasts/ToastArea\";\nimport Toolbar from \"./toolbar/Toolbar\";\nimport { Loading } from \"./toolkit/Loading\";\n\ninterface Rect {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\nfunction App() {\n  let comms = useSelector((state: RootStore) => {\n    console.log(state);\n    return state.comms;\n  });\n  let [curr_map, _set_curr_map] = useState(() => 0);\n  let dim = useSelector((state: RootStore) => [\n    state.game.maps[curr_map].width,\n    state.game.maps[curr_map].height,\n  ]);\n  let dispatch = useDispatch();\n  const { t } = useTranslation();\n\n  let players = useSelector((state: RootStore) =>\n    state.players.online.map((p) => state.players.data[p].name)\n  );\n  return (\n    <div className=\"App\">\n      <JoinOverlay />\n      <ToastArea />\n      <Grid dimensions={dim as Offset<GridSpace>} />\n      <Toolbar>\n        <button\n          onClick={() =>\n            dispatch(\n              setDimensions({\n                map: curr_map,\n                width: dim[0] + 1,\n                height: dim[1],\n              })\n            )\n          }\n        >\n          Add Column\n        </button>\n        <button\n          onClick={() =>\n            dispatch(\n              setDimensions({\n                map: curr_map,\n                width: dim[0],\n                height: dim[1] + 1,\n              })\n            )\n          }\n        >\n          Add Row\n        </button>\n        <button onClick={() => dispatch(reset({}))}>Reset</button>\n        <button onClick={() => dispatch(issueToast(t(\"hello\")))}>Say hi</button>\n        {comms.status === \"offline\" && (\n          <button onClick={() => dispatch(host())}>Host</button>\n        )}\n        {comms.status === \"pending\" && <Loading />}\n\n        {comms.hosting && `hosting: ${comms.gameId}`}\n        {players.map((p) => (\n          <p>{p || \"unknown\"}</p>\n        ))}\n      </Toolbar>\n    </div>\n  );\n}\n\nexport default App;\n","import i18n from \"i18next\";\nimport Backend from \"i18next-xhr-backend\";\nimport { initReactI18next } from \"react-i18next\";\n\ni18n\n  .use(Backend)\n  .use(initReactI18next)\n  // for all options read: https://www.i18next.com/overview/configuration-options\n  .init({\n    debug: true,\n\n    lng: \"en\",\n    fallbackLng: \"en\",\n    whitelist: [\"en\", \"de\"],\n\n    interpolation: {\n      escapeValue: false, // not needed for react as it escapes by default\n    },\n    backend: {\n      loadPath: \"/battlegrid/locales/{{lng}}/{{ns}}.json\",\n    },\n  });\n\nexport default i18n;\n","import { combineReducers, configureStore, Store } from \"@reduxjs/toolkit\";\nimport comms, { state } from \"./modules/comms\";\nimport game from \"./modules/game\";\nimport { persistState } from \"./modules/game/persist\";\nimport players from \"./modules/players\";\nimport { applySync } from \"./modules/sync\";\nimport toast from \"./modules/toast\";\nimport { Session } from \"./storage/session\";\n\nconst mainReducer = combineReducers({ comms, game, toast, players });\nexport type RootStore = ReturnType<typeof mainReducer>;\n\nconst initialState: RootStore = mainReducer(undefined, { type: \"null\" });\n\n// This \"any\" means dispatch whatever you want. Works well enough\nconst store: Store<RootStore, any> = configureStore({\n  reducer(state, action): ReturnType<typeof mainReducer> {\n    if (action.type === \"STATE_SYNC\") {\n      return applySync(state!, action as any);\n    }\n    return mainReducer(state, action);\n  },\n  middleware: (m) =>\n    m().prepend((api) => (next) => (action) => {\n      // Send out all actions that originated on this peer\n      // if we didn't check that it came from this peer, we'd\n      // bounce messages back and forth forever\n      console.log(\"connection?\", state.conn);\n      state.conn &&\n        action.meta?.shared &&\n        action.meta?.src === state.conn.id &&\n        state.conn.send(action);\n      return next(action);\n    }),\n  preloadedState: initialState,\n});\n\nstore.subscribe(() => {\n  const state = store.getState() as RootStore;\n  console.log(state);\n  persistState(state.game.id, state.game);\n  Session.set(\"players\", state.players.data);\n});\nexport default store;\n","import { GameState } from \".\";\n\nexport function gameState(id: string) {\n  const item = sessionStorage.getItem(id);\n  return item ? JSON.parse(item) : null;\n}\n\nexport function persistState(id: string, state: GameState) {\n  sessionStorage.setItem(id, JSON.stringify(state));\n}\n","import React, { Suspense } from \"react\";\nimport ReactDOM from \"react-dom\";\nimport { Provider } from \"react-redux\";\nimport App from \"./components/App\";\nimport \"./i18n\";\nimport \"./index.css\";\nimport { connect, host } from \"./modules/comms\";\nimport { PeerID } from \"./modules/comms/peer\";\nimport { loadGame } from \"./modules/game\";\nimport { gameState } from \"./modules/game/persist\";\nimport { Session } from \"./storage/session\";\nimport store from \"./store\";\n//import * as serviceWorker from './serviceWorker';\n\nconst urlParams = new URLSearchParams(window.location.search);\n\n// Load the game if we have it stored\nconst game = urlParams.get(\"game\");\nlet state = gameState(game ?? \"local\");\n\n// If we found saved data\nif (game) {\n  console.log(\"Found game: \", game);\n  if (Session.get(\"was_hosting\") === game) {\n    console.log(\"REHOSTING!\");\n    if (state) {\n      store.dispatch(loadGame(state));\n    }\n    Session.get(\"players\");\n    store.dispatch(host());\n  } else {\n    console.log(\"Huh\");\n    store.dispatch(connect(game as PeerID));\n  }\n} else if (state) {\n  store.dispatch(loadGame(state));\n}\n\nReactDOM.render(\n  <React.StrictMode>\n    <Suspense fallback={null}>\n      <Provider store={store}>\n        <App />\n      </Provider>\n    </Suspense>\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\n//serviceWorker.unregister();\n"],"sourceRoot":""}