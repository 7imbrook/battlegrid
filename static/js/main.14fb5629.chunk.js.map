{"version":3,"sources":["../node_modules/peerjs/dist sync","storage/session.ts","modules/game/index.ts","modules/players.ts","modules/toast.ts","modules/comms/peer.ts","modules/comms/client2.ts","modules/comms/server.ts","modules/comms/index.ts","modules/sync.ts","modules/game/units.ts","components/grid2/GridItem.tsx","components/grid2/Overlay.tsx","components/grid2/SelectionBox.tsx","components/grid2/Viewport.tsx","components/grid2/Grid.tsx","components/util/useDrop.ts","components/JoinOverlay.tsx","components/toasts/ToastArea.tsx","components/toolbar/Toolbar.tsx","components/toolkit/Loading.tsx","components/App.tsx","i18n.ts","store.ts","modules/game/persist.ts","index.tsx"],"names":["webpackEmptyContext","req","e","Error","code","keys","resolve","module","exports","id","defaults","was_hosting","comms_id","uuid","players","Session","key","item","sessionStorage","getItem","JSON","parse","def","setItem","stringify","v","initialState","maps","width","height","images","game","createSlice","name","reducers","forkGame","state","action","payload","loadGame","setDimensions","shared","map","addImage","img","updateImage","reset","actions","online","data","playerJoined","push","removePlayer","filter","p","changeName","player","sleep","m","Promise","r","setTimeout","issueToast","createAsyncThunk","msg","a","dispatch","Date","now","addToast","removeToast","toast","toasts","t","process","REACT_APP_PEERJS_HOST","REACT_APP_PEERJS_PORT","create_peer","console","log","peer","Peer","debug","host","secure","port","parseInt","undefined","path","reject","on_error","cleanup","on_open","off","on","connect_peer","metadata","dc","connect","game_client","client_id","handlers","connect_data","data_conn","onConnect","keep_trying","on_first_message","d","onMessage","onInitialMessage","onDisconnect","send","f","timeout","game_server","server_id","clients","Map","broadcast","exclude","label","c","conn","set","delete","onStartup","sendTo","get","gameId","getState","clientId","comms","disconnected","connected","_","server","type","window","history","pushState","status","hosting","extraReducers","builder","addCase","pending","fulfilled","rejected","reducer","prepare","meta","src","coord","ev","clientX","clientY","floor","Math","add","b","clamp","val","min","max","GridItem","memo","forwardRef","props","ref","div","style","position","initial","transition","ease","duration","animate","left","loc","top","dim","children","React","viewBox","pointerEvents","patternUnits","shapeRendering","fill","stroke","strokeWidth","thickness","x","y","SelectionBox","initialLoc","useRef","onPointerMove","useCallback","current","stopPropagation","onSelectionDrag","onPointerUp","preventDefault","onSelectionDrop","itemRef","useEffect","addEventListener","passive","border","boxShadow","onPointerDown","currentTarget","setPointerCapture","pointerId","onPointerMoveCapture","onPointerUpCapture","Viewport","viewport","canvas","transform","scale","offset","setTransform","apply","newT","newOffset","fontSize","baseScalar","baseUnit","scrollTo","initialScale","pinch","useGesture","onPinchEnd","onPinch","event","newScale","deltaY","client_origin","origin","clientToGrid","delta","da","oldScale","performZoom","onPinchStart","domTarget","eventOptions","capture","rect","getBoundingClientRect","useImperativeHandle","scroll","onScrollEnd","scrollLeft","scrollTop","className","getDataURL","file","reader","FileReader","onload","result","readAsDataURL","extractURLFromHTML","html","DOMParser","parseFromString","querySelector","gridDrag","dropLayer","selection","useState","selectionOffset","setSelectionOffset","hoverHint","items","useSelector","useDispatch","onDrag","onDrop","dragDepth","setDragDepth","dragState","setDragState","onDragEnter","onDragLeave","onDragOver","useDrop","coords","dataItems","dataTransfer","addItem","s","random","href","length","i","startsWith","getAsFile","dataURL","getAsString","kind","dragging","drag","dragHandlers","dimensions","background","Object","values","onDragStart","alt","display","JoinOverlay","shouldRender","joinAsPlayer","FormData","nativeEvent","target","flexDirection","maxWidth","onSubmit","htmlFor","defaultValue","ToastArea","useTranslation","opacity","exit","layout","Toolbar","Loading","App","curr_map","onClick","i18n","use","Backend","initReactI18next","init","lng","fallbackLng","whitelist","interpolation","escapeValue","backend","loadPath","mainReducer","combineReducers","store","configureStore","applySync","middleware","prepend","api","next","preloadedState","subscribe","persistState","URLSearchParams","location","search","gameState","ReactDOM","render","StrictMode","fallback","document","getElementById"],"mappings":"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","file":"static/js/main.14fb5629.chunk.js","sourcesContent":["function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = function() { return []; };\nwebpackEmptyContext.resolve = webpackEmptyContext;\nmodule.exports = webpackEmptyContext;\nwebpackEmptyContext.id = 43;","import { v4 as uuid } from \"uuid\";\nimport { Player } from \"../modules/players\";\n\n// Provides a strongly-typed interface to our session variables\n\nconst defaults = {\n  // Denotes whether the user is currently hosting\n  was_hosting: () => null as null | string,\n  // Denote the session-specific comms_id\n  comms_id: uuid,\n  // The player object created for this session\n  players: () => ({} as { [id: string]: Player }),\n};\n\ntype SessionMap = typeof defaults;\nexport const Session = {\n  get<K extends keyof SessionMap>(key: K): ReturnType<SessionMap[K]> {\n    const item = sessionStorage.getItem(key);\n    if (item) {\n      return JSON.parse(item);\n    }\n\n    const def = defaults[key]() as ReturnType<SessionMap[K]>;\n    sessionStorage.setItem(key, JSON.stringify(def));\n    return def;\n  },\n\n  set<K extends keyof SessionMap>(key: K, v: ReturnType<SessionMap[K]>) {\n    sessionStorage.setItem(key, JSON.stringify(v));\n  },\n};\n","import { createSlice } from \"@reduxjs/toolkit\";\nimport { shared } from \"../comms\";\nimport { Coord, GridSpace, Offset } from \"./units\";\n\nexport type Image = {\n  id: string;\n  loc: Coord<GridSpace>;\n  dim: Offset<GridSpace>;\n  href: string;\n};\nexport type GameState = typeof initialState;\nlet initialState = {\n  id: \"local\",\n  maps: [\n    {\n      width: 15,\n      height: 10,\n      images: {} as { [id: string]: Image },\n    },\n  ],\n};\nexport let game = createSlice({\n  name: \"game\",\n  initialState: initialState as typeof initialState,\n  reducers: {\n    forkGame(state, action: { payload: string }) {\n      state.id = action.payload;\n    },\n    loadGame(state, { payload }: { payload: GameState }) {\n      return payload;\n    },\n    setDimensions: shared(\n      (\n        state: any,\n        { payload }: { payload: { map: number; width: number; height: number } }\n      ) => {\n        const { map, width, height } = payload;\n        state.maps[map].width = width;\n        state.maps[map].height = height;\n      }\n    ),\n    addImage: shared(\n      (state: any, action: { payload: { map: number; img: Image } }) => {\n        const { map, img } = action.payload;\n        state.maps[map].images[img.id] = img;\n      }\n    ),\n    updateImage: shared(\n      (\n        state: GameState,\n        action: { payload: { map: number; id: string; img: Partial<Image> } }\n      ) => {\n        const { map, id, img } = action.payload;\n        state.maps[map].images[id] = { ...state.maps[map].images[id], ...img };\n      }\n    ),\n    reset: shared(\n      (state: any, action: { payload: any }) => (state = initialState)\n    ),\n  },\n});\n\nexport default game.reducer;\nexport let {\n  setDimensions,\n  addImage,\n  updateImage,\n  reset,\n  loadGame,\n  forkGame,\n} = game.actions;\n","import { createSlice, PayloadAction } from \"@reduxjs/toolkit\";\nimport { Session } from \"../storage/session\";\nimport { shared } from \"./comms\";\n\ntype PlayersState = {\n  online: string[];\n  data: { [id: string]: Player };\n};\nconst initialState = {\n  online: [],\n  data: Session.get(\"players\"),\n} as PlayersState;\n\nexport const players = createSlice({\n  name: \"players\",\n  initialState,\n  reducers: {\n    playerJoined: shared(\n      (state: PlayersState, action: PayloadAction<string>) => {\n        state.online.push(action.payload);\n        state.data[action.payload] = state.data[action.payload] || {\n          name: null,\n        };\n      }\n    ),\n    removePlayer: shared(\n      (state: PlayersState, action: PayloadAction<string>) => {\n        state.online = state.online.filter((p) => p !== action.payload);\n      }\n    ),\n    changeName: shared(\n      (\n        state: PlayersState,\n        action: PayloadAction<{ player: string; name: string }>\n      ) => {\n        state.data[action.payload.player].name = action.payload.name;\n      }\n    ),\n  },\n});\n\nexport default players.reducer;\nexport const { playerJoined, removePlayer, changeName } = players.actions;\n\nexport type Player = {\n  name: string | null;\n};\n","import { createAsyncThunk, createSlice } from \"@reduxjs/toolkit\";\n\nconst sleep = (m: number) => new Promise((r) => setTimeout(r, m));\nexport const issueToast = createAsyncThunk(\n  \"toast/issue\",\n  async (msg: string, { dispatch }) => {\n    const id = Date.now();\n    dispatch(addToast({ id: Date.now(), msg }));\n    await sleep(5000);\n    dispatch(removeToast(id));\n  }\n);\n\nexport const toast = createSlice({\n  name: \"toast\",\n  initialState: {\n    toasts: [] as { id: number; msg: string }[],\n  },\n  reducers: {\n    addToast(state, { payload }: { payload: { id: number; msg: string } }) {\n      state.toasts.push(payload);\n    },\n    removeToast(state, { payload }: { payload: number }) {\n      state.toasts = state.toasts.filter((t) => t.id !== payload);\n    },\n  },\n});\n\nexport default toast.reducer;\nexport const { addToast, removeToast } = toast.actions;\n","import Peer, { DataConnection } from \"peerjs\";\nlet { REACT_APP_PEERJS_HOST, REACT_APP_PEERJS_PORT } = process.env;\nexport type PeerID = string & { __roomId: string };\nexport async function create_peer(id?: PeerID): Promise<Peer> {\n  console.log(\"ENV??\", process.env);\n  let peer = new Peer(id, {\n    debug: 3,\n    host: REACT_APP_PEERJS_HOST,\n    secure: true,\n    port: REACT_APP_PEERJS_PORT ? parseInt(REACT_APP_PEERJS_PORT) : undefined,\n    path: \"/\",\n  });\n  return new Promise((resolve, reject) => {\n    let on_error = (e: any) => {\n      cleanup();\n      reject(`Error establishing peer: ${e}`);\n    };\n    let on_open = () => {\n      cleanup();\n      console.log(\"OPENING?\");\n      resolve(peer);\n    };\n    let cleanup = () => {\n      peer.off(\"open\", on_open);\n      peer.off(\"error\", on_error);\n    };\n    peer.on(\"open\", on_open);\n    peer.on(\"error\", on_error);\n  });\n}\n\nexport async function connect_peer(\n  peer: Peer,\n  id: PeerID,\n  metadata?: any\n): Promise<DataConnection> {\n  const dc = peer.connect(id, { metadata });\n  return new Promise((resolve, reject) => {\n    let on_error = (e: any) => {\n      cleanup();\n      reject(`Error establishing peer: ${e}`);\n    };\n    let on_open = () => {\n      cleanup();\n      resolve(dc);\n    };\n    let cleanup = () => {\n      dc.off(\"open\", on_open);\n      dc.off(\"error\", on_error);\n    };\n    dc.on(\"open\", on_open);\n    dc.on(\"error\", on_error);\n  });\n}\n","import { DataConnection } from \"peerjs\";\nimport { connect_peer, create_peer, PeerID } from \"./peer\";\nimport { ServerClient } from \"./server\";\n\nexport type ClientConfig = {\n  onDisconnect(): void;\n  onMessage(msg: any): void;\n  onInitialMessage(msg: any): void;\n  onConnect(): void;\n};\n\nexport async function game_client(\n  game: string,\n  client_id: string,\n  handlers: ClientConfig\n): Promise<ServerClient> {\n  // NOTE: the client_id is not used to construct the peer_id. clients do not need stable Peer identifiers\n  //       instead, clients are identified using the meta field on the Peer\n  let peer = await create_peer();\n  let data_conn: DataConnection;\n  async function connect_data() {\n    data_conn = await connect_peer(peer, game as PeerID, { client_id });\n    setTimeout(() => handlers.onConnect(), 0);\n    return new Promise((resolve, reject) => {\n      data_conn.on(\"error\", () => {\n        keep_trying(connect_data, 1000);\n      });\n      data_conn.on(\"close\", () => {\n        keep_trying(connect_data, 1000);\n      });\n\n      const on_first_message = (d: any) => {\n        data_conn.off(\"data\", on_first_message);\n        data_conn.on(\"data\", handlers.onMessage);\n        handlers.onInitialMessage(d);\n        resolve(d);\n      };\n      data_conn.on(\"data\", on_first_message);\n\n      data_conn.on(\"error\", () => handlers.onDisconnect());\n      data_conn.on(\"close\", () => handlers.onDisconnect());\n    });\n  }\n\n  await connect_data();\n  return {\n    id: client_id,\n    send(msg: any): void {\n      data_conn.send(msg);\n    },\n  };\n}\n\n// Waits timeout between calling f again. stops when f returns true\nfunction keep_trying(f: () => Promise<any>, timeout: number) {\n  setTimeout(async () => {\n    try {\n      await f();\n    } catch {\n      keep_trying(f, timeout);\n    }\n  }, timeout);\n}\n","import { DataConnection } from \"peerjs\";\nimport { ConnId } from \".\";\nimport { create_peer, PeerID } from \"./peer\";\n\ntype Config = {\n  onStartup(): void;\n  onConnect(player: ConnId): void;\n  onDisconnect(label: ConnId): void;\n  onMessage(msg: any): void;\n};\n\nexport interface ServerClient {\n  send(msg: any): void;\n  readonly id: string;\n}\n\nexport async function game_server(server_id: string, handlers: Config) {\n  const peer = await create_peer(server_id as PeerID);\n  const clients = new Map<string, DataConnection>();\n  const broadcast = (data: any, exclude?: string) => {\n    for (let [label, c] of clients) {\n      if (label !== exclude) c.send(data);\n    }\n  };\n\n  peer.on(\"connection\", (conn) =>\n    conn.on(\"open\", () => {\n      const client_id = conn.metadata.client_id as ConnId;\n      console.log(\"NEW CLIENT\", client_id);\n      clients.set(client_id, conn);\n\n      conn.on(\"data\", (d) => {\n        broadcast(d, client_id);\n        handlers.onMessage(d);\n      });\n      conn.on(\"close\", () => {\n        clients.delete(client_id);\n        handlers.onDisconnect(client_id as ConnId);\n      });\n      conn.on(\"error\", () => {\n        clients.delete(client_id);\n        handlers.onDisconnect(client_id as ConnId);\n      });\n\n      handlers.onConnect(conn.metadata.client_id);\n    })\n  );\n\n  handlers.onStartup();\n\n  return {\n    id: server_id,\n    send: broadcast,\n    sendTo(label: string, msg: any) {\n      clients.get(label)!.send(msg);\n    },\n  };\n}\n","import { createAsyncThunk, createSlice, PayloadAction } from \"@reduxjs/toolkit\";\nimport { Session } from \"../../storage/session\";\nimport { RootStore } from \"../../store\";\nimport { forkGame } from \"../game\";\nimport { playerJoined, removePlayer } from \"../players\";\nimport { syncAction } from \"../sync\";\nimport { issueToast } from \"../toast\";\nimport { game_client } from \"./client2\";\nimport { game_server, ServerClient } from \"./server\";\n\nexport let state = {\n  conn: null as null | ServerClient,\n};\n\nexport type ConnId = string & {\n  _connId: \"connid\";\n};\n\nexport const connect = createAsyncThunk(\n  \"comms/connect\",\n  async (gameId: string, { getState, dispatch }) => {\n    const clientId = (getState() as RootStore).comms.clientId;\n    try {\n      state.conn = await game_client(gameId, clientId, {\n        onMessage(m: any) {\n          dispatch(m);\n        },\n        onDisconnect() {\n          dispatch(comms.actions.disconnected());\n        },\n        onInitialMessage(m: any) {\n          dispatch(m);\n        },\n        onConnect() {\n          dispatch(comms.actions.connected());\n        },\n      });\n      console.log(\"connected to server!\");\n    } catch (e) {\n      dispatch(issueToast(\"joinFailure\"));\n      console.log(e);\n      throw e;\n    }\n  }\n);\n\nexport const host = createAsyncThunk(\n  \"comms/host\",\n  async (_: undefined, { getState, dispatch }) => {\n    const clientId = (getState() as RootStore).comms.clientId;\n    const server = await game_server(clientId, {\n      onConnect(player) {\n        server.sendTo(player, syncAction(getState() as any));\n        dispatch(playerJoined(player));\n      },\n      onMessage(m) {\n        dispatch(m);\n      },\n      onDisconnect(label) {\n        dispatch(removePlayer(label));\n      },\n      onStartup() {\n        dispatch(playerJoined(clientId));\n      },\n    });\n\n    state.conn = server;\n    Session.set(\"was_hosting\", server.id);\n    dispatch(forkGame(server.id));\n    window.history.pushState(null, \"\", `?game=${server.id}`);\n    return server.id;\n  }\n);\n\nexport let comms = createSlice({\n  name: \"comms\",\n  initialState: {\n    // NOTE: offline denotes a totally offline game, not a disconnected state\n    status: \"offline\" as \"offline\" | \"pending\" | \"connected\",\n    hosting: false,\n    clientId: Session.get(\"comms_id\"),\n    gameId: null as string | null,\n  },\n  reducers: {\n    disconnected(state, action: {}) {\n      state.status = \"pending\";\n    },\n    connected(state, action: {}) {\n      state.status = \"connected\";\n    },\n  },\n  extraReducers: (builder) => {\n    // Client connection logic\n    builder.addCase(connect.pending, (state, _) => {\n      state.status = \"pending\";\n    });\n    builder.addCase(connect.fulfilled, (state, payload: any) => {\n      state.gameId = payload.gameId;\n      state.status = \"connected\";\n    });\n    builder.addCase(connect.rejected, (state, _) => {\n      state.status = \"offline\";\n    });\n\n    // Hosting events\n    builder.addCase(host.pending, (state, _) => {\n      state.status = \"pending\";\n    });\n    builder.addCase(host.fulfilled, (state, { payload }) => {\n      state.status = \"connected\";\n      state.gameId = payload;\n      state.hosting = true;\n    });\n    builder.addCase(host.rejected, (state, _) => {\n      state.status = \"offline\";\n    });\n  },\n});\n\nexport function shared<S, A>(\n  f: (state: S, action: PayloadAction<A>) => void\n): {\n  reducer: (state: any, action: PayloadAction<A>) => void;\n  prepare: (action: A) => any;\n} {\n  return {\n    reducer: f as any,\n    prepare: (a) => ({\n      payload: a,\n      meta: state.conn\n        ? {\n            shared: true,\n            src: state.conn.id,\n          }\n        : {},\n    }),\n  };\n}\n\nexport default comms.reducer;\n","import { RootStore } from \"../store\";\n\nexport function syncAction(state: RootStore) {\n  return {\n    type: \"STATE_SYNC\",\n    payload: {\n      game: state.game,\n      players: state.players,\n    },\n  };\n}\n\nexport function applySync(\n  state: RootStore,\n  action: ReturnType<typeof syncAction>\n): RootStore {\n  return {\n    ...state,\n    game: action.payload.game,\n    players: action.payload.players,\n  };\n}\n","export type GridSpace = \"gridspace\";\nexport type CanvasSpace = \"canvasspace\";\nexport type ClientSpace = \"clientspace\";\n\ninterface Unit<T> {\n  _unitBrand: T;\n}\nexport type Coord<T> = [number, number] & Unit<\"coord\">;\nexport type Offset<T> = [number, number] & Unit<\"offset\">;\nexport type Pair<T> = Coord<T> | Offset<T>;\n\nexport function coord(ev: {\n  clientX: number;\n  clientY: number;\n}): Coord<ClientSpace> {\n  return [ev.clientX, ev.clientY] as Coord<ClientSpace>;\n}\n\nexport function floor<T extends [number, number]>(a: T): T {\n  return a.map(Math.floor) as T;\n}\n\nexport function trunc<T extends [number, number]>(a: T): T {\n  return a.map((n) => (n < 0 ? Math.ceil(n) : Math.floor(n))) as T;\n}\n\nexport function add<T>(a: Offset<T>, b: Offset<T>): Offset<T>;\nexport function add<T>(a: Coord<T>, b: Offset<T>): Coord<T>;\nexport function add<T>(\n  a: [number, number],\n  b: [number, number]\n): [number, number] {\n  return [a[0] + b[0], a[1] + b[1]] as any;\n}\n\nexport function sub<T>(a: Offset<T>, b: Offset<T>): Offset<T>;\nexport function sub<T>(a: Coord<T>, b: Offset<T>): Coord<T>;\nexport function sub<T>(a: Coord<T>, b: Coord<T>): Offset<T>;\nexport function sub<T>(\n  a: [number, number],\n  b: [number, number]\n): [number, number] {\n  return [a[0] - b[0], a[1] - b[1]] as any;\n}\n\nexport function clamp(val: number, min: number, max: number) {\n  return Math.min(max, Math.max(min, val));\n}\n\nexport function coord_clamp<T, P extends Pair<T>>(\n  val: P,\n  min: [number, number],\n  max: [number, number]\n): P {\n  return [\n    Math.max(min[0], Math.min(max[0], val[0])),\n    Math.max(min[1], Math.min(max[1], val[1])),\n  ] as P;\n}\n","import { motion } from \"framer-motion\";\nimport React, { forwardRef, memo, PropsWithChildren } from \"react\";\nimport { Coord, GridSpace, Offset } from \"../../modules/game/units\";\n\nexport interface GridItemProps\n  extends React.DetailedHTMLProps<\n    React.HTMLAttributes<HTMLDivElement>,\n    HTMLDivElement\n  > {\n  loc: Coord<GridSpace>;\n  dim: Offset<GridSpace>;\n  style?: Omit<\n    React.CSSProperties,\n    \"position\" | \"left\" | \"top\" | \"width\" | \"height\"\n  >;\n}\n\nexport const GridItem = memo(\n  forwardRef((props: PropsWithChildren<GridItemProps>, ref) => {\n    return (\n      <motion.div\n        {...(props as any)}\n        ref={ref}\n        style={{\n          position: \"absolute\",\n          ...props.style,\n        }}\n        initial={false}\n        transition={{ type: \"tween\", ease: \"easeOut\", duration: 0.2 }}\n        animate={{\n          left: props.loc[0] + \"em\",\n          top: props.loc[1] + \"em\",\n          width: props.dim[0] + \"em\",\n          height: props.dim[1] + \"em\",\n        }}\n      >\n        {props.children}\n      </motion.div>\n    );\n  })\n);\n","import React from \"react\";\nimport { Coord, GridSpace } from \"../../modules/game/units\";\n\nexport interface OverlayProps {\n  width: number;\n  height: number;\n  onDrop?: (coord: Coord<GridSpace>) => void;\n}\n\nconst thickness = 0.025;\nfunction Overlay(props: OverlayProps) {\n  return (\n      <svg viewBox={`0 0 ${props.width + thickness} ${props.height + thickness}`} style={{\n      position: \"absolute\",\n        left: `${-thickness / 2}em`,\n        top: `${-thickness / 2}em`,\n        width: `${props.width + thickness}em`,\n        height: `${props.height + thickness}em`,\n        pointerEvents: \"none\",\n        transition: \"position 2s\",\n      }}>\n        <defs>\n            <pattern\n              id=\"grid\"\n              width=\"1\"\n              height=\"1\"\n              patternUnits=\"userSpaceOnUse\"\n              shapeRendering=\"geometricPrecision\"\n            >\n              <path\n                d=\"M 1 0 L 0 0 0 1\"\n                fill=\"none\"\n                stroke=\"gray\"\n                strokeWidth={thickness * 2}\n              ></path>\n            </pattern>\n        </defs>\n        <rect\n            style={{\n              pointerEvents: \"none\",\n          }}\n          x={0}\n          y={0}\n            width={props.width + thickness}\n            height={props.height + thickness}\n            fill=\"url(#grid)\"\n          ></rect>\n        </svg>\n  );\n}\nexport default React.memo(Overlay);\n","import React, { PointerEvent, useCallback, useEffect, useRef } from \"react\";\nimport { ClientSpace, Coord, coord } from \"../../modules/game/units\";\nimport { GridItem, GridItemProps } from \"./GridItem\";\n\ninterface SelectionProps extends GridItemProps {\n  onSelectionDrag: (offset: Coord<ClientSpace>) => void;\n  onSelectionDrop: (offset: Coord<ClientSpace>) => void;\n}\n\nfunction SelectionBox(props: SelectionProps) {\n  const initialLoc = useRef<Coord<ClientSpace> | null>(null);\n  // Represents the distance in client pixels from selection element origin to click point\n  const onPointerMove = useCallback(\n    (ev: PointerEvent<HTMLElement>) => {\n      if (initialLoc.current || ev.type === \"mouse\") {\n        //ev.preventDefault();\n        ev.stopPropagation();\n\n        props.onSelectionDrag(coord(ev));\n      }\n    },\n    [props]\n  );\n  const onPointerUp = useCallback(\n    (ev) => {\n      if (initialLoc.current !== null) {\n        ev.preventDefault();\n        ev.stopPropagation();\n        //(ev.currentTarget as HTMLDivElement).releasePointerCapture(ev.pointerId);\n        props.onSelectionDrop(coord(ev));\n        initialLoc.current = null;\n      }\n    },\n    [props]\n  );\n\n  const itemRef = useRef<HTMLDivElement>();\n  useEffect(() => {\n    itemRef.current?.addEventListener(\n      \"touchmove\",\n      (ev) => ev.preventDefault(),\n      { passive: false }\n    );\n  });\n  return (\n    <GridItem\n      ref={itemRef}\n      loc={props.loc}\n      dim={props.dim}\n      style={{\n        border: \"2px solid highlight\",\n        boxShadow: \"0 0 10px highlight\",\n      }}\n      onPointerDown={(ev) => {\n        ev.preventDefault();\n        ev.stopPropagation();\n\n        ev.currentTarget.setPointerCapture(ev.pointerId);\n        initialLoc.current = coord(ev);\n      }}\n      onPointerMoveCapture={onPointerMove}\n      onPointerUpCapture={onPointerUp}\n    ></GridItem>\n  );\n}\n\nexport default SelectionBox;\n","import React, {\n  forwardRef,\n  ForwardRefRenderFunction,\n  memo,\n  PropsWithChildren,\n  useCallback,\n  useEffect,\n  useImperativeHandle,\n  useRef,\n} from \"react\";\nimport { useGesture } from \"react-use-gesture\";\nimport { FullGestureState } from \"react-use-gesture/dist/types\";\nimport { clamp, Coord, GridSpace } from \"../../modules/game/units\";\n\nexport interface ViewportProps {\n  baseScalar: number;\n  baseUnit: string;\n  height: number;\n  width: number;\n}\n\nconst minScale = 0.2;\nconst maxScale = 2;\n\nexport interface ViewportRef {\n  clientToGrid(coord: [number, number]): Coord<GridSpace>;\n}\n\nexport interface Transform {\n  scale: number;\n  offset: Coord<GridSpace>;\n}\n\nexport const ViewportElem: ForwardRefRenderFunction<\n  ViewportRef,\n  PropsWithChildren<ViewportProps>\n> = (props, ref) => {\n  const viewport = useRef<HTMLDivElement>(null);\n  const canvas = useRef<HTMLDivElement>(null);\n\n  const transform = useRef<Transform>({\n    scale: 1,\n    offset: [0, 0] as Coord<GridSpace>,\n  });\n\n  const setTransform = (f: (t: Transform) => Transform, apply = true) => {\n    const newT = f(transform.current);\n    const newOffset = [\n      clamp(newT.offset[0], 0, props.width),\n      clamp(newT.offset[1], 0, props.height),\n    ];\n    transform.current = {\n      scale: newT.scale,\n      offset: newOffset as any,\n    };\n\n    if (apply) {\n      viewport.current!.style.fontSize = `${\n        transform.current.scale * props.baseScalar\n      }${props.baseUnit}`;\n      viewport.current!.scrollTo(\n        transform.current.offset[0] * 96 * transform.current.scale,\n        transform.current.offset[1] * transform.current.scale * 96\n      );\n    }\n  };\n  // Does fancy math to zoom around a mouse location. Location given relative to viewport\n  const performZoom = (\n    origin: Coord<GridSpace>,\n    oldScale: number,\n    newScale: number\n  ) => {\n    const delta = clamp(newScale - oldScale, -0.05, 0.05);\n    newScale = clamp(oldScale + delta, minScale, maxScale);\n    // if we don't return early, we'll end up sliding around\n    if (newScale === oldScale) {\n      return;\n    }\n    setTransform((t) => {\n      return {\n        scale: newScale,\n        offset: [\n          t.offset[0] - ((t.offset[0] - origin[0]) * delta) / oldScale,\n          t.offset[1] - ((t.offset[1] - origin[1]) * delta) / oldScale,\n        ] as Coord<GridSpace>,\n      };\n    });\n  };\n\n  // const drag = useDrag((state) => {\n  //   if (state.buttons !== 1) {\n  //     return;\n  //   }\n  //   setTransform(t => {\n  //     ;\n  //     let o = clientToGrid(sub(state.initial as Offset<ViewSpace>, state.delta as Offset<ViewSpace>));\n  //     o = coord_clamp(\n  //       o,\n  //       [0, 0],\n  //       [\n  //         props.width, props.height\n  //       ]\n  //     );\n  //     return {\n  //       ...t,\n  //       offset: o\n  //     };\n  //   });\n  // });\n\n  const initialScale = useRef(1);\n  const pinch = useGesture(\n    {\n      onPinchEnd: () => {\n        initialScale.current = transform.current.scale;\n      },\n      onPinch: (state: FullGestureState<\"pinch\">) => {\n        state.event?.preventDefault();\n        state.event?.stopPropagation();\n        //@ts-ignore\n        const deltaY = state.event?.deltaY;\n        //@ts-ignore\n        const client_origin = state.origin || [\n          //@ts-ignore\n          state.event!.clientX,\n          //@ts-ignore\n          state.event!.clientY,\n        ];\n        const origin = clientToGrid(client_origin);\n        let newScale: number;\n        if (deltaY) {\n          let delta = -1 * deltaY * 0.05 * transform.current.scale;\n          newScale = transform.current.scale + delta;\n        } else {\n          newScale = state.da[0] / state.initial[0] - 1 + initialScale.current!;\n        }\n        performZoom(origin, transform.current.scale, newScale);\n      },\n      onPinchStart: useCallback(\n        (state: FullGestureState<\"pinch\">) => {\n          state.event?.preventDefault();\n          state.event?.stopPropagation();\n          initialScale.current = transform.current.scale;\n        },\n        [transform]\n      ),\n    },\n    {\n      domTarget: viewport,\n      eventOptions: {\n        passive: false,\n        capture: true,\n      },\n    }\n  );\n  //@ts-ignore\n  useEffect(pinch, [pinch]);\n\n  const clientToGrid = (coord: [number, number]): Coord<GridSpace> => {\n    const rect = canvas.current!.getBoundingClientRect();\n    return [\n      (coord[0] - rect.left) / 96 / transform.current.scale,\n      (coord[1] - rect.top) / 96 / transform.current.scale,\n    ] as Coord<GridSpace>;\n  };\n\n  useImperativeHandle(\n    ref,\n    () => ({\n      clientToGrid,\n    }),\n    []\n  );\n\n  // Wheel must come first to prevent its use by pinch,\n  // because the logic for how to zoom on each is different\n  const scroll = useGesture({\n    onScrollEnd(state: FullGestureState<\"scroll\">) {\n      setTransform(\n        (t) => ({\n          ...t,\n          offset: [\n            viewport.current!.scrollLeft / 96 / transform.current.scale,\n            viewport.current!.scrollTop / 96 / transform.current.scale,\n          ] as any,\n        }),\n        false\n      );\n    },\n  });\n  return (\n    <div\n      className=\"viewport\"\n      {...scroll()}\n      ref={viewport}\n      style={{\n        fontSize: `${transform.current.scale * props.baseScalar}${\n          props.baseUnit\n        }`,\n      }}\n    >\n      <div className=\"padding\">\n        <div\n          ref={canvas}\n          className=\"gridsvg\"\n          style={{\n            width: `${props.width}em`,\n            height: `${props.height}em`,\n            position: \"relative\",\n          }}\n        >\n          {props.children}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport const Viewport = memo(forwardRef(ViewportElem));\n","import React, { memo, PropsWithChildren, useRef, useState } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { addImage, Image, updateImage } from \"../../modules/game\";\nimport { add, Coord, floor, GridSpace, sub } from \"../../modules/game/units\";\nimport { RootStore } from \"../../store\";\nimport useDrop from \"../util/useDrop\";\nimport \"./grid.css\";\nimport { GridItem } from \"./GridItem\";\nimport Overlay from \"./Overlay\";\nimport SelectionBox from \"./SelectionBox\";\nimport { Viewport, ViewportRef } from \"./Viewport\";\n\nexport interface GridProps {\n  dimensions: [number, number];\n}\n\nasync function getDataURL(file: File): Promise<string> {\n  const reader = new FileReader();\n  return new Promise((resolve, reject) => {\n    reader.onload = () => resolve(reader.result as string);\n    reader.readAsDataURL(file);\n  });\n}\n\nfunction extractURLFromHTML(html: string): string | null {\n  const parser = new DOMParser();\n  const doc = parser.parseFromString(html, \"text/html\");\n  return doc.querySelector(\"img\")?.src || null;\n}\nexport function Grid(props: PropsWithChildren<GridProps>) {\n  let dropLayer = useRef<HTMLDivElement>(null);\n  let selection = useRef<any>(null);\n  let [selectionOffset, setSelectionOffset] = useState<any>(null);\n  let viewport = useRef<ViewportRef>(null);\n  let hoverHint = useRef<HTMLDivElement>(null);\n  let items = useSelector((state: RootStore) => state.game.maps[0].images);\n  let dispatch = useDispatch();\n\n  let [dragging, drag, dragHandlers] = useDrop(\n    dropLayer,\n    (x, y) => {\n      if (hoverHint.current) {\n        let coords = viewport.current!.clientToGrid([x, y]);\n        hoverHint.current.style.left = Math.floor(coords[0] as number) + \"em\";\n        hoverHint.current.style.top = Math.floor(coords[1] as number) + \"em\";\n      }\n    },\n    async (ev) => {\n      let coords = viewport.current!.clientToGrid([ev.clientX, ev.clientY]);\n      let dataItems = ev.dataTransfer?.items ?? [];\n      let addItem = (s: string) => {\n        console.log(s);\n        let item = {\n          id: \"\" + Math.random(),\n          loc: [Math.floor(coords[0]), Math.floor(coords[1])],\n          dim: [1, 1],\n          href: s,\n        };\n        dispatch(addImage({ map: 0, img: (item as unknown) as Image }));\n      };\n      console.log(\"DataItems\", dataItems.length);\n      for (let i = 0; i < dataItems.length; i++) {\n        console.log(dataItems[i].type);\n        if (dataItems[i].type.startsWith(\"image/\")) {\n          const dataURL = await getDataURL(dataItems[i].getAsFile()!);\n          addItem(dataURL);\n          return;\n        }\n        if (dataItems[i].type === \"text/html\") {\n          dataItems[i].getAsString((s) => addItem(extractURLFromHTML(s)!));\n          return;\n        }\n        if (dataItems[i].type === \"application/x-moz-file-promise-url\") {\n          dataItems[i].getAsString(addItem);\n          return;\n        } else if (dataItems[i].kind === \"string\") {\n          let t = dataItems[i].type;\n          dataItems[i].getAsString((s) => console.log(t, s));\n        }\n      }\n    }\n  );\n  let gridDrag: Coord<GridSpace>;\n  if (dragging) {\n    gridDrag = viewport.current!.clientToGrid([drag.x, drag.y]);\n  }\n\n  return (\n    <div className=\"grid\" {...dragHandlers} ref={dropLayer}>\n      <Viewport\n        ref={viewport}\n        baseScalar={1}\n        baseUnit=\"in\"\n        width={props.dimensions[0]}\n        height={props.dimensions[1]}\n      >\n        {dragging ? (\n          <div\n            ref={hoverHint}\n            key=\"hover\"\n            style={{\n              position: \"absolute\",\n              left: Math.floor(gridDrag![0]) + \"em\",\n              top: Math.floor(gridDrag![1]) + \"em\",\n              width: \"1em\",\n              height: \"1em\",\n              background: \"#aaa\",\n            }}\n          ></div>\n        ) : null}\n        {Object.values(items).map((i) => (\n          <GridItem\n            key={i.id}\n            loc={\n              add(\n                i.loc,\n                selection.current?.id === i.id\n                  ? (selectionOffset as any)\n                  : [0, 0]\n              ) as any\n            }\n            dim={i.dim}\n            onPointerDown={(ev) => {\n              ev.preventDefault();\n              selection.current = i;\n              setSelectionOffset([0, 0]);\n            }}\n          >\n            <img\n              onDragStart={(ev) => ev.preventDefault()}\n              alt=\"\"\n              src={i.href}\n              style={{ display: \"block\", width: \"100%\", height: \"100%\" }}\n            />\n          </GridItem>\n        ))}\n        <Overlay width={props.dimensions[0]} height={props.dimensions[1]} />\n        {selection.current && (\n          <SelectionBox\n            key=\"\"\n            loc={add(selectionOffset!, selection.current.loc) as any}\n            dim={selection.current.dim}\n            onSelectionDrag={(coord) =>\n              setSelectionOffset(\n                floor(\n                  sub(\n                    viewport.current!.clientToGrid(coord),\n                    selection.current.loc\n                  )\n                )\n              )\n            }\n            onSelectionDrop={(coord) => {\n              const loc = floor(viewport.current!.clientToGrid(coord));\n              dispatch(\n                updateImage({\n                  map: 0,\n                  id: selection.current.id,\n                  img: {\n                    loc,\n                  },\n                })\n              );\n              setSelectionOffset(null);\n              selection.current = null;\n            }}\n          />\n        )}\n      </Viewport>\n    </div>\n  );\n}\n\nexport default memo(Grid);\n","import { useState } from \"react\";\nexport interface DragState {\n  x: number;\n  y: number;\n}\n\nexport default function useDrop(\n  ref: React.RefObject<Element | null>,\n  onDrag: (x: number, y: number) => void,\n  onDrop: (ev: DragEvent) => void\n): [boolean, DragState, any] {\n  let [dragDepth, setDragDepth] = useState(0);\n  let [dragState, setDragState] = useState({\n    x: 0,\n    y: 0,\n  });\n\n  const dropStub = (ev: DragEvent) => {\n    ev.preventDefault();\n\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth(0);\n    setDragState({\n      x,\n      y,\n    });\n    onDrop(ev);\n  };\n  const onDragEnter = (ev: DragEvent) => {\n    ev.preventDefault();\n    ev.stopPropagation();\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth((d) => d + 1);\n    setDragState({\n      x,\n      y,\n    });\n  };\n  const onDragLeave = (ev: DragEvent) => {\n    ev.preventDefault();\n    ev.stopPropagation();\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth((d) => d - 1);\n    setDragState({\n      x,\n      y,\n    });\n  };\n  const onDragOver = (ev: DragEvent) => {\n    ev.preventDefault();\n    onDrag(ev.clientX, ev.clientY);\n  };\n  return [\n    dragDepth > 0,\n    dragState,\n    {\n      onDragEnter,\n      onDragLeave,\n      onDragOver,\n      onDrop: dropStub,\n    },\n  ];\n}\n","import React, { FormEvent, useCallback } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { changeName } from \"../modules/players\";\nimport { RootStore } from \"../store\";\nimport \"./JoinOverlay.css\";\n\nexport function JoinOverlay() {\n  const shouldRender = useSelector(\n    (s: RootStore) =>\n      s.comms.status === \"connected\" &&\n      s.players.data[s.comms.clientId]?.name === null\n  );\n\n  const clientId = useSelector((s: RootStore) => s.comms.clientId);\n  const dispatch = useDispatch();\n\n  const joinAsPlayer = useCallback(\n    (ev: FormEvent) => {\n      ev.preventDefault();\n      const data = new FormData(ev.nativeEvent.target as HTMLFormElement);\n      const name = data.get(\"name\") as string;\n      dispatch(changeName({ player: clientId, name }));\n    },\n    [clientId, dispatch]\n  );\n\n  if (!shouldRender) {\n    return null;\n  }\n\n  return (\n    <div id=\"join\">\n      <form\n        style={{\n          display: \"flex\",\n          flexDirection: \"column\",\n          maxWidth: \"480px\",\n          background: \"red\",\n        }}\n        onSubmit={joinAsPlayer}\n      >\n        <label htmlFor=\"name\">\n          Display Name:\n          <input name=\"name\" type=\"text\" defaultValue={\"\"}></input>\n        </label>\n        <button type=\"submit\">Join</button>\n      </form>\n    </div>\n  );\n}\n","import { AnimateSharedLayout, motion } from \"framer-motion\";\nimport React from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useSelector } from \"react-redux\";\nimport { RootStore } from \"../../store\";\nimport \"./Toast.css\";\n\nexport function ToastArea(props: {}) {\n  const toasts = useSelector((state: RootStore) => state.toast.toasts);\n  const { t } = useTranslation();\n  return (\n    <div className=\"toastArea\">\n      <AnimateSharedLayout>\n        {toasts.map((toast) => (\n          <motion.div\n            className=\"toast\"\n            initial={{ position: \"relative\", opacity: 0 }}\n            animate={{ position: \"relative\", opacity: 1 }}\n            exit={{ position: \"relative\", opacity: 0 }}\n            layout\n            key={toast.id}\n          >\n            {t(toast.msg)}\n          </motion.div>\n        ))}\n      </AnimateSharedLayout>\n    </div>\n  );\n}\n","import React, { PropsWithChildren } from \"react\";\nimport \"./Toolbar.css\";\n\ninterface ToolbarProps {}\nfunction Toolbar(props: PropsWithChildren<ToolbarProps>) {\n  return <div className=\"toolbar\">{props.children}</div>;\n}\nexport default Toolbar;\n","import React from \"react\";\nimport \"./Loading.css\";\n\nexport function Loading() {\n  return (\n    <div className=\"spinner\">\n      <div className=\"double-bounce1\"></div>\n      <div className=\"double-bounce2\"></div>\n    </div>\n  );\n}\n","import React, { useState } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { host } from \"../modules/comms\";\nimport { reset, setDimensions } from \"../modules/game\";\nimport { GridSpace, Offset } from \"../modules/game/units\";\nimport { issueToast } from \"../modules/toast\";\nimport { RootStore } from \"../store\";\nimport \"./App.css\";\nimport Grid from \"./grid2/Grid\";\nimport { JoinOverlay } from \"./JoinOverlay\";\nimport { ToastArea } from \"./toasts/ToastArea\";\nimport Toolbar from \"./toolbar/Toolbar\";\nimport { Loading } from \"./toolkit/Loading\";\n\ninterface Rect {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\nfunction App() {\n  let comms = useSelector((state: RootStore) => {\n    console.log(state);\n    return state.comms;\n  });\n  let [curr_map, _set_curr_map] = useState(() => 0);\n  let dim = useSelector((state: RootStore) => [\n    state.game.maps[curr_map].width,\n    state.game.maps[curr_map].height,\n  ]);\n  let dispatch = useDispatch();\n  const { t } = useTranslation();\n\n  let players = useSelector((state: RootStore) =>\n    state.players.online.map((p) => state.players.data[p].name)\n  );\n  return (\n    <div className=\"App\">\n      <JoinOverlay />\n      <ToastArea />\n      <Grid dimensions={dim as Offset<GridSpace>} />\n      <Toolbar>\n        <button\n          onClick={() =>\n            dispatch(\n              setDimensions({\n                map: curr_map,\n                width: dim[0] + 1,\n                height: dim[1],\n              })\n            )\n          }\n        >\n          Add Column\n        </button>\n        <button\n          onClick={() =>\n            dispatch(\n              setDimensions({\n                map: curr_map,\n                width: dim[0],\n                height: dim[1] + 1,\n              })\n            )\n          }\n        >\n          Add Row\n        </button>\n        <button onClick={() => dispatch(reset({}))}>Reset</button>\n        <button onClick={() => dispatch(issueToast(t(\"hello\")))}>Say hi</button>\n        {comms.status === \"offline\" && (\n          <button onClick={() => dispatch(host())}>Host</button>\n        )}\n        {comms.status === \"pending\" && <Loading />}\n\n        {comms.hosting && `hosting: ${comms.gameId}`}\n        {players.map((p) => (\n          <p>{p || \"unknown\"}</p>\n        ))}\n      </Toolbar>\n    </div>\n  );\n}\n\nexport default App;\n","import i18n from \"i18next\";\nimport Backend from \"i18next-xhr-backend\";\nimport { initReactI18next } from \"react-i18next\";\n\ni18n\n  .use(Backend)\n  .use(initReactI18next)\n  // for all options read: https://www.i18next.com/overview/configuration-options\n  .init({\n    debug: true,\n\n    lng: \"en\",\n    fallbackLng: \"en\",\n    whitelist: [\"en\", \"de\"],\n\n    interpolation: {\n      escapeValue: false, // not needed for react as it escapes by default\n    },\n    backend: {\n      loadPath: \"/battlegrid/locales/{{lng}}/{{ns}}.json\",\n    },\n  });\n\nexport default i18n;\n","import { combineReducers, configureStore, Store } from \"@reduxjs/toolkit\";\nimport comms, { state } from \"./modules/comms\";\nimport game from \"./modules/game\";\nimport { persistState } from \"./modules/game/persist\";\nimport players from \"./modules/players\";\nimport { applySync } from \"./modules/sync\";\nimport toast from \"./modules/toast\";\nimport { Session } from \"./storage/session\";\n\nconst mainReducer = combineReducers({ comms, game, toast, players });\nexport type RootStore = ReturnType<typeof mainReducer>;\n\nconst initialState: RootStore = mainReducer(undefined, { type: \"null\" });\n\n// This \"any\" means dispatch whatever you want. Works well enough\nconst store: Store<RootStore, any> = configureStore({\n  reducer(state, action): ReturnType<typeof mainReducer> {\n    if (action.type === \"STATE_SYNC\") {\n      return applySync(state!, action as any);\n    }\n    return mainReducer(state, action);\n  },\n  middleware: (m) =>\n    m().prepend((api) => (next) => (action) => {\n      // Send out all actions that originated on this peer\n      // if we didn't check that it came from this peer, we'd\n      // bounce messages back and forth forever\n      console.log(\"connection?\", state.conn);\n      state.conn &&\n        action.meta?.shared &&\n        action.meta?.src === state.conn.id &&\n        state.conn.send(action);\n      return next(action);\n    }),\n  preloadedState: initialState,\n});\n\nstore.subscribe(() => {\n  const state = store.getState() as RootStore;\n  console.log(state);\n  persistState(state.game.id, state.game);\n  Session.set(\"players\", state.players.data);\n});\nexport default store;\n","import { GameState } from \".\";\n\nexport function gameState(id: string) {\n  const item = sessionStorage.getItem(id);\n  return item ? JSON.parse(item) : null;\n}\n\nexport function persistState(id: string, state: GameState) {\n  sessionStorage.setItem(id, JSON.stringify(state));\n}\n","import React, { Suspense } from \"react\";\nimport ReactDOM from \"react-dom\";\nimport { Provider } from \"react-redux\";\nimport App from \"./components/App\";\nimport \"./i18n\";\nimport \"./index.css\";\nimport { connect, host } from \"./modules/comms\";\nimport { PeerID } from \"./modules/comms/peer\";\nimport { loadGame } from \"./modules/game\";\nimport { gameState } from \"./modules/game/persist\";\nimport { Session } from \"./storage/session\";\nimport store from \"./store\";\n//import * as serviceWorker from './serviceWorker';\n\nconst urlParams = new URLSearchParams(window.location.search);\n\n// Load the game if we have it stored\nconst game = urlParams.get(\"game\");\nlet state = gameState(game ?? \"local\");\n\n// If we found saved data\nif (game) {\n  console.log(\"Found game: \", game);\n  if (Session.get(\"was_hosting\") === game) {\n    console.log(\"REHOSTING!\");\n    if (state) {\n      store.dispatch(loadGame(state));\n    }\n    Session.get(\"players\");\n    store.dispatch(host());\n  } else {\n    console.log(\"Huh\");\n    store.dispatch(connect(game as PeerID));\n  }\n} else if (state) {\n  store.dispatch(loadGame(state));\n}\n\nReactDOM.render(\n  <React.StrictMode>\n    <Suspense fallback={null}>\n      <Provider store={store}>\n        <App />\n      </Provider>\n    </Suspense>\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\n//serviceWorker.unregister();\n"],"sourceRoot":""}