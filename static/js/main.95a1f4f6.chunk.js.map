{"version":3,"sources":["../node_modules/peerjs/dist sync","modules/game/units.ts","components/grid2/Overlay.tsx","components/grid2/Viewport.tsx","components/grid2/GridItem.tsx","components/grid2/SelectionBox.tsx","modules/comms/peer.ts","modules/comms/server.ts","modules/toast.ts","storage/session.ts","modules/players.ts","modules/comms/client2.ts","modules/comms/index.ts","modules/sync.ts","modules/game/index.ts","components/grid2/Grid.tsx","components/util/useDrop.ts","components/toolbar/Toolbar.tsx","components/toasts/ToastArea.tsx","components/toolkit/Loading.tsx","components/JoinOverlay.tsx","components/App.tsx","store.ts","modules/game/persist.ts","i18n.ts","index.tsx"],"names":["webpackEmptyContext","req","e","Error","code","keys","resolve","module","exports","id","coord","ev","clientX","clientY","floor","a","map","Math","add","b","clamp","val","min","max","React","memo","props","style","position","left","right","top","bottom","background","pointerEvents","borderRight","borderBottom","transition","Viewport","forwardRef","ref","viewport","useRef","canvas","transform","scale","offset","setTransform","f","apply","newT","current","newOffset","width","height","fontSize","baseScalar","baseUnit","scrollTo","initialScale","pinch","useGesture","onPinchEnd","onPinch","state","event","preventDefault","stopPropagation","newScale","deltaY","client_origin","origin","clientToGrid","delta","da","initial","oldScale","t","performZoom","onPinchStart","useCallback","domTarget","eventOptions","passive","capture","useEffect","rect","getBoundingClientRect","useImperativeHandle","scroll","onScrollEnd","scrollLeft","scrollTop","className","children","GridItem","div","type","ease","duration","animate","loc","dim","SelectionBox","initialLoc","onPointerMove","onSelectionDrag","onPointerUp","onSelectionDrop","itemRef","addEventListener","border","boxShadow","onPointerDown","currentTarget","setPointerCapture","pointerId","onPointerMoveCapture","onPointerUpCapture","process","REACT_APP_PEERJS_HOST","REACT_APP_PEERJS_PORT","create_peer","console","log","peer","Peer","debug","host","secure","port","parseInt","undefined","path","Promise","reject","on_error","cleanup","on_open","off","on","connect_peer","metadata","dc","connect","game_server","server_id","handlers","clients","Map","broadcast","data","exclude","label","c","send","conn","client_id","set","d","onMessage","delete","onDisconnect","onConnect","onStartup","sendTo","msg","get","sleep","m","r","setTimeout","issueToast","createAsyncThunk","dispatch","Date","now","addToast","removeToast","toast","createSlice","name","initialState","toasts","reducers","payload","push","filter","actions","defaults","was_hosting","comms_id","uuid","players","Session","key","item","sessionStorage","getItem","JSON","parse","def","setItem","stringify","v","online","playerJoined","shared","action","removePlayer","p","changeName","player","game_client","game","connect_data","data_conn","keep_trying","on_first_message","onInitialMessage","timeout","gameId","getState","clientId","comms","disconnected","connected","_","server","forkGame","window","history","pushState","status","hosting","extraReducers","builder","addCase","pending","fulfilled","rejected","reducer","prepare","meta","src","maps","images","loadGame","setDimensions","addImage","img","updateImage","reset","getDataURL","file","reader","FileReader","onload","result","readAsDataURL","extractURLFromHTML","html","DOMParser","parseFromString","querySelector","gridDrag","dropLayer","selection","useState","selectionOffset","setSelectionOffset","hoverHint","items","useSelector","useDispatch","onDrag","onDrop","dragDepth","setDragDepth","x","y","dragState","setDragState","onDragEnter","onDragLeave","onDragOver","useDrop","coords","dataItems","dataTransfer","addItem","s","random","href","length","i","startsWith","getAsFile","dataURL","getAsString","kind","dragging","drag","dragHandlers","dimensions","Object","values","onDragStart","alt","display","Toolbar","ToastArea","useTranslation","opacity","exit","layout","Loading","JoinOverlay","shouldRender","joinAsPlayer","FormData","nativeEvent","target","flexDirection","maxWidth","onSubmit","htmlFor","defaultValue","App","curr_map","onClick","mainReducer","combineReducers","store","configureStore","applySync","middleware","prepend","api","next","preloadedState","subscribe","persistState","i18n","use","Backend","initReactI18next","init","lng","fallbackLng","whitelist","interpolation","escapeValue","backend","loadPath","URLSearchParams","location","search","gameState","ReactDOM","render","StrictMode","fallback","document","getElementById"],"mappings":"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","file":"static/js/main.95a1f4f6.chunk.js","sourcesContent":["function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = function() { return []; };\nwebpackEmptyContext.resolve = webpackEmptyContext;\nmodule.exports = webpackEmptyContext;\nwebpackEmptyContext.id = 46;","export type GridSpace = \"gridspace\";\nexport type CanvasSpace = \"canvasspace\";\nexport type ClientSpace = \"clientspace\";\n\ninterface Unit<T> {\n    _unitBrand: T\n}\nexport type Coord<T> = [number, number] & Unit<'coord'>\nexport type Offset<T> = [number, number] & Unit<'offset'>\nexport type Pair<T> = Coord<T> | Offset<T>\n\nexport function coord(ev: {clientX: number, clientY: number}): Coord<ClientSpace> {\n    return [ev.clientX, ev.clientY] as Coord<ClientSpace> \n}\n\nexport function floor<T extends [number, number] > (a: T): T {\n    return a.map(Math.floor) as T\n}\n\nexport function trunc<T extends [number, number] > (a: T): T {\n    return a.map(n => n < 0 ? Math.ceil(n) : Math.floor(n)) as T\n}\n\n\nexport function add<T>(a: Offset<T>, b: Offset<T>): Offset<T>;\nexport function add<T>(a: Coord<T>, b: Offset<T>): Coord<T>\nexport function add<T>(a: [number, number], b: [number,number]): [number,number] {\n    return [a[0] + b[0], a[1] + b[1]] as any;\n}\n\nexport function sub<T>(a: Offset<T>, b: Offset<T>): Offset<T>;\nexport function sub<T>(a: Coord<T>, b: Offset<T>): Coord<T>\nexport function sub<T>(a: Coord<T>, b: Coord<T>): Offset<T>\nexport function sub<T>(a: [number, number], b: [number,number]): [number,number] {\n    return [a[0] - b[0], a[1] - b[1]] as any;\n}\n\nexport function clamp(val: number, min: number, max: number) {\n  return Math.min(max, Math.max(min, val));\n}\n\nexport function coord_clamp<T, P extends Pair<T>>(val: P, min: [number, number], max: [number, number]): P {\n    return [\n        Math.max(min[0], Math.min(max[0], val[0])),\n        Math.max(min[1], Math.min(max[1], val[1])),\n    ] as P;\n}","import React from \"react\";\nimport { Coord, GridSpace } from \"../../modules/game/units\";\n\nexport interface OverlayProps {\n  width: number,\n  height: number,\n  onDrop?: (coord: Coord<GridSpace>) => void;\n}\n\nconst thickness = 0.05\nconst linecolor = \"gray\"\nfunction Overlay(props: OverlayProps) {\n  return (<div style={{\n    position: \"absolute\",\n    left: `${-thickness/2}em`,\n    right: `${-thickness/2}em`,\n    top: `${-thickness/2}em`,\n    bottom: `${-thickness/2}em`,\n    background: `\n      repeating-linear-gradient(to right, ${linecolor}, ${linecolor} ${thickness}em, transparent ${thickness}em 1em),\n      repeating-linear-gradient(to bottom, ${linecolor}, ${linecolor} ${thickness}em, transparent ${thickness}em 1em)`,\n    pointerEvents: \"none\",\n    borderRight: `${thickness}em solid ${linecolor}`,\n    borderBottom: `${thickness}em solid ${linecolor}`,\n    transition: \"position 2s\"\n  }}></div>\n  );\n}\nexport default React.memo(Overlay);","import { useRef, useCallback, PropsWithChildren, ForwardRefRenderFunction, useImperativeHandle, forwardRef, memo, useEffect } from \"react\";\nimport { Coord, clamp, GridSpace } from \"../../modules/game/units\";\nimport { useGesture } from \"react-use-gesture\";\nimport { FullGestureState } from \"react-use-gesture/dist/types\";\n\n\nimport React from \"react\";\n\nexport interface ViewportProps {\n  baseScalar: number,\n  baseUnit: string,\n  height: number,\n  width: number,\n}\n\nconst minScale = 0.2;\nconst maxScale = 2;\n\nexport interface ViewportRef {\n  clientToGrid(coord: [number, number]): Coord<GridSpace>\n}\n\nexport interface Transform {\n  scale: number,\n  offset: Coord<GridSpace>,\n}\n\nexport const ViewportElem: ForwardRefRenderFunction<ViewportRef, PropsWithChildren<ViewportProps>> = (props, ref) => {\n  const viewport = useRef<HTMLDivElement>(null);\n  const canvas = useRef<HTMLDivElement>(null);\n\n  const transform = useRef<Transform>({\n    scale: 1,\n    offset: [0, 0] as Coord<GridSpace>,\n  });\n\n  const setTransform = (f: (t: Transform) => Transform, apply=true) => {\n    const newT = f(transform.current);\n    const newOffset = [\n      clamp(newT.offset[0], 0, props.width),\n      clamp(newT.offset[1], 0, props.height)\n    ]\n    transform.current = {\n      scale: newT.scale,\n      offset: newOffset as any,\n    }\n      ;\n    \n    if (apply) {\n      viewport.current!.style.fontSize = `${transform.current.scale * props.baseScalar}${props.baseUnit}`\n      viewport.current!.scrollTo(transform.current.offset[0] * 96 * transform.current.scale, transform.current.offset[1] * transform.current.scale * 96)\n\n    }\n  }\n    // Does fancy math to zoom around a mouse location. Location given relative to viewport\n    const performZoom = \n      (origin: Coord<GridSpace>, oldScale: number, newScale: number) => {\n        const delta = clamp(newScale - oldScale, -0.05, 0.05);\n        newScale = clamp(oldScale + delta, minScale, maxScale);\n        // if we don't return early, we'll end up sliding around\n        if (newScale === oldScale) {\n          return;\n        }\n        setTransform(t => {\n          ;\n          return {\n            scale: newScale,\n            offset: [\n                t.offset[0] - (t.offset[0] - origin[0]) * delta / oldScale,\n                t.offset[1] - (t.offset[1] - origin[1]) * delta / oldScale,\n            ] as Coord<GridSpace>\n          }\n        });\n      }\n      \n    // const drag = useDrag((state) => {\n    //   if (state.buttons !== 1) {\n    //     return;\n    //   }\n    //   setTransform(t => {\n    //     ;\n    //     let o = clientToGrid(sub(state.initial as Offset<ViewSpace>, state.delta as Offset<ViewSpace>));\n    //     o = coord_clamp(\n    //       o,\n    //       [0, 0],\n    //       [\n    //         props.width, props.height\n    //       ]\n    //     );\n    //     return {\n    //       ...t,\n    //       offset: o\n    //     };\n    //   });\n    // });\n  \n    const initialScale = useRef(1);\n    const pinch = useGesture(\n      {\n        onPinchEnd: () => {\n          initialScale.current = transform.current.scale;\n        },\n        onPinch: \n          (state: FullGestureState<\"pinch\">) => {\n            state.event?.preventDefault();\n            state.event?.stopPropagation();\n            ;\n            //@ts-ignore\n            const deltaY = state.event?.deltaY\n            //@ts-ignore\n            const client_origin = state.origin || [state.event!.clientX, state.event!.clientY] \n            ;\n            const origin =\n              clientToGrid(client_origin);\n            let newScale: number;\n            if (deltaY) {\n              let delta = -1 * deltaY * 0.05 * transform.current.scale;\n              newScale = transform.current.scale + delta;\n            } else {\n              newScale = (state.da[0] / state.initial[0] - 1) + initialScale.current!;\n            }\n            performZoom(\n              origin,\n              transform.current.scale,\n              newScale\n            );\n          },\n        onPinchStart: useCallback(\n          (state: FullGestureState<\"pinch\">) => {\n            state.event?.preventDefault();\n            state.event?.stopPropagation();\n            ;\n            initialScale.current = transform.current.scale;\n            ;\n          },\n          [transform]\n        ),\n      },\n      {\n        domTarget: viewport,\n        eventOptions: {\n          passive: false,\n          capture: true,\n        },\n      }\n    );\n  //@ts-ignore\n  useEffect(pinch, [pinch]);\n  \n  const clientToGrid = (coord: [number, number]): Coord<GridSpace> => {\n     \n      const rect = canvas.current!.getBoundingClientRect();\n    ;\n    ;\n      return [\n        (coord[0] - rect.left) / 96 / transform.current.scale,\n        (coord[1] - rect.top) / 96 / transform.current.scale,\n      ] as Coord<GridSpace>;\n    }\n  \n  useImperativeHandle(ref, () => ({\n    clientToGrid,\n  }), []);\n\n    // Wheel must come first to prevent its use by pinch,\n    // because the logic for how to zoom on each is different\n    const scroll = useGesture({\n      onScrollEnd(state: FullGestureState<'scroll'>) {\n        ;\n        setTransform(t => ({\n          ...t,\n          offset: [viewport.current!.scrollLeft / 96 / transform.current.scale, viewport.current!.scrollTop / 96 / transform.current.scale] as any,\n        }), false);\n      },\n    });\n    return (\n      <div className=\"viewport\" {...scroll()} ref={viewport} style={{\n          fontSize: `${transform.current.scale * props.baseScalar}${props.baseUnit}`,\n      }}>\n        <div className=\"padding\" >\n        <div ref={canvas}\n          className=\"gridsvg\"\n                style={{\n                  width: `${props.width}em`,\n                  height: `${props.height}em`,\n                  position: \"relative\",\n                }}>\n                {props.children}\n            </div>\n        </div>\n        </div>\n    )\n}\n\nexport const Viewport = memo(forwardRef(ViewportElem));","import { Coord, Offset, GridSpace } from \"../../modules/game/units\";\nimport { PropsWithChildren, memo, forwardRef } from \"react\";\nimport React from \"react\";\nimport { motion } from \"framer-motion\";\n\nexport interface GridItemProps extends React.DetailedHTMLProps<React.HTMLAttributes<HTMLDivElement>, HTMLDivElement> {\n  loc: Coord<GridSpace>,\n  dim: Offset<GridSpace>,\n  style?: Omit<React.CSSProperties, 'position' | 'left' | 'top' | 'width' | 'height'>,\n}\n\nexport const GridItem = memo(forwardRef((props: PropsWithChildren<GridItemProps>, ref) => {\n  return (\n    <motion.div\n      {...props as any}\n      ref={ref}\n      style={{\n        position: \"absolute\",\n        ...props.style,\n      }}\n      initial={false}\n      transition={{type: \"tween\", ease: \"easeOut\", duration: 0.2}}\n      animate={{\n        left: props.loc[0] + \"em\",\n        top: props.loc[1] + \"em\",\n        width: props.dim[0] + \"em\",\n        height: props.dim[1] + \"em\",\n      }}\n      >\n      {props.children}\n    </motion.div>\n  )\n}));","import { useRef, useCallback, useEffect } from \"react\";\nimport { GridItemProps, GridItem } from \"./GridItem\";\nimport React, {PointerEvent} from \"react\";\nimport { ClientSpace, Coord, coord } from \"../../modules/game/units\";\n\ninterface SelectionProps extends GridItemProps {\n  onSelectionDrag: (offset: Coord<ClientSpace>) => void,\n  onSelectionDrop: (offset: Coord<ClientSpace>) => void,\n}\n\nfunction SelectionBox(props: SelectionProps) {\n  const initialLoc = useRef<Coord<ClientSpace> | null>(null)\n  // Represents the distance in client pixels from selection element origin to click point\n  const onPointerMove = useCallback((ev: PointerEvent<HTMLElement>) => {\n      if (initialLoc.current || ev.type === 'mouse') {\n          //ev.preventDefault();\n          ev.stopPropagation();\n          \n          props.onSelectionDrag(coord(ev));\n      }\n  }, [props])\n  const onPointerUp = useCallback((ev) => {\n      if (initialLoc.current !== null) {\n          ev.preventDefault();\n        ev.stopPropagation();\n        ;\n          //(ev.currentTarget as HTMLDivElement).releasePointerCapture(ev.pointerId);\n          props.onSelectionDrop(coord(ev));\n        initialLoc.current = null;\n      }\n  }, [props])\n\n  const itemRef = useRef<HTMLDivElement>();\n  useEffect(() => {\n    itemRef.current?.addEventListener('touchmove', ev => ev.preventDefault(), {passive: false});\n  })\n  return (\n    <GridItem\n      ref={itemRef}\n      loc={props.loc}\n      dim={props.dim}\n      style={{\n        border: \"2px solid highlight\",\n        boxShadow: \"0 0 10px highlight\",\n      }}\n      onPointerDown={ev => {\n                    ev.preventDefault();\n                    ev.stopPropagation();\n                    \n        ev.currentTarget.setPointerCapture(ev.pointerId);\n        initialLoc.current = coord(ev);\n      }}\n      onPointerMoveCapture={onPointerMove}\n      onPointerUpCapture={onPointerUp}\n    ></GridItem>\n  )\n}\n\nexport default SelectionBox;","import Peer, { DataConnection } from \"peerjs\";\nlet { REACT_APP_PEERJS_HOST, REACT_APP_PEERJS_PORT } = process.env;\nexport type PeerID = string & {__roomId: string}\nexport async function create_peer(id?: PeerID): Promise<Peer> {\n  console.log(\"ENV??\", process.env);\n  let peer = new Peer(id, {\n    debug: 3,\n    host: REACT_APP_PEERJS_HOST,\n    secure: true,\n    port: REACT_APP_PEERJS_PORT ? parseInt(REACT_APP_PEERJS_PORT) : undefined,\n    path: \"/\"\n  });\n  return new Promise((resolve, reject) => {\n    let on_error = (e: any) => {\n      cleanup();\n      reject(`Error establishing peer: ${e}`)\n    }\n    let on_open = () => {\n      cleanup();\n      console.log(\"OPENING?\")\n      resolve(peer);\n    }\n    let cleanup = () => {\n      peer.off('open', on_open);\n      peer.off('error', on_error);\n    }\n    peer.on('open', on_open);\n    peer.on('error', on_error);\n  })\n}\n\nexport async function connect_peer(peer: Peer, id: PeerID, metadata?: any): Promise<DataConnection> {\n  const dc = peer.connect(id, {metadata});\n  return new Promise((resolve, reject) => {\n    let on_error = (e: any) => {\n      cleanup();\n      reject(`Error establishing peer: ${e}`)\n    }\n    let on_open = () => {\n      cleanup();\n      resolve(dc);\n    }\n    let cleanup = () => {\n      dc.off('open', on_open);\n      dc.off('error', on_error);\n    }\n    dc.on('open', on_open);\n    dc.on('error', on_error);\n  })\n}","import Peer, { DataConnection } from \"peerjs\";\nimport { ConnId } from \".\";\nimport { Player } from \"../players\";\nimport { create_peer, PeerID } from \"./peer\";\n\ntype Config = {\n  onStartup(): void\n  onConnect(player: ConnId): void\n  onDisconnect(label: ConnId): void\n  onMessage(msg: any): void\n}\n\nexport interface ServerClient {\n  send(msg: any): void;\n  readonly id: string,\n}\n\nexport async function game_server(server_id: string, handlers: Config) {\n  const peer = await create_peer(server_id as PeerID);\n  const clients = new Map<string, DataConnection>();\n  const broadcast = (data: any, exclude?: string) => {\n    for (let [label, c] of clients) {\n      if (label !== exclude)\n        c.send(data);\n    }\n  };\n\n  peer.on('connection', conn => conn.on('open', () => {\n    const client_id = conn.metadata.client_id as ConnId;\n    console.log(\"NEW CLIENT\", client_id);\n    clients.set(client_id, conn);\n   \n    conn.on('data', d => {\n      broadcast(d, client_id)\n      handlers.onMessage(d);\n    });\n    conn.on('close', () => {\n      clients.delete(client_id)\n      handlers.onDisconnect(client_id as ConnId)\n    })\n    conn.on('error', () => {\n      clients.delete(client_id)\n      handlers.onDisconnect(client_id as ConnId)\n    })\n    \n\n    handlers.onConnect(conn.metadata.client_id);\n  }));\n\n  handlers.onStartup();\n\n  return {\n    id: server_id,\n    send: broadcast,\n    sendTo(label: string, msg: any) {\n      clients.get(label)!.send(msg);\n    }\n  };\n}\n","import { createSlice } from \"@reduxjs/toolkit\";\nimport { createAsyncThunk } from \"@reduxjs/toolkit\";\n\nconst sleep = (m: number) => new Promise(r => setTimeout(r, m))\nexport const issueToast = createAsyncThunk('toast/issue', async (msg: string, { dispatch }) => {\n  const id = Date.now();\n  dispatch(addToast({ id: Date.now(), msg }));\n  await sleep(5000);\n  dispatch(removeToast(id));\n});\n\nexport const toast = createSlice({\n  name: 'toast',\n  initialState: {\n    toasts: [] as { id: number, msg: string }[]\n  },\n  reducers: {\n    addToast(state, { payload }: { payload: { id: number, msg: string } }) {\n      state.toasts.push(payload);\n    },\n    removeToast(state, { payload }: { payload: number }) {\n      state.toasts = state.toasts.filter(t => t.id !== payload)\n    }\n  }\n})\n\nexport default toast.reducer;\nexport const { addToast, removeToast } = toast.actions;","import { v4 as uuid } from \"uuid\"\nimport { Player } from \"../modules/players\";\n\n// Provides a strongly-typed interface to our session variables \n\nconst defaults = {\n  // Denotes whether the user is currently hosting\n  was_hosting: () => null as null | string,\n  // Denote the session-specific comms_id\n  comms_id: uuid,\n  // The player object created for this session\n  players: () => ({}) as {[id: string]: Player},\n}\n\ntype SessionMap = typeof defaults;\nexport const Session = {\n  get<K extends keyof SessionMap>(key: K): ReturnType<SessionMap[K]> {\n    const item = sessionStorage.getItem(key);\n    if (item) {\n      return JSON.parse(item);\n    }\n\n    const def = defaults[key]() as ReturnType<SessionMap[K]>;\n    sessionStorage.setItem(key, JSON.stringify(def));\n    return def;\n  },\n\n  set<K extends keyof SessionMap>(key: K, v: ReturnType<SessionMap[K]>) {\n    sessionStorage.setItem(key, JSON.stringify(v))\n  }\n}","import { Action, createSelector, createSlice, PayloadAction } from \"@reduxjs/toolkit\";\nimport { Session } from \"../storage/session\";\nimport { shared, state } from \"./comms\";\n\ntype PlayersState = {\n  online: string[],\n  data: { [id: string]: Player }\n};\nconst initialState = {\n  online: [],\n  data: Session.get('players'),\n} as PlayersState;\n\nexport const players = createSlice({\n  name: \"players\",\n  initialState,\n  reducers: {\n    playerJoined: shared((state: PlayersState, action: PayloadAction<string>) => {\n      state.online.push(action.payload);\n      state.data[action.payload] = state.data[action.payload] || {\n        name: null\n      };\n    }),\n    removePlayer: shared((state: PlayersState, action: PayloadAction<string>) => {\n      state.online = state.online.filter(p => p !== action.payload)\n    }),\n    changeName: shared((state: PlayersState, action: PayloadAction<{ player: string, name: string }>) => {\n      state.data[action.payload.player].name = action.payload.name;\n    })\n  },\n})\n\nexport default players.reducer;\nexport const {playerJoined, removePlayer, changeName} = players.actions;\n\nexport type Player = {\n  name: string | null,\n}\n","import Peer, { DataConnection } from \"peerjs\";\nimport { connect_peer, create_peer, PeerID } from \"./peer\";\nimport { ServerClient } from \"./server\";\n\nexport type ClientConfig = {\n  onDisconnect(): void\n  onMessage(msg: any): void\n  onInitialMessage(msg: any): void\n  onConnect(): void\n}\n\nexport async function game_client(game: string, client_id: string, handlers: ClientConfig): Promise<ServerClient> {\n  // NOTE: the client_id is not used to construct the peer_id. clients do not need stable Peer identifiers\n  //       instead, clients are identified using the meta field on the Peer\n  let peer = await create_peer();\n  let data_conn: DataConnection;\n  async function connect_data() {\n    data_conn = await connect_peer(peer, game as PeerID, { client_id });\n    setTimeout(() => handlers.onConnect(), 0)\n    return new Promise((resolve, reject) => {\n      data_conn.on('error', () => {\n        keep_trying(connect_data, 1000);\n      })\n      data_conn.on('close', () => {\n        keep_trying(connect_data, 1000);\n      })\n\n      const on_first_message = (d: any) => {\n        data_conn.off('data', on_first_message);\n        data_conn.on('data', handlers.onMessage);\n        handlers.onInitialMessage(d)\n        resolve(d);\n      }\n      data_conn.on('data', on_first_message)\n\n\n      data_conn.on('error', () => handlers.onDisconnect())\n      data_conn.on('close', () => handlers.onDisconnect())\n    })\n  }\n\n  await connect_data();\n  return {\n    id: client_id,\n    send(msg: any): void {\n      data_conn.send(msg);\n    }\n  }\n}\n\n// Waits timeout between calling f again. stops when f returns true\nfunction keep_trying(f: () => Promise<any>, timeout: number) {\n  setTimeout(async () => {\n    try {\n      await f();\n    } catch {\n      keep_trying(f, timeout);\n    }\n  }, timeout);\n}","import {createSlice, createAsyncThunk, PayloadAction} from \"@reduxjs/toolkit\"\nimport { game_server, ServerClient } from \"./server\";\nimport { issueToast } from \"../toast\";\nimport { syncAction } from \"../sync\";\nimport { forkGame, loadGame } from \"../game\";\nimport { RootStore } from \"../../store\";\nimport { Session } from \"../../storage/session\";\nimport { playerJoined, Player, removePlayer } from \"../players\";\nimport { game_client } from \"./client2\";\n\nexport let state = {\n  conn: null as null | ServerClient\n}\n\nexport type ConnId = string & {\n  _connId: 'connid' \n} \n\nexport const connect = createAsyncThunk('comms/connect', async (gameId: string, { getState, dispatch }) => {\n  const clientId = (getState() as RootStore).comms.clientId;\n  try {\n    state.conn = await game_client(gameId, clientId, {\n      onMessage(m: any) {\n        dispatch(m);\n      },\n      onDisconnect() {\n        dispatch(comms.actions.disconnected())\n      },\n      onInitialMessage(m: any) {\n        dispatch(m)\n      },\n      onConnect() {\n        dispatch(comms.actions.connected())\n      }\n    });\n    console.log(\"connected to server!\")\n  }\n  catch(e) {\n    dispatch(issueToast(\"joinFailure\"));\n    console.log(e);\n    throw e;\n  }\n});\n\nexport const host = createAsyncThunk('comms/host', async (_: undefined, { getState, dispatch }) => {\n  const clientId = (getState() as RootStore).comms.clientId;\n  const server = await game_server(clientId, {\n    onConnect(player) {\n      server.sendTo(player, syncAction(getState() as any))\n      dispatch(playerJoined(player))\n    },\n    onMessage(m) {\n      dispatch(m);\n    },\n    onDisconnect(label) {\n      dispatch(removePlayer(label))\n    },\n    onStartup() {\n      dispatch(playerJoined(clientId))\n    }\n  });\n  \n  state.conn = server;\n  Session.set('was_hosting', server.id);\n  dispatch(forkGame(server.id));\n  window.history.pushState(null, \"\", `?game=${server.id}`)\n  return server.id;\n});\n\nexport let comms = createSlice({\n  name: 'comms',\n  initialState: {\n    // NOTE: offline denotes a totally offline game, not a disconnected state\n    status: 'offline' as 'offline' | 'pending' | 'connected',\n    hosting: false,\n    clientId: Session.get('comms_id'),\n    gameId: null as string | null,\n  },\n  reducers: {\n    disconnected(state, action: {}) {\n      state.status = \"pending\";\n    },\n    connected(state, action: {}) {\n      state.status = \"connected\";\n    }\n  },\n  extraReducers: builder => {\n    // Client connection logic\n    builder.addCase(connect.pending, (state, _) => {\n      state.status = 'pending';\n    })\n    builder.addCase(connect.fulfilled, (state, payload: any) => {\n      state.gameId = payload.gameId;\n      state.status = 'connected'; \n    })\n    builder.addCase(connect.rejected, (state, _) => {\n      state.status = 'offline';\n    })\n\n    // Hosting events\n    builder.addCase(host.pending, (state, _) => {\n      state.status = 'pending';\n    })\n    builder.addCase(host.fulfilled, (state, {payload}) => {\n      state.status = 'connected';\n      state.gameId = payload;\n      state.hosting = true;\n    })\n    builder.addCase(host.rejected, (state, _) => {\n      state.status = 'offline';\n    })\n  }\n})\n\nexport function shared<S, A>(f: (state: S, action: PayloadAction<A>) => void): { reducer: (state: any, action: PayloadAction<A>)=> void,  prepare: (action: A) => any }{\n  return {\n    reducer: f as any,\n    prepare: a => ({\n      payload: a,\n      meta: state.conn ? {\n        shared: true,\n        src: state.conn.id\n      } : {},\n    })\n  }\n}\n\nexport default comms.reducer;","import { RootStore } from \"../store\";\n\nexport function syncAction(state: RootStore) {\n  return {\n    type: \"STATE_SYNC\",\n    payload: {\n      game: state.game,\n      players: state.players\n    },\n  };\n}\n\nexport function applySync(\n  state: RootStore,\n  action: ReturnType<typeof syncAction>\n): RootStore {\n  return {\n    ...state,\n    game: action.payload.game,\n    players: action.payload.players\n  };\n}\n","import { createSlice } from \"@reduxjs/toolkit\";\nimport { shared } from \"../comms\";\nimport { Coord, GridSpace, Offset } from \"./units\";\n\nexport type Image = {\n  id: string,\n  loc: Coord<GridSpace>,\n  dim: Offset<GridSpace>,\n  href: string\n}\nexport type GameState = typeof initialState;\nlet initialState = {\n  id: \"local\",\n  maps: [{\n    width: 15,\n    height: 10,\n    images: {} as { [id: string]: Image},\n  }]\n}\nexport let game = createSlice({\n  name: 'game',\n  initialState: initialState as typeof initialState,\n  reducers: {\n    forkGame(state, action: { payload: string }) {\n      state.id = action.payload;\n    },\n    loadGame(state, { payload }: { payload: GameState }) {\n      return payload;\n    },\n    setDimensions: shared((state: any, { payload }: { payload: { map: number, width: number, height: number } }) => {\n      const { map, width, height } = payload;\n        state.maps[map].width = width;\n        state.maps[map].height = height;\n    }),\n    addImage: shared((state: any, action: { payload: { map: number, img: Image } }) => {\n      const {map, img} = action.payload;\n      state.maps[map].images[img.id] = img;\n    }),\n    updateImage: shared((state: GameState, action: { payload: { map: number, id: string, img: Partial<Image> } }) => {\n      const {map, id, img} = action.payload;\n      state.maps[map].images[id] = {...state.maps[map].images[id], ...img}\n    }),\n    reset: shared((state: any, action: {payload: any}) => state = initialState)\n  }\n})\n\nexport default game.reducer;\nexport let { setDimensions, addImage, updateImage, reset, loadGame, forkGame } = game.actions;\n","import { PropsWithChildren, useRef, useState, memo } from \"react\";\nimport { Coord, add, floor, sub, GridSpace } from \"../../modules/game/units\";\nimport React from \"react\";\nimport Overlay from \"./Overlay\";\nimport \"./grid.css\";\nimport { Viewport, ViewportRef } from \"./Viewport\";\nimport useDrop from \"../util/useDrop\";\nimport { GridItem } from \"./GridItem\";\nimport SelectionBox from \"./SelectionBox\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport { RootStore } from \"../../store\";\nimport { addImage, Image, updateImage } from \"../../modules/game\";\n\nexport interface GridProps {\n  dimensions: [number, number];\n}\n\nasync function getDataURL(file: File): Promise<string> {\n  const reader = new FileReader();\n  return new Promise((resolve, reject) => {\n    reader.onload = () => resolve(reader.result as string);\n    reader.readAsDataURL(file);\n  })\n}\n\nfunction extractURLFromHTML(html: string): string | null {\n  const parser = new DOMParser();\n  const doc = parser.parseFromString(html, 'text/html');\n  return doc.querySelector(\"img\")?.src || null;\n}\nexport function Grid(props: PropsWithChildren<GridProps>) {\n  let dropLayer = useRef<HTMLDivElement>(null);\n  let selection = useRef<any>(null);\n  let [selectionOffset, setSelectionOffset] = useState<any>(null);\n  let viewport = useRef<ViewportRef>(null);\n  let hoverHint = useRef<HTMLDivElement>(null);\n  let items = useSelector((state: RootStore) => state.game.maps[0].images);\n  let dispatch = useDispatch();\n\n  let [dragging, drag, dragHandlers] = useDrop(\n    dropLayer,\n    (x, y) => {\n      if (hoverHint.current) {\n        let coords = viewport.current!.clientToGrid([x, y]);\n        hoverHint.current.style.left = Math.floor(coords[0] as number) + \"em\";\n        hoverHint.current.style.top = Math.floor(coords[1] as number) + \"em\";\n      }\n    },\n    async (ev) => {\n      let coords = viewport.current!.clientToGrid([ev.clientX, ev.clientY]);\n      let dataItems = ev.dataTransfer?.items ?? [];\n      let addItem = (s: string) => {\n        console.log(s);\n        let item = {\n          id: \"\" + Math.random(),\n          loc: [Math.floor(coords[0]), Math.floor(coords[1])],\n          dim: [1,1],\n          href: s,\n        };\n        dispatch(addImage({ map: 0, img: item as unknown as Image }));\n      };\n      console.log(\"DataItems\", dataItems.length)\n      for (let i = 0; i < dataItems.length; i++) {\n        console.log(dataItems[i].type)\n        if (dataItems[i].type.startsWith(\"image/\")) {\n          const dataURL = await getDataURL(dataItems[i].getAsFile()!);\n          addItem(dataURL);\n          return;\n        } if (dataItems[i].type === \"text/html\") {\n          dataItems[i].getAsString(s => addItem(extractURLFromHTML(s)!));\n          return;\n        }\n        if (dataItems[i].type === \"application/x-moz-file-promise-url\") {\n          dataItems[i].getAsString(addItem)\n          return;\n        } else if (dataItems[i].kind === \"string\") {\n          let t = dataItems[i].type;\n          dataItems[i].getAsString(s => console.log(t, s));\n        }\n      }\n    }\n  );\n  let gridDrag: Coord<GridSpace>;\n  if (dragging) {\n    gridDrag = viewport.current!.clientToGrid([drag.x, drag.y]);\n  }\n\n  return (\n    <div className=\"grid\" {...dragHandlers} ref={dropLayer}>\n      <Viewport\n        ref={viewport}\n        baseScalar={1}\n        baseUnit=\"in\"\n        width={props.dimensions[0]}\n        height={props.dimensions[1]}\n      >\n        {dragging ? (\n          <div\n            ref={hoverHint}\n            key=\"hover\"\n            style={{\n              position: \"absolute\",\n              left: Math.floor(gridDrag![0]) + \"em\",\n              top: Math.floor(gridDrag![1]) + \"em\",\n              width: \"1em\",\n              height: \"1em\",\n              background: \"#aaa\",\n            }}\n          ></div>\n        ) : null}\n        {Object.values(items).map((i) => (\n          <GridItem\n            key={i.id}\n            loc={\n              add(\n                i.loc,\n                selection.current?.id === i.id\n                  ? (selectionOffset as any)\n                  : [0, 0]\n              ) as any\n            }\n            dim={i.dim}\n            onPointerDown={(ev) => {\n              ev.preventDefault();\n              selection.current = i;\n              setSelectionOffset([0, 0]);\n            }}\n          >\n            <img\n              onDragStart={(ev) => ev.preventDefault()}\n              alt=\"\"\n              src={i.href}\n              style={{ display: \"block\", width: \"100%\", height: \"100%\" }}\n            />\n          </GridItem>\n        ))}\n        <Overlay width={props.dimensions[0]} height={props.dimensions[1]} />\n        {selection.current && (\n          <SelectionBox\n            key=\"\"\n            loc={\n              add(selectionOffset!, selection.current.loc) as any\n            }\n            dim={selection.current.dim}\n            onSelectionDrag={(coord) =>\n              setSelectionOffset(\n                floor(\n                  sub(viewport.current!.clientToGrid(coord), selection.current.loc)\n                )\n              )\n            }\n            onSelectionDrop={(coord) => {\n              const loc = floor(viewport.current!.clientToGrid(coord));\n              dispatch(updateImage({\n                map: 0,\n                id: selection.current.id,\n                img: {\n                  loc\n                }\n              }));\n              setSelectionOffset(null);\n              selection.current = null;\n            }}\n          />\n        )}\n      </Viewport>\n    </div>\n  );\n}\n\nexport default memo(Grid);\n","import { useState } from \"react\";\nexport interface DragState {\n  x: number,\n  y: number,\n}\n\nexport default function useDrop(\n  ref: React.RefObject<Element | null>,\n  onDrag: (x: number, y: number) => void,\n  onDrop: (ev: DragEvent) => void\n): [boolean, DragState, any] {\n  let [dragDepth, setDragDepth] = useState(0);\n  let [dragState, setDragState] = useState({\n    x: 0,\n    y: 0,\n  });\n  \n  const dropStub = (ev: DragEvent) => {\n    ev.preventDefault();\n    \n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth(0);\n    setDragState({\n      x,\n      y,\n    });\n    onDrop(ev);\n  };\n  const onDragEnter = (ev: DragEvent) => {\n    ev.preventDefault();\n    ev.stopPropagation();\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth(d => d + 1);\n    setDragState({\n      x,\n      y,\n    });\n  };\n  const onDragLeave = (ev: DragEvent) => {\n    ev.preventDefault();\n    ev.stopPropagation();\n    let [x, y] = [ev.clientX, ev.clientY];\n    setDragDepth(d => d - 1);\n    setDragState({\n      x,\n      y,\n    });\n    };\n  const onDragOver = (ev: DragEvent) => {\n    ev.preventDefault();\n    onDrag(ev.clientX, ev.clientY)\n  };\n    return [dragDepth > 0, dragState, {\n        onDragEnter,\n        onDragLeave,\n        onDragOver,\n        onDrop: dropStub,\n    }]\n}\n","import { PropsWithChildren } from \"react\";\nimport React from \"react\";\nimport \"./Toolbar.css\";\n\ninterface ToolbarProps {}\nfunction Toolbar(props: PropsWithChildren<ToolbarProps>) {\n    return (\n        <div className=\"toolbar\">\n            {props.children}\n        </div>);\n}\nexport default Toolbar","import { useSelector } from \"react-redux\"\nimport { RootStore } from \"../../store\";\nimport React from \"react\";\nimport \"./Toast.css\";\nimport { useTranslation } from \"react-i18next\";\nimport { motion, AnimateSharedLayout } from \"framer-motion\";\n\nexport function ToastArea(props: {}) {\n  const toasts = useSelector((state: RootStore) => state.toast.toasts);\n  const { t } = useTranslation();\n  return (<div className=\"toastArea\">\n    <AnimateSharedLayout>\n    {\n      toasts.map(toast =>\n        <motion.div className=\"toast\"\n          initial={{position: \"relative\", opacity: 0}} \n          animate={{position: \"relative\", opacity: 1}} \n          exit={{ position: \"relative\", opacity: 0 }} \n          layout\n          key={toast.id}\n        >\n          {t(toast.msg)}\n        </motion.div>\n      )\n      }\n    </AnimateSharedLayout>\n    </div>\n  )\n}","import React from \"react\";\nimport \"./Loading.css\";\n\nexport function Loading() {\n  return (\n    <div className=\"spinner\">\n      <div className=\"double-bounce1\"></div>\n      <div className=\"double-bounce2\"></div>\n    </div>\n  )\n}","import { Dispatch } from \"@reduxjs/toolkit\";\nimport React, { FormEvent, useCallback, useEffect } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { changeName } from \"../modules/players\";\nimport { RootStore } from \"../store\";\nimport \"./JoinOverlay.css\"\n\n\nexport function JoinOverlay() {\n  const shouldRender = useSelector((s: RootStore) =>\n    s.comms.status === \"connected\" && s.players.data[s.comms.clientId]?.name === null\n  );\n\n  const clientId = useSelector((s: RootStore) => s.comms.clientId);\n  const dispatch = useDispatch();\n\n  const joinAsPlayer = useCallback((ev: FormEvent) => {\n    ev.preventDefault();\n    const data = new FormData(ev.nativeEvent.target as HTMLFormElement);\n    const name = data.get(\"name\") as string;\n    const player = { name, id: clientId };\n    dispatch(changeName({ player: clientId, name }));\n  }, [clientId, dispatch]);\n\n  if (!shouldRender) {\n    return null;\n  }\n\n  return (<div id=\"join\">\n    <form style={{\n      display: \"flex\",\n      flexDirection: \"column\",\n      maxWidth: \"480px\",\n      background: \"red\"\n    }} onSubmit={joinAsPlayer}>\n      <label htmlFor=\"name\">Display Name: \n      <input name=\"name\" type=\"text\" defaultValue={\"\"}></input></label>\n      <button type=\"submit\">Join</button>\n    </form>\n  </div>)\n}","import React, { useState } from \"react\";\nimport \"./App.css\";\nimport Grid from \"./grid2/Grid\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport Toolbar from \"./toolbar/Toolbar\";\nimport { Offset, GridSpace } from \"../modules/game/units\";\nimport { RootStore } from \"../store\";\nimport { host } from \"../modules/comms\";\nimport { setDimensions, reset } from \"../modules/game\";\nimport { ToastArea } from \"./toasts/ToastArea\";\nimport { issueToast } from \"../modules/toast\";\nimport { useTranslation } from \"react-i18next\";\nimport { Loading } from \"./toolkit/Loading\";\nimport { JoinOverlay } from \"./JoinOverlay\";\n\ninterface Rect {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\nfunction App() {\n  let comms = useSelector((state: RootStore) => {\n    console.log(state);\n    return state.comms\n  });\n  let [curr_map, set_curr_map] = useState(() => 0);\n  let dim = useSelector((state: RootStore) => [state.game.maps[curr_map].width, state.game.maps[curr_map].height])\n  let dispatch = useDispatch();\n  const { t } = useTranslation();\n\n  let players = useSelector((state: RootStore) => state.players.online.map(p => state.players.data[p].name));\n  return (\n    <div className=\"App\">\n      <JoinOverlay />\n      <ToastArea />\n      <Grid dimensions={dim as Offset<GridSpace>} />\n      <Toolbar>\n        <button onClick={() => dispatch(setDimensions({map: curr_map, width: dim[0] + 1, height: dim[1]}))}>Add Column</button>\n        <button onClick={() => dispatch(setDimensions({map: curr_map, width: dim[0], height: dim[1] + 1}))}>Add Row</button>\n        <button onClick={() => dispatch(reset({}))}>Reset</button>\n        <button onClick={() => dispatch(issueToast(t(\"hello\")))}>Say hi</button>\n        {comms.status === 'offline' && (\n          <button onClick={() => dispatch(host())}>Host</button>\n        )}\n        {comms.status === 'pending' && (\n          <Loading />\n        )}\n\n        {comms.hosting && `hosting: ${comms.gameId}`}\n        {players.map(p => <p>{p || \"unknown\"}</p>)}\n      </Toolbar>\n    </div>\n  );\n}\n\nexport default App;\n","import { configureStore, combineReducers, Store, AnyAction, AsyncThunkAction } from '@reduxjs/toolkit'\nimport comms, {state} from './modules/comms'\nimport game from './modules/game'\nimport toast from './modules/toast'\nimport players from './modules/players'\nimport { applySync } from './modules/sync';\nimport { persistState } from './modules/game/persist';\nimport { Session } from './storage/session'\n\nconst mainReducer = combineReducers({ comms, game, toast, players });\nexport type RootStore = ReturnType<typeof mainReducer>;\n\nconst initialState: RootStore = mainReducer(undefined, { type: 'null' });\n\n// This \"any\" means dispatch whatever you want. Works well enough\nconst store: Store<RootStore, any> = configureStore({\n  reducer(state, action): ReturnType<typeof mainReducer> {\n    if (action.type === 'STATE_SYNC') {\n      return applySync(state!, action as any);\n    }\n    return mainReducer(state, action);\n  },\n  middleware: m => m().prepend(api => next => action => {\n    // Send out all actions that originated on this peer\n    // if we didn't check that it came from this peer, we'd\n    // bounce messages back and forth forever\n    console.log(\"connection?\", state.conn);\n    state.conn && action.meta?.shared && action.meta?.src === state.conn.id && state.conn.send(action);\n    return next(action);\n  }),\n  preloadedState: initialState,\n})\n\nstore.subscribe(() => {\n  const state = store.getState() as RootStore;\n  console.log(state);\n  persistState(state.game.id, state.game);\n  Session.set('players', state.players.data);\n});\nexport default store;","import { GameState } from \".\";\n\n\nexport function gameState(id: string) {\n  const item = sessionStorage.getItem(id);\n  return item ? JSON.parse(item) : null;\n}\n\nexport function persistState(id: string, state: GameState) {\n  sessionStorage.setItem(id, JSON.stringify(state))\n}","import i18n from 'i18next';\nimport { initReactI18next } from 'react-i18next';\n \nimport Backend from 'i18next-xhr-backend';\n \ni18n\n  .use(Backend)\n  .use(initReactI18next)\n  // for all options read: https://www.i18next.com/overview/configuration-options\n  .init({\n    debug: true,\n \n    lng: 'en',\n    fallbackLng: 'en',\n    whitelist: ['en', 'de'],\n \n    interpolation: {\n      escapeValue: false, // not needed for react as it escapes by default\n    },\n    backend: {\n      loadPath: '/battlegrid/locales/{{lng}}/{{ns}}.json',\n    },\n  });\n \nexport default i18n;","import React, {Suspense} from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './components/App';\nimport { Provider } from 'react-redux';\nimport { loadGame } from './modules/game';\nimport store from './store'\nimport { connect, host } from './modules/comms';\nimport './i18n';\nimport { gameState } from './modules/game/persist';\nimport { PeerID } from './modules/comms/peer';\nimport { Session } from './storage/session';\n//import * as serviceWorker from './serviceWorker';\n\nconst urlParams = new URLSearchParams(window.location.search);\n\n// Load the game if we have it stored\nconst game = urlParams.get(\"game\");\nlet state = gameState(game ?? \"local\");\n\n// If we found saved data\nif (game) {\n  console.log(\"Found game: \", game);\n  if (Session.get('was_hosting') === game) {\n    console.log(\"REHOSTING!\");\n    if (state) {\n      store.dispatch(loadGame(state))\n    }\n    Session.get('players')\n    store.dispatch(host());\n  } else {\n    console.log(\"Huh\")\n    store.dispatch(connect(game as PeerID));\n  }\n} else if (state) {\n      store.dispatch(loadGame(state))\n}\n\nReactDOM.render(\n  <React.StrictMode>\n    <Suspense fallback={null}>\n      <Provider store={store}>\n        <App />\n      </Provider>\n    </Suspense>\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\n//serviceWorker.unregister();\n"],"sourceRoot":""}